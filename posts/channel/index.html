<!doctype html><html lang=en>
<head>
<title>
goä¹‹channel
</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="channel channelçš„ä½œç”¨   goroutineä¹‹é—´å®‰å…¨é€šä¿¡
hchan mutex
  goroutineä¹‹é—´æ•°æ®ä¼ é€’
  FIFOè¯­ä¹‰
copying into and out of hchan buffer
 å…ˆä» Channel è¯»å–æ•°æ®çš„ Goroutine ä¼šå…ˆæ¥æ”¶åˆ°æ•°æ®ï¼› å…ˆå‘ Channel å‘é€æ•°æ®çš„ Goroutine ä¼šå¾—åˆ°å…ˆå‘é€æ•°æ®çš„æƒåˆ©ï¼›    å¯ä»¥ä½¿å¾—goroutineé˜»å¡å’Œå”¤é†’
hchan sudog queues
calls into the runtime scheduler(gopark, goready)
  è®¾è®¡åŸç† â€‹ å¤šçº¿ç¨‹ä½¿ç”¨å…±äº«å†…å­˜ä¼ é€’æ•°æ®
â€‹ Goroutine ä½¿ç”¨ Channel ä¼ é€’æ•°æ®
å…ˆå…¥å…ˆå‡º ç›®å‰çš„ Channel æ”¶å‘æ“ä½œå‡éµå¾ªäº†å…ˆå…¥å…ˆå‡ºï¼ˆFIFOï¼‰çš„è®¾è®¡ï¼Œå…·ä½“è§„åˆ™å¦‚ä¸‹ï¼š
 å…ˆä» Channel è¯»å–æ•°æ®çš„ Goroutine ä¼šå…ˆæ¥æ”¶åˆ°æ•°æ®ï¼› å…ˆå‘ Channel å‘é€æ•°æ®çš„ Goroutine ä¼šå¾—åˆ°å…ˆå‘é€æ•°æ®çš„æƒåˆ©ï¼›  æ•°æ®ç»“æ„ Channel åœ¨è¿è¡Œæ—¶çš„å†…éƒ¨è¡¨ç¤ºæ˜¯ runtime.">
<meta name=keywords content>
<meta name=robots content="noodp">
<link rel=canonical href=/posts/channel/>
<link rel=stylesheet href=/assets/style.css>
<link rel=stylesheet href=/style.css>
<link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png>
<link rel="shortcut icon" href=/favicon.png>
<link href=/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="goä¹‹channel">
<meta name=twitter:description content="channel channelçš„ä½œç”¨   goroutineä¹‹é—´å®‰å…¨é€šä¿¡
hchan mutex
  goroutineä¹‹é—´æ•°æ®ä¼ é€’
  FIFOè¯­ä¹‰
copying into and out of hchan buffer
 å…ˆä» Channel è¯»å–æ•°æ®çš„ Goroutine ä¼šå…ˆæ¥æ”¶åˆ°æ•°æ®ï¼› å…ˆå‘ Channel å‘é€æ•°æ®çš„ Goroutine ä¼šå¾—åˆ°å…ˆå‘é€æ•°æ®çš„æƒåˆ©ï¼›    å¯ä»¥ä½¿å¾—goroutineé˜»å¡å’Œå”¤é†’
hchan sudog queues
calls into the runtime scheduler(gopark, goready)
  è®¾è®¡åŸç† â€‹ å¤šçº¿ç¨‹ä½¿ç”¨å…±äº«å†…å­˜ä¼ é€’æ•°æ®
â€‹ Goroutine ä½¿ç”¨ Channel ä¼ é€’æ•°æ®
å…ˆå…¥å…ˆå‡º ç›®å‰çš„ Channel æ”¶å‘æ“ä½œå‡éµå¾ªäº†å…ˆå…¥å…ˆå‡ºï¼ˆFIFOï¼‰çš„è®¾è®¡ï¼Œå…·ä½“è§„åˆ™å¦‚ä¸‹ï¼š
 å…ˆä» Channel è¯»å–æ•°æ®çš„ Goroutine ä¼šå…ˆæ¥æ”¶åˆ°æ•°æ®ï¼› å…ˆå‘ Channel å‘é€æ•°æ®çš„ Goroutine ä¼šå¾—åˆ°å…ˆå‘é€æ•°æ®çš„æƒåˆ©ï¼›  æ•°æ®ç»“æ„ Channel åœ¨è¿è¡Œæ—¶çš„å†…éƒ¨è¡¨ç¤ºæ˜¯ runtime.">
<meta property="og:title" content="goä¹‹channel">
<meta property="og:description" content="channel channelçš„ä½œç”¨   goroutineä¹‹é—´å®‰å…¨é€šä¿¡
hchan mutex
  goroutineä¹‹é—´æ•°æ®ä¼ é€’
  FIFOè¯­ä¹‰
copying into and out of hchan buffer
 å…ˆä» Channel è¯»å–æ•°æ®çš„ Goroutine ä¼šå…ˆæ¥æ”¶åˆ°æ•°æ®ï¼› å…ˆå‘ Channel å‘é€æ•°æ®çš„ Goroutine ä¼šå¾—åˆ°å…ˆå‘é€æ•°æ®çš„æƒåˆ©ï¼›    å¯ä»¥ä½¿å¾—goroutineé˜»å¡å’Œå”¤é†’
hchan sudog queues
calls into the runtime scheduler(gopark, goready)
  è®¾è®¡åŸç† â€‹ å¤šçº¿ç¨‹ä½¿ç”¨å…±äº«å†…å­˜ä¼ é€’æ•°æ®
â€‹ Goroutine ä½¿ç”¨ Channel ä¼ é€’æ•°æ®
å…ˆå…¥å…ˆå‡º ç›®å‰çš„ Channel æ”¶å‘æ“ä½œå‡éµå¾ªäº†å…ˆå…¥å…ˆå‡ºï¼ˆFIFOï¼‰çš„è®¾è®¡ï¼Œå…·ä½“è§„åˆ™å¦‚ä¸‹ï¼š
 å…ˆä» Channel è¯»å–æ•°æ®çš„ Goroutine ä¼šå…ˆæ¥æ”¶åˆ°æ•°æ®ï¼› å…ˆå‘ Channel å‘é€æ•°æ®çš„ Goroutine ä¼šå¾—åˆ°å…ˆå‘é€æ•°æ®çš„æƒåˆ©ï¼›  æ•°æ®ç»“æ„ Channel åœ¨è¿è¡Œæ—¶çš„å†…éƒ¨è¡¨ç¤ºæ˜¯ runtime.">
<meta property="og:type" content="article">
<meta property="og:url" content="/posts/channel/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-11-30T09:38:03+08:00">
<meta property="article:modified_time" content="2021-11-30T09:38:03+08:00"><meta property="og:site_name" content="K:)eep">
</head>
<body>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=/ class=logo style=text-decoration:none>
<span class=logo__text>K:)eep</span>
</a>
<span class=header__right>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=https://github.com/gongqij>Github</a></li>
<li><a href=/>Home</a></li>
<li><a href=/posts/readlist>ReadList</a></li>
<li><a href=/posts/wechat>WeChat</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=https://github.com/gongqij>Github</a></li>
<li><a href=/>Home</a></li>
<li><a href=/posts/readlist>ReadList</a></li>
<li><a href=/posts/wechat>WeChat</a></li>
</ul>
</nav>
<span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span>
<span class=theme-toggle><svg style="width:24px;height:24px" viewBox="0 0 24 24"><path fill="currentcolor" d="M12 6a6 6 0 016 6c0 2.22-1.21 4.16-3 5.2V19a1 1 0 01-1 1H10A1 1 0 019 19V17.2C7.21 16.16 6 14.22 6 12a6 6 0 016-6m2 15v1a1 1 0 01-1 1H11a1 1 0 01-1-1V21h4m6-10h3v2H20V11M1 11H4v2H1V11M13 1V4H11V1h2M4.92 3.5 7.05 5.64 5.63 7.05 3.5 4.93 4.92 3.5M16.95 5.63 19.07 3.5 20.5 4.93 18.37 7.05 16.95 5.63z"/></svg>
</span>
</span>
</span>
</header>
<div class=content>
<div class=post>
<h1 class=post-title style=text-align:center>goä¹‹channel</h1>
<div class=post-meta style=text-align:center;color:#999>
<span class=post-date>
2021-11-30
</span>
<span class=post-read-time>Â· 17 min read</span>
</div>
<div class=post-content>
<h1 id=channel>channel</h1>
<h2 id=channelçš„ä½œç”¨><a href=#channelçš„ä½œç”¨ class=h-anchor>ğŸ”—</a>channelçš„ä½œç”¨</h2>
<ol>
<li>
<p>goroutineä¹‹é—´å®‰å…¨é€šä¿¡</p>
<p>hchan mutex</p>
</li>
<li>
<p>goroutineä¹‹é—´æ•°æ®ä¼ é€’</p>
</li>
<li>
<p>FIFOè¯­ä¹‰</p>
<p>copying into and out of hchan buffer</p>
<ul>
<li>å…ˆä» Channel è¯»å–æ•°æ®çš„ Goroutine ä¼šå…ˆæ¥æ”¶åˆ°æ•°æ®ï¼›</li>
<li>å…ˆå‘ Channel å‘é€æ•°æ®çš„ Goroutine ä¼šå¾—åˆ°å…ˆå‘é€æ•°æ®çš„æƒåˆ©ï¼›</li>
</ul>
</li>
<li>
<p>å¯ä»¥ä½¿å¾—goroutineé˜»å¡å’Œå”¤é†’</p>
<p>hchan sudog queues</p>
<p>calls into the runtime scheduler(gopark, goready)</p>
</li>
</ol>
<h2 id=è®¾è®¡åŸç†><a href=#è®¾è®¡åŸç† class=h-anchor>ğŸ”—</a>è®¾è®¡åŸç†</h2>
<p><img src=/head.png alt=shared-memory></p>
<p>â€‹ <strong>å¤šçº¿ç¨‹ä½¿ç”¨å…±äº«å†…å­˜ä¼ é€’æ•°æ®</strong></p>
<p><img src=https://img.draveness.me/2020-01-28-15802171487080-channel-and-goroutines.png alt=channel-and-goroutines></p>
<p>â€‹ <strong>Goroutine ä½¿ç”¨ Channel ä¼ é€’æ•°æ®</strong></p>
<h3 id=å…ˆå…¥å…ˆå‡º><a href=#å…ˆå…¥å…ˆå‡º class=h-anchor>ğŸ”—</a>å…ˆå…¥å…ˆå‡º</h3>
<p>ç›®å‰çš„ Channel æ”¶å‘æ“ä½œå‡éµå¾ªäº†å…ˆå…¥å…ˆå‡ºï¼ˆFIFOï¼‰çš„è®¾è®¡ï¼Œå…·ä½“è§„åˆ™å¦‚ä¸‹ï¼š</p>
<ul>
<li>å…ˆä» Channel è¯»å–æ•°æ®çš„ Goroutine ä¼šå…ˆæ¥æ”¶åˆ°æ•°æ®ï¼›</li>
<li>å…ˆå‘ Channel å‘é€æ•°æ®çš„ Goroutine ä¼šå¾—åˆ°å…ˆå‘é€æ•°æ®çš„æƒåˆ©ï¼›</li>
</ul>
<h2 id=æ•°æ®ç»“æ„><a href=#æ•°æ®ç»“æ„ class=h-anchor>ğŸ”—</a>æ•°æ®ç»“æ„</h2>
<p>Channel åœ¨è¿è¡Œæ—¶çš„å†…éƒ¨è¡¨ç¤ºæ˜¯ <a href=https://github.com/golang/go/blob/e35876ec6591768edace6c6f3b12646899fd1b11/src/runtime/chan.go#L32><code>runtime.hchan</code></a>ï¼Œè¯¥ç»“æ„ä½“ä¸­åŒ…å«äº†ä¸€ä¸ªç”¨äºä¿æŠ¤æˆå‘˜å˜é‡çš„<strong>äº’æ–¥é”</strong>ï¼Œä»æŸç§ç¨‹åº¦ä¸Šè¯´ï¼ŒChannel æ˜¯ä¸€ä¸ª<strong>ç”¨äºåŒæ­¥å’Œé€šä¿¡çš„æœ‰é”é˜Ÿåˆ—</strong></p>
<p>Go è¯­è¨€çš„ Channel åœ¨è¿è¡Œæ—¶ä½¿ç”¨ <a href=https://github.com/golang/go/blob/e35876ec6591768edace6c6f3b12646899fd1b11/src/runtime/chan.go#L32><code>runtime.hchan</code></a> ç»“æ„ä½“è¡¨ç¤ºã€‚æˆ‘ä»¬åœ¨ Go è¯­è¨€ä¸­åˆ›å»ºæ–°çš„ Channel æ—¶ï¼Œå®é™…ä¸Šåˆ›å»ºçš„éƒ½æ˜¯å¦‚ä¸‹æ‰€ç¤ºçš„ç»“æ„ä½“ï¼š</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>hchan</span> <span style=color:#66d9ef>struct</span> {
    <span style=color:#75715e>// chan é‡Œå…ƒç´ æ•°é‡
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>qcount</span>   <span style=color:#66d9ef>uint</span>
    <span style=color:#75715e>// chan åº•å±‚å¾ªç¯æ•°ç»„çš„é•¿åº¦
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>dataqsiz</span> <span style=color:#66d9ef>uint</span>
    <span style=color:#75715e>// æŒ‡å‘åº•å±‚å¾ªç¯æ•°ç»„çš„æŒ‡é’ˆ
</span><span style=color:#75715e></span>    <span style=color:#75715e>// åªé’ˆå¯¹æœ‰ç¼“å†²çš„ channel
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>buf</span>      <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>
    <span style=color:#75715e>// chan ä¸­å…ƒç´ å¤§å°
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>elemsize</span> <span style=color:#66d9ef>uint16</span>
    <span style=color:#75715e>// chan æ˜¯å¦è¢«å…³é—­çš„æ ‡å¿—
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>closed</span>   <span style=color:#66d9ef>uint32</span>
    <span style=color:#75715e>// chan ä¸­å…ƒç´ ç±»å‹
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>elemtype</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>_type</span> <span style=color:#75715e>// element type
</span><span style=color:#75715e></span>    <span style=color:#75715e>// å·²å‘é€å…ƒç´ åœ¨å¾ªç¯æ•°ç»„ä¸­çš„ç´¢å¼•
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>sendx</span>    <span style=color:#66d9ef>uint</span>   <span style=color:#75715e>// send index
</span><span style=color:#75715e></span>    <span style=color:#75715e>// å·²æ¥æ”¶å…ƒç´ åœ¨å¾ªç¯æ•°ç»„ä¸­çš„ç´¢å¼•
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>recvx</span>    <span style=color:#66d9ef>uint</span>   <span style=color:#75715e>// receive index
</span><span style=color:#75715e></span>    <span style=color:#75715e>// ç­‰å¾…æ¥æ”¶çš„ goroutine é˜Ÿåˆ—
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>recvq</span>    <span style=color:#a6e22e>waitq</span>  <span style=color:#75715e>// list of recv waiters
</span><span style=color:#75715e></span>    <span style=color:#75715e>// ç­‰å¾…å‘é€çš„ goroutine é˜Ÿåˆ—
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>sendq</span>    <span style=color:#a6e22e>waitq</span>  <span style=color:#75715e>// list of send waiters
</span><span style=color:#75715e></span>
    <span style=color:#75715e>// ä¿æŠ¤ hchan ä¸­æ‰€æœ‰å­—æ®µ
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>lock</span> <span style=color:#a6e22e>mutex</span>
}
<span style=color:#75715e>//waitq æ˜¯ sudog çš„ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œè€Œ sudog å®é™…ä¸Šæ˜¯å¯¹ goroutine çš„ä¸€ä¸ªå°è£…ï¼š
</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>waitq</span> <span style=color:#66d9ef>struct</span> {
    <span style=color:#a6e22e>first</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>
    <span style=color:#a6e22e>last</span>  <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>
}

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>sudog</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>

	<span style=color:#a6e22e>next</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>
	<span style=color:#a6e22e>prev</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>
	<span style=color:#a6e22e>elem</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span> <span style=color:#75715e>// data element (may point to stack)
</span><span style=color:#75715e></span>  <span style=color:#960050;background-color:#1e0010>ã€‚ã€‚ã€‚</span>
}

</code></pre></div><p>ä¾‹å¦‚ï¼Œåˆ›å»ºä¸€ä¸ªå®¹é‡ä¸º 6 çš„ï¼Œå…ƒç´ ä¸º int å‹çš„ channel æ•°æ®ç»“æ„å¦‚ä¸‹ ï¼š</p>
<p><img src=https://user-images.githubusercontent.com/7698088/61179068-806ee080-a62d-11e9-818c-16af42025b1b.png alt=img></p>
<p><code>recvq</code> çš„æ•°æ®ç»“æ„å¦‚ä¸‹(åŒå‘å¾ªç¯é“¾è¡¨ï¼Œæ­¤æ—¶recvqä¸­æœ‰ä¸¤ä¸ªsudogï¼Œä¸¤ä¸ªgoroutineè¢«é˜»å¡åœ¨æ¥æ”¶æ“ä½œ)ï¼š</p>
<p><img src=https://user-images.githubusercontent.com/7698088/61179210-d3966280-a630-11e9-8c73-5a22340910a6.png alt=img></p>
<h2 id=åˆ›å»ºé€šé“><a href=#åˆ›å»ºé€šé“ class=h-anchor>ğŸ”—</a>åˆ›å»ºé€šé“</h2>
<p>æ–°å»ºä¸€ä¸ª chan åï¼Œå†…å­˜åœ¨<strong>å †</strong>ä¸Šåˆ†é…ï¼Œå¤§æ¦‚é•¿è¿™æ ·ï¼š <img src=https://user-images.githubusercontent.com/7698088/61337268-4d179600-a867-11e9-98ac-f979e3da00a6.png alt=img></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>ch</span><span style=color:#f92672>:=</span>make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>int</span>,<span style=color:#ae81ff>3</span>)
<span style=color:#75715e>//makeå…³é”®å­— --&gt; runtime.makechan 
</span><span style=color:#75715e>//åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œè¿”å›ä¸€ä¸ªæŒ‡é’ˆï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨chæœ¬èº«ä¼ å‚ï¼Œä¸éœ€è¦chçš„æŒ‡é’ˆ
</span></code></pre></div><h2 id=å‘é€æ•°æ®><a href=#å‘é€æ•°æ® class=h-anchor>ğŸ”—</a>å‘é€æ•°æ®</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// ä½äº src/runtime/chan.go
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>chansend</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>, <span style=color:#a6e22e>ep</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>, <span style=color:#a6e22e>block</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>callerpc</span> <span style=color:#66d9ef>uintptr</span>) <span style=color:#66d9ef>bool</span> {
    <span style=color:#75715e>// å¦‚æœ channel æ˜¯ nil
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#75715e>// ä¸èƒ½é˜»å¡ï¼Œç›´æ¥è¿”å› falseï¼Œè¡¨ç¤ºæœªå‘é€æˆåŠŸ
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>block</span> {
            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
        }
        <span style=color:#75715e>// å½“å‰ goroutine è¢«æŒ‚èµ·
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>gopark</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#e6db74>&#34;chan send (nil chan)&#34;</span>, <span style=color:#a6e22e>traceEvGoStop</span>, <span style=color:#ae81ff>2</span>)
        <span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;unreachable&#34;</span>)
    }

    <span style=color:#75715e>// çœç•¥ debug ç›¸å…³â€¦â€¦
</span><span style=color:#75715e></span>
    <span style=color:#75715e>// é’ˆå¯¹selectè¯­å¥ä¸”æœ‰defaultçš„æƒ…å†µ
</span><span style=color:#75715e></span>    <span style=color:#75715e>// å¯¹äºä¸é˜»å¡çš„ sendï¼Œå¿«é€Ÿæ£€æµ‹å¤±è´¥åœºæ™¯ï¼ˆä¸ç”¨è·å–é”ï¼‰ï¼Œå¥½å¿«é€Ÿè¿”å›
</span><span style=color:#75715e></span>    <span style=color:#75715e>// å¦‚æœ channel æœªå…³é—­ä¸” channel æ²¡æœ‰å¤šä½™çš„ç¼“å†²ç©ºé—´ã€‚è¿™å¯èƒ½æ˜¯ï¼š
</span><span style=color:#75715e></span>    <span style=color:#75715e>// 1. channel æ˜¯éç¼“å†²å‹çš„ï¼Œä¸”ç­‰å¾…æ¥æ”¶é˜Ÿåˆ—é‡Œæ²¡æœ‰ goroutine
</span><span style=color:#75715e></span>    <span style=color:#75715e>// 2. channel æ˜¯ç¼“å†²å‹çš„ï¼Œä½†å¾ªç¯æ•°ç»„å·²ç»è£…æ»¡äº†å…ƒç´ 
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>block</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>closed</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> ((<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dataqsiz</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvq</span>.<span style=color:#a6e22e>first</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span>) <span style=color:#f92672>||</span>
        (<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dataqsiz</span> &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>qcount</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dataqsiz</span>)) {
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
    }

    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>t0</span> <span style=color:#66d9ef>int64</span>
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>blockprofilerate</span> &gt; <span style=color:#ae81ff>0</span> {
        <span style=color:#a6e22e>t0</span> = <span style=color:#a6e22e>cputicks</span>()
    }

    <span style=color:#75715e>// é”ä½ channelï¼Œå¹¶å‘å®‰å…¨
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
        }
        <span style=color:#75715e>// å½“å‰ goroutine è¢«æŒ‚èµ·
</span><span style=color:#75715e></span>
    <span style=color:#75715e>// å¦‚æœ channel å…³é—­äº†
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>closed</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
        <span style=color:#75715e>// è§£é”
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
        <span style=color:#75715e>// ç›´æ¥ panic
</span><span style=color:#75715e></span>        panic(<span style=color:#a6e22e>plainError</span>(<span style=color:#e6db74>&#34;send on closed channel&#34;</span>))
    }

    <span style=color:#75715e>// å¦‚æœæ¥æ”¶é˜Ÿåˆ—é‡Œæœ‰ goroutineï¼Œç›´æ¥å°†è¦å‘é€çš„æ•°æ®æ‹·è´åˆ°æ¥æ”¶ goroutine
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvq</span>.<span style=color:#a6e22e>dequeue</span>(); <span style=color:#a6e22e>sg</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>sg</span>, <span style=color:#a6e22e>ep</span>, <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>) }, <span style=color:#ae81ff>3</span>)
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
    }

    <span style=color:#75715e>// å¯¹äºç¼“å†²å‹çš„ channelï¼Œå¦‚æœè¿˜æœ‰ç¼“å†²ç©ºé—´
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>qcount</span> &lt; <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dataqsiz</span> {
        <span style=color:#75715e>// qp æŒ‡å‘ buf çš„ sendx ä½ç½®
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>qp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>chanbuf</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendx</span>)

        <span style=color:#75715e>// â€¦â€¦
</span><span style=color:#75715e></span>
        <span style=color:#75715e>// å°†æ•°æ®ä» ep å¤„æ‹·è´åˆ° qp
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>typedmemmove</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>qp</span>, <span style=color:#a6e22e>ep</span>)
        <span style=color:#75715e>// å‘é€æ¸¸æ ‡å€¼åŠ  1
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendx</span><span style=color:#f92672>++</span>
        <span style=color:#75715e>// å¦‚æœå‘é€æ¸¸æ ‡å€¼ç­‰äºå®¹é‡å€¼ï¼Œæ¸¸æ ‡å€¼å½’ 0
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendx</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dataqsiz</span> {
            <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendx</span> = <span style=color:#ae81ff>0</span>
        }
        <span style=color:#75715e>// ç¼“å†²åŒºçš„å…ƒç´ æ•°é‡åŠ ä¸€
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>qcount</span><span style=color:#f92672>++</span>

        <span style=color:#75715e>// è§£é”
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
    }

    <span style=color:#75715e>// å¦‚æœä¸éœ€è¦é˜»å¡ï¼Œåˆ™ç›´æ¥è¿”å›é”™è¯¯
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>block</span> {
        <span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
    }

    <span style=color:#75715e>// channel æ»¡äº†ï¼Œå‘é€æ–¹ä¼šè¢«é˜»å¡ã€‚æ¥ä¸‹æ¥ä¼šæ„é€ ä¸€ä¸ª sudog
</span><span style=color:#75715e></span>
    <span style=color:#75715e>// è·å–å½“å‰ goroutine çš„æŒ‡é’ˆ
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
    <span style=color:#a6e22e>mysg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>acquireSudog</span>()
    <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span> = <span style=color:#ae81ff>0</span>
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>t0</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
        <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
    }

    <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>elem</span> = <span style=color:#a6e22e>ep</span>
    <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>waitlink</span> = <span style=color:#66d9ef>nil</span>
    <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>g</span> = <span style=color:#a6e22e>gp</span>
    <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>selectdone</span> = <span style=color:#66d9ef>nil</span>
    <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>c</span> = <span style=color:#a6e22e>c</span>
    <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>waiting</span> = <span style=color:#a6e22e>mysg</span>
    <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#66d9ef>nil</span>

    <span style=color:#75715e>// å½“å‰ goroutine è¿›å…¥å‘é€ç­‰å¾…é˜Ÿåˆ—
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendq</span>.<span style=color:#a6e22e>enqueue</span>(<span style=color:#a6e22e>mysg</span>)

    <span style=color:#75715e>// å½“å‰ goroutine è¢«æŒ‚èµ·
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>goparkunlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>, <span style=color:#e6db74>&#34;chan send&#34;</span>, <span style=color:#a6e22e>traceEvGoBlockSend</span>, <span style=color:#ae81ff>3</span>)

    <span style=color:#75715e>// ä»è¿™é‡Œå¼€å§‹è¢«å”¤é†’äº†ï¼ˆchannel æœ‰æœºä¼šå¯ä»¥å‘é€äº†ï¼‰
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mysg</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>waiting</span> {
        <span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;G waiting list is corrupted&#34;</span>)
    }
    <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>waiting</span> = <span style=color:#66d9ef>nil</span>
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>closed</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
            <span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;chansend: spurious wakeup&#34;</span>)
        }
        <span style=color:#75715e>// è¢«å”¤é†’åï¼Œchannel å…³é—­äº†ã€‚å‘çˆ¹å•Šï¼Œpanic
</span><span style=color:#75715e></span>        panic(<span style=color:#a6e22e>plainError</span>(<span style=color:#e6db74>&#34;send on closed channel&#34;</span>))
    }
    <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#66d9ef>nil</span>
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span> &gt; <span style=color:#ae81ff>0</span> {
        <span style=color:#a6e22e>blockevent</span>(<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span><span style=color:#f92672>-</span><span style=color:#a6e22e>t0</span>, <span style=color:#ae81ff>2</span>)
    }
    <span style=color:#75715e>// å»æ‰ mysg ä¸Šç»‘å®šçš„ channel
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>c</span> = <span style=color:#66d9ef>nil</span>
    <span style=color:#a6e22e>releaseSudog</span>(<span style=color:#a6e22e>mysg</span>)
    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
}
</code></pre></div><p>åœ¨å‘é€æ•°æ®çš„é€»è¾‘æ‰§è¡Œä¹‹å‰ä¼šå…ˆä¸ºå½“å‰ Channel åŠ é”ï¼Œé˜²æ­¢å‘ç”Ÿç«äº‰æ¡ä»¶ã€‚å¦‚æœ Channel å·²ç»å…³é—­ï¼Œé‚£ä¹ˆå‘è¯¥ Channel å‘é€æ•°æ®æ—¶å°±ä¼šæŠ¥<code>"send on closed channel"</code> é”™è¯¯å¹¶ä¸­æ­¢ç¨‹åºã€‚</p>
<p>å› ä¸º <a href=https://github.com/golang/go/blob/e35876ec6591768edace6c6f3b12646899fd1b11/src/runtime/chan.go#L142><code>runtime.chansend</code></a> å‡½æ•°çš„å®ç°æ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå°†è¯¥å‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹åˆ†æˆä»¥ä¸‹çš„ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>å½“å­˜åœ¨ç­‰å¾…çš„æ¥æ”¶è€…æ—¶ï¼Œé€šè¿‡ <a href=https://github.com/golang/go/blob/e35876ec6591768edace6c6f3b12646899fd1b11/src/runtime/chan.go#L270><code>runtime.send</code></a> ç›´æ¥å°†æ•°æ®å‘é€ç»™é˜»å¡çš„æ¥æ”¶è€…ï¼›</li>
<li>å½“ç¼“å†²åŒºå­˜åœ¨ç©ºä½™ç©ºé—´æ—¶ï¼Œå°†å‘é€çš„æ•°æ®å†™å…¥ Channel çš„ç¼“å†²åŒºï¼›</li>
<li>å½“ä¸å­˜åœ¨ç¼“å†²åŒºæˆ–è€…ç¼“å†²åŒºå·²æ»¡æ—¶ï¼Œç­‰å¾…å…¶ä»– Goroutine ä» Channel æ¥æ”¶æ•°æ®ï¼›</li>
</ul>
<h3 id=1ç›´æ¥å‘é€><a href=#1ç›´æ¥å‘é€ class=h-anchor>ğŸ”—</a>1ã€ç›´æ¥å‘é€</h3>
<blockquote>
<p>ä¸¤ç§æƒ…å†µï¼ˆå‰æchannelæ²¡æœ‰å…³é—­ï¼‰ï¼š</p>
<p>1ã€æœ‰ç¼“å­˜ä½†æ˜¯æ­¤æ—¶ä¸ºç©ºä¸”å­˜åœ¨è¯»ç­‰å¾…çš„æ¥æ”¶è€…ï¼ˆç»•è¿‡bufferï¼‰</p>
<p>2ã€æ— ç¼“å­˜ä¸”å­˜åœ¨è¯»ç­‰å¾…çš„æ¥æ”¶è€…</p>
<p>ä¸¤æ¡ä»¶ï¼š1ã€channelæ²¡æœ‰å…³é—­ 2ã€å­˜åœ¨è¯»ç­‰å¾…çš„æ¥æ”¶è€…</p>
</blockquote>
<p>å¦‚æœç›®æ ‡ Channel æ²¡æœ‰è¢«å…³é—­å¹¶ä¸”å·²ç»æœ‰å¤„äºè¯»ç­‰å¾…çš„ Goroutineï¼Œé‚£ä¹ˆ <a href=https://github.com/golang/go/blob/e35876ec6591768edace6c6f3b12646899fd1b11/src/runtime/chan.go#L142><code>runtime.chansend</code></a> å‡½æ•°ä¼šä»æ¥æ”¶é˜Ÿåˆ— <code>recvq</code> ä¸­å–å‡ºæœ€å…ˆ(å…ˆå…¥å…ˆå‡ºåŸåˆ™)é™·å…¥ç­‰å¾…çš„ Goroutine å¹¶ç›´æ¥å‘å®ƒå‘é€æ•°æ®ï¼š</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// å¦‚æœæ¥æ”¶é˜Ÿåˆ—é‡Œæœ‰ goroutineï¼Œç›´æ¥å°†è¦å‘é€çš„æ•°æ®æ‹·è´åˆ°æ¥æ”¶ goroutine,ç»•è¿‡ç¼“å­˜åŒºï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
</span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvq</span>.<span style=color:#a6e22e>dequeue</span>(); <span style=color:#a6e22e>sg</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>sg</span>, <span style=color:#a6e22e>ep</span>, <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>) }, <span style=color:#ae81ff>3</span>)
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
	}
</code></pre></div><p>ä¸‹å›¾å±•ç¤ºäº† Channel ä¸­å­˜åœ¨ç­‰å¾…æ•°æ®çš„ Goroutine æ—¶ï¼Œå‘ Channel å‘é€æ•°æ®çš„è¿‡ç¨‹ï¼š</p>
<p><img src=https://img.draveness.me/2020-01-29-15802354027250-channel-direct-send.png alt=channel-direct-send></p>
<p>â€‹ <strong>å›¾ 6-20 ç›´æ¥å‘é€æ•°æ®çš„è¿‡ç¨‹</strong></p>
<p>å‘é€æ•°æ®æ—¶ä¼šè°ƒç”¨ <a href=https://github.com/golang/go/blob/e35876ec6591768edace6c6f3b12646899fd1b11/src/runtime/chan.go#L270><code>runtime.send</code></a>ï¼Œè¯¥å‡½æ•°çš„æ‰§è¡Œå¯ä»¥åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li>è°ƒç”¨ <a href=https://github.com/golang/go/blob/e35876ec6591768edace6c6f3b12646899fd1b11/src/runtime/chan.go#L313><code>runtime.sendDirect</code></a> å‡½æ•°å°†å‘é€çš„æ•°æ®ç›´æ¥æ‹·è´åˆ° <code>x = &lt;-c</code> è¡¨è¾¾å¼ä¸­å˜é‡ <code>x</code> æ‰€åœ¨çš„å†…å­˜åœ°å€ä¸Šï¼›</li>
<li>è°ƒç”¨ <a href=https://github.com/golang/go/blob/64c22b70bf00e15615bb17c29f808b55bc339682/src/runtime/proc.go#L313><code>runtime.goready</code></a> å°†ç­‰å¾…æ¥æ”¶æ•°æ®çš„ Goroutine æ ‡è®°æˆå¯è¿è¡ŒçŠ¶æ€ <code>Grunnable</code> å¹¶æŠŠè¯¥ Goroutine æ”¾åˆ°<strong>å‘é€æ–¹æ‰€åœ¨çš„å¤„ç†å™¨çš„ <code>runnext</code></strong> ä¸Šç­‰å¾…æ‰§è¡Œï¼Œè¯¥å¤„ç†å™¨åœ¨ä¸‹ä¸€æ¬¡è°ƒåº¦æ—¶å°±ä¼šç«‹åˆ»å”¤é†’æ•°æ®çš„æ¥æ”¶æ–¹ï¼›</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>, <span style=color:#a6e22e>sg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>, <span style=color:#a6e22e>ep</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>, <span style=color:#a6e22e>unlockf</span> <span style=color:#66d9ef>func</span>(), <span style=color:#a6e22e>skip</span> <span style=color:#66d9ef>int</span>) {
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>sendDirect</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>sg</span>, <span style=color:#a6e22e>ep</span>)
		<span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span> = <span style=color:#66d9ef>nil</span>
	}
	<span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>g</span>
	<span style=color:#a6e22e>unlockf</span>()
	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>sg</span>)
	<span style=color:#a6e22e>goready</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>skip</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)
}
<span style=color:#75715e>// å‘ä¸€ä¸ªéç¼“å†²å‹çš„ channel å‘é€æ•°æ®ã€ä»ä¸€ä¸ªæ— å…ƒç´ çš„ï¼ˆéç¼“å†²å‹æˆ–ç¼“å†²å‹ä½†ç©ºï¼‰çš„ channel
</span><span style=color:#75715e>// æ¥æ”¶æ•°æ®ï¼Œéƒ½ä¼šå¯¼è‡´ä¸€ä¸ª goroutine ç›´æ¥æ“ä½œå¦ä¸€ä¸ª goroutine çš„æ ˆ
</span><span style=color:#75715e>// ç”±äº GC å‡è®¾å¯¹æ ˆçš„å†™æ“ä½œåªèƒ½å‘ç”Ÿåœ¨ goroutine æ­£åœ¨è¿è¡Œä¸­å¹¶ä¸”ç”±å½“å‰ goroutine æ¥å†™
</span><span style=color:#75715e>// æ‰€ä»¥è¿™é‡Œå®é™…ä¸Šè¿åäº†è¿™ä¸ªå‡è®¾ã€‚å¯èƒ½ä¼šé€ æˆä¸€äº›é—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦ç”¨åˆ°å†™å±éšœæ¥è§„é¿
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sendDirect</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>_type</span>, <span style=color:#a6e22e>sg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>, <span style=color:#a6e22e>src</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) {
    <span style=color:#75715e>// src åœ¨å½“å‰ goroutine çš„æ ˆä¸Šï¼Œdst æ˜¯å¦ä¸€ä¸ª goroutine çš„æ ˆ
</span><span style=color:#75715e></span>
    <span style=color:#75715e>// ç›´æ¥è¿›è¡Œå†…å­˜&#34;æ¬è¿&#34;
</span><span style=color:#75715e></span>    <span style=color:#75715e>// å¦‚æœç›®æ ‡åœ°å€çš„æ ˆå‘ç”Ÿäº†æ ˆæ”¶ç¼©ï¼Œå½“æˆ‘ä»¬è¯»å‡ºäº† sg.elem å
</span><span style=color:#75715e></span>    <span style=color:#75715e>// å°±ä¸èƒ½ä¿®æ”¹çœŸæ­£çš„ dst ä½ç½®çš„å€¼äº†
</span><span style=color:#75715e></span>    <span style=color:#75715e>// å› æ­¤éœ€è¦åœ¨è¯»å’Œå†™ä¹‹å‰åŠ ä¸Šä¸€ä¸ªå±éšœ
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>dst</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span>
    <span style=color:#a6e22e>typeBitsBulkBarrier</span>(<span style=color:#a6e22e>t</span>, uintptr(<span style=color:#a6e22e>dst</span>), uintptr(<span style=color:#a6e22e>src</span>), <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>size</span>)
    <span style=color:#a6e22e>memmove</span>(<span style=color:#a6e22e>dst</span>, <span style=color:#a6e22e>src</span>, <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>size</span>)
}
<span style=color:#75715e>//è¿™é‡Œæ¶‰åŠåˆ°ä¸€ä¸ª goroutine ç›´æ¥å†™å¦ä¸€ä¸ª goroutine æ ˆçš„æ“ä½œï¼Œä¸€èˆ¬è€Œè¨€ï¼Œä¸åŒ goroutine çš„æ ˆæ˜¯å„è‡ªç‹¬æœ‰çš„ã€‚è€Œè¿™ä¹Ÿè¿åäº† GC çš„ä¸€äº›å‡è®¾ã€‚ä¸ºäº†ä¸å‡ºé—®é¢˜ï¼Œå†™çš„è¿‡ç¨‹ä¸­å¢åŠ äº†å†™å±éšœï¼Œä¿è¯æ­£ç¡®åœ°å®Œæˆå†™æ“ä½œã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å‡å°‘äº†ä¸€æ¬¡å†…å­˜ copyï¼šä¸ç”¨å…ˆæ‹·è´åˆ° channel çš„ bufï¼Œç›´æ¥ç”±å‘é€è€…åˆ°æ¥æ”¶è€…ï¼Œæ²¡æœ‰ä¸­é—´å•†èµšå·®ä»·ï¼Œæ•ˆç‡å¾—ä»¥æé«˜ï¼Œå®Œç¾ã€‚
</span></code></pre></div><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‘é€æ•°æ®çš„è¿‡ç¨‹åªæ˜¯å°†æ¥æ”¶æ–¹çš„ Goroutine æ”¾åˆ°äº†å¤„ç†å™¨çš„ <code>runnext</code> ä¸­ï¼Œç¨‹åºæ²¡æœ‰ç«‹åˆ»æ‰§è¡Œè¯¥ Goroutineã€‚</p>
<p>![](/Users/gongqi/Nutstore Files/ä¸ªäººæ€»ç»“/pic/channel-ç›´æ¥å‘é€.png)</p>
<p>ç›´æ¥å‘é€çš„å¥½å¤„ï¼š</p>
<p>å‡å°‘äº†ä¸€æ¬¡å†…å­˜ copyï¼šä¸ç”¨å…ˆæ‹·è´åˆ° channel çš„ bufï¼Œç›´æ¥ç”±å‘é€è€…åˆ°æ¥æ”¶è€…ï¼Œæ²¡æœ‰ä¸­é—´å•†èµšå·®ä»·ï¼Œæ•ˆç‡å¾—ä»¥æé«˜ï¼Œå®Œç¾ã€‚</p>
<h3 id=2ç¼“å†²åŒº><a href=#2ç¼“å†²åŒº class=h-anchor>ğŸ”—</a>2ã€ç¼“å†²åŒº</h3>
<p>ä¸€ç§æƒ…å†µ</p>
<blockquote>
<p>æœ‰ç¼“å­˜åŒºä¸”channelæ²¡æ»¡</p>
</blockquote>
<p><img src=https://img.draveness.me/2020-01-28-15802171487104-channel-buffer-send.png alt=channel-buffer-send></p>
<p>å¦‚æœå½“å‰ Channel çš„ç¼“å†²åŒºæœªæ»¡ï¼Œå‘ Channel å‘é€çš„æ•°æ®ä¼šå­˜å‚¨åœ¨ Channel ä¸­ <code>sendx</code> ç´¢å¼•æ‰€åœ¨çš„ä½ç½®å¹¶å°† <code>sendx</code> ç´¢å¼•åŠ ä¸€ï¼Œç”±äºè¿™é‡Œçš„ <code>buf</code> æ˜¯ä¸€ä¸ªå¾ªç¯æ•°ç»„ï¼Œæ‰€ä»¥å½“ <code>sendx</code> ç­‰äº <code>dataqsiz</code> æ—¶å°±ä¼šé‡æ–°å›åˆ°æ•°ç»„å¼€å§‹çš„ä½ç½®ã€‚</p>
<h3 id=3é˜»å¡å‘é€><a href=#3é˜»å¡å‘é€ class=h-anchor>ğŸ”—</a>3ã€é˜»å¡å‘é€</h3>
<ol>
<li>è°ƒç”¨ <a href=https://github.com/golang/go/blob/e35876ec6591768edace6c6f3b12646899fd1b11/src/runtime/stubs.go#L18><code>runtime.getg</code></a> è·å–å‘é€æ•°æ®ä½¿ç”¨çš„ Goroutineï¼›</li>
<li>æ‰§è¡Œ <a href=https://github.com/golang/go/blob/64c22b70bf00e15615bb17c29f808b55bc339682/src/runtime/proc.go#L320><code>runtime.acquireSudog</code></a> å‡½æ•°è·å– <a href=https://github.com/golang/go/blob/895b7c85addfffe19b66d8ca71c31799d6e55990/src/runtime/runtime2.go#L342><code>runtime.sudog</code></a> ç»“æ„ä½“å¹¶è®¾ç½®è¿™ä¸€æ¬¡é˜»å¡å‘é€çš„ç›¸å…³ä¿¡æ¯ï¼Œä¾‹å¦‚å‘é€çš„ Channelã€æ˜¯å¦åœ¨ Select æ§åˆ¶ç»“æ„ä¸­å’Œå¾…å‘é€æ•°æ®çš„å†…å­˜åœ°å€ç­‰ï¼›</li>
<li>å°†åˆšåˆšåˆ›å»ºå¹¶åˆå§‹åŒ–çš„ <a href=https://github.com/golang/go/blob/895b7c85addfffe19b66d8ca71c31799d6e55990/src/runtime/runtime2.go#L342><code>runtime.sudog</code></a> åŠ å…¥å‘é€ç­‰å¾…é˜Ÿåˆ—ï¼Œå¹¶è®¾ç½®åˆ°å½“å‰ Goroutine çš„ <code>waiting</code> ä¸Šï¼Œè¡¨ç¤º Goroutine æ­£åœ¨ç­‰å¾…è¯¥ <code>sudog</code> å‡†å¤‡å°±ç»ªï¼›</li>
<li>è°ƒç”¨ <a href=https://github.com/golang/go/blob/cfe3cd903f018dec3cb5997d53b1744df4e53909/src/runtime/proc.go#L309><code>runtime.goparkunlock</code></a> å‡½æ•°å°†å½“å‰çš„ Goroutine é™·å…¥æ²‰ç¡ç­‰å¾…å”¤é†’ï¼›</li>
<li>è¢«è°ƒåº¦å™¨å”¤é†’åä¼šæ‰§è¡Œä¸€äº›æ”¶å°¾å·¥ä½œï¼Œå°†ä¸€äº›å±æ€§ç½®é›¶å¹¶ä¸”é‡Šæ”¾ <a href=https://github.com/golang/go/blob/895b7c85addfffe19b66d8ca71c31799d6e55990/src/runtime/runtime2.go#L342><code>runtime.sudog</code></a> ç»“æ„ä½“ï¼›</li>
</ol>
<h3 id=4å°ç»“><a href=#4å°ç»“ class=h-anchor>ğŸ”—</a>4ã€å°ç»“</h3>
<p>æˆ‘ä»¬åœ¨è¿™é‡Œå¯ä»¥ç®€å•æ¢³ç†å’Œæ€»ç»“ä¸€ä¸‹ä½¿ç”¨ <code>ch &lt;- i</code> è¡¨è¾¾å¼å‘ Channel å‘é€æ•°æ®æ—¶é‡åˆ°çš„å‡ ç§æƒ…å†µï¼š</p>
<ol>
<li><strong>å¦‚æœå½“å‰ Channel çš„ <code>recvq</code> ä¸Šå­˜åœ¨å·²ç»è¢«é˜»å¡çš„ Goroutineï¼Œé‚£ä¹ˆä¼šç›´æ¥å°†æ•°æ®å‘é€ç»™å½“å‰çš„ Goroutine å¹¶å°†å…¶è®¾ç½®æˆä¸‹ä¸€ä¸ªè¿è¡Œçš„ Goroutineï¼›</strong></li>
<li><strong>å¦‚æœ Channel å­˜åœ¨ç¼“å†²åŒºå¹¶ä¸”å…¶ä¸­è¿˜æœ‰ç©ºé—²çš„å®¹é‡ï¼Œæˆ‘ä»¬å°±ä¼šå°†æ•°æ®ç›´æ¥å­˜å‚¨åˆ°å½“å‰ç¼“å†²åŒº <code>sendx</code> æ‰€åœ¨çš„ä½ç½®ä¸Šï¼›</strong></li>
<li><strong>å¦‚æœä¸æ»¡è¶³ä¸Šé¢çš„ä¸¤ç§æƒ…å†µï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ª <a href=https://github.com/golang/go/blob/895b7c85addfffe19b66d8ca71c31799d6e55990/src/runtime/runtime2.go#L342><code>runtime.sudog</code></a> ç»“æ„å¹¶å°†å…¶åŠ å…¥ Channel çš„ <code>sendq</code> é˜Ÿåˆ—ä¸­ï¼Œå½“å‰ Goroutine ä¹Ÿä¼šé™·å…¥é˜»å¡ç­‰å¾…å…¶ä»–çš„åç¨‹ä» Channel æ¥æ”¶æ•°æ®ï¼›</strong></li>
</ol>
<p>å‘é€æ•°æ®çš„è¿‡ç¨‹ä¸­åŒ…å«å‡ ä¸ªä¼šè§¦å‘ Goroutine è°ƒåº¦çš„æ—¶æœºï¼š</p>
<ol>
<li>
<p>å½“ Channel ä¸ºnilæ—¶ï¼›</p>
</li>
<li>
<p>å‘é€æ•°æ®æ—¶å‘ç° Channel ä¸Šå­˜åœ¨ç­‰å¾…æ¥æ”¶æ•°æ®çš„ Goroutineï¼Œç«‹åˆ»è®¾ç½®å¤„ç†å™¨çš„ <code>runnext</code> å±æ€§ï¼Œä½†æ˜¯å¹¶ä¸ä¼šç«‹åˆ»è§¦å‘è°ƒåº¦ï¼›</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>goready</span>(<span style=color:#a6e22e>gp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>, <span style=color:#a6e22e>traceskip</span> <span style=color:#66d9ef>int</span>) {
	<span style=color:#a6e22e>systemstack</span>(<span style=color:#66d9ef>func</span>() {
		<span style=color:#a6e22e>ready</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>traceskip</span>, <span style=color:#66d9ef>true</span>)
	})
}
</code></pre></div></li>
<li>
<p>å‘é€æ•°æ®æ—¶å¹¶æ²¡æœ‰æ‰¾åˆ°æ¥æ”¶æ–¹å¹¶ä¸”ç¼“å†²åŒºå·²ç»æ»¡äº†ï¼Œè¿™æ—¶å°±ä¼šå°†è‡ªå·±åŠ å…¥ Channel çš„ <code>sendq</code> é˜Ÿåˆ—å¹¶è°ƒç”¨ <a href=https://github.com/golang/go/blob/cfe3cd903f018dec3cb5997d53b1744df4e53909/src/runtime/proc.go#L309><code>runtime.goparkunlock</code></a> è§¦å‘ Goroutine çš„è°ƒåº¦è®©å‡ºå¤„ç†å™¨çš„ä½¿ç”¨æƒï¼›</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>goparkunlock</span>(<span style=color:#a6e22e>lock</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mutex</span>, <span style=color:#a6e22e>reason</span> <span style=color:#a6e22e>waitReason</span>, <span style=color:#a6e22e>traceEv</span> <span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>traceskip</span> <span style=color:#66d9ef>int</span>) {
	<span style=color:#a6e22e>gopark</span>(<span style=color:#a6e22e>parkunlock_c</span>, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>lock</span>), <span style=color:#a6e22e>reason</span>, <span style=color:#a6e22e>traceEv</span>, <span style=color:#a6e22e>traceskip</span>)
}
</code></pre></div></li>
</ol>
<h3 id=5é—®é¢˜><a href=#5é—®é¢˜ class=h-anchor>ğŸ”—</a>5ã€é—®é¢˜</h3>
<p>å¯¹äºæœ‰ç¼“å­˜channelï¼Œæœ‰æ— å¯èƒ½å­˜åœ¨è¯»ç­‰å¾…çš„æ¥æ”¶è€…ä¸”ç¼“å­˜ä¸ä¸ºç©ºçš„æƒ…å†µï¼Œå¦‚æœå­˜åœ¨è¿™ç§æƒ…å†µï¼Œä¸€æ—¦ç›´æ¥å‘é€ï¼Œé‚£ä¹ˆæ•°æ®ä¸èƒ½ä¿è¯å…ˆå…¥å…ˆå‡ºäº†ã€‚</p>
<h2 id=æ¥æ”¶æ•°æ®><a href=#æ¥æ”¶æ•°æ® class=h-anchor>ğŸ”—</a>æ¥æ”¶æ•°æ®</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// entry points for &lt;- c from compiled code
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>chanrecv1</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>, <span style=color:#a6e22e>elem</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) {
    <span style=color:#a6e22e>chanrecv</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>elem</span>, <span style=color:#66d9ef>true</span>)
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>chanrecv2</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>, <span style=color:#a6e22e>elem</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) (<span style=color:#a6e22e>received</span> <span style=color:#66d9ef>bool</span>) {
    <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>received</span> = <span style=color:#a6e22e>chanrecv</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>elem</span>, <span style=color:#66d9ef>true</span>)
    <span style=color:#66d9ef>return</span>
}
<span style=color:#75715e>//æ¥æ”¶æ“ä½œæœ‰ä¸¤ç§å†™æ³•ï¼Œä¸€ç§å¸¦ &#34;ok&#34;ï¼Œååº” channel æ˜¯å¦å…³é—­ï¼›ä¸€ç§ä¸å¸¦ &#34;ok&#34;ï¼Œè¿™ç§å†™æ³•ï¼Œå½“æ¥æ”¶åˆ°ç›¸åº”ç±»å‹çš„é›¶å€¼æ—¶æ— æ³•çŸ¥é“æ˜¯çœŸå®çš„å‘é€è€…å‘é€è¿‡æ¥çš„å€¼ï¼Œè¿˜æ˜¯ channel è¢«å…³é—­åï¼Œè¿”å›ç»™æ¥æ”¶è€…çš„é»˜è®¤ç±»å‹çš„é›¶å€¼ã€‚
</span><span style=color:#75715e>// ä½äº src/runtime/chan.go
</span><span style=color:#75715e></span>
<span style=color:#75715e>// chanrecv å‡½æ•°æ¥æ”¶ channel c çš„å…ƒç´ å¹¶å°†å…¶å†™å…¥ ep æ‰€æŒ‡å‘çš„å†…å­˜åœ°å€ã€‚
</span><span style=color:#75715e>// å¦‚æœ ep æ˜¯ nilï¼Œè¯´æ˜å¿½ç•¥äº†æ¥æ”¶å€¼ã€‚
</span><span style=color:#75715e>// å¦‚æœ block == falseï¼Œå³éé˜»å¡å‹æ¥æ”¶ï¼Œåœ¨æ²¡æœ‰æ•°æ®å¯æ¥æ”¶çš„æƒ…å†µä¸‹ï¼Œè¿”å› (false, false)
</span><span style=color:#75715e>// å¦åˆ™ï¼Œå¦‚æœ c å¤„äºå…³é—­çŠ¶æ€ï¼Œå°† ep æŒ‡å‘çš„åœ°å€æ¸…é›¶ï¼Œè¿”å› (true, false)
</span><span style=color:#75715e>// å¦åˆ™ï¼Œç”¨è¿”å›å€¼å¡«å…… ep æŒ‡å‘çš„å†…å­˜åœ°å€ã€‚è¿”å› (true, true)
</span><span style=color:#75715e>// å¦‚æœ ep éç©ºï¼Œåˆ™åº”è¯¥æŒ‡å‘å †æˆ–è€…å‡½æ•°è°ƒç”¨è€…çš„æ ˆ
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>chanrecv</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>, <span style=color:#a6e22e>ep</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>, <span style=color:#a6e22e>block</span> <span style=color:#66d9ef>bool</span>) (<span style=color:#a6e22e>selected</span>, <span style=color:#a6e22e>received</span> <span style=color:#66d9ef>bool</span>) {
    <span style=color:#75715e>// çœç•¥ debug å†…å®¹ â€¦â€¦â€¦â€¦
</span><span style=color:#75715e></span>
    <span style=color:#75715e>// å¦‚æœæ˜¯ä¸€ä¸ª nil çš„ channel
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#75715e>// å¦‚æœä¸é˜»å¡ï¼Œç›´æ¥è¿”å› (false, false)
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>block</span> {
            <span style=color:#66d9ef>return</span>
        }
        <span style=color:#75715e>// å¦åˆ™ï¼Œæ¥æ”¶ä¸€ä¸ª nil çš„ channelï¼Œgoroutine æŒ‚èµ·
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>gopark</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#e6db74>&#34;chan receive (nil chan)&#34;</span>, <span style=color:#a6e22e>traceEvGoStop</span>, <span style=color:#ae81ff>2</span>)
        <span style=color:#75715e>// ä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;unreachable&#34;</span>)
    }

    <span style=color:#75715e>// åœ¨éé˜»å¡æ¨¡å¼ä¸‹ï¼Œå¿«é€Ÿæ£€æµ‹åˆ°å¤±è´¥ï¼Œä¸ç”¨è·å–é”ï¼Œå¿«é€Ÿè¿”å›
</span><span style=color:#75715e></span>    <span style=color:#75715e>// å½“æˆ‘ä»¬è§‚å¯Ÿåˆ° channel æ²¡å‡†å¤‡å¥½æ¥æ”¶ï¼š
</span><span style=color:#75715e></span>    <span style=color:#75715e>// 1. éç¼“å†²å‹ï¼Œç­‰å¾…å‘é€åˆ—é˜Ÿ sendq é‡Œæ²¡æœ‰ goroutine åœ¨ç­‰å¾…
</span><span style=color:#75715e></span>    <span style=color:#75715e>// 2. ç¼“å†²å‹ï¼Œä½† buf é‡Œæ²¡æœ‰å…ƒç´ 
</span><span style=color:#75715e></span>    <span style=color:#75715e>// ä¹‹åï¼Œåˆè§‚å¯Ÿåˆ° closed == 0ï¼Œå³ channel æœªå…³é—­ã€‚
</span><span style=color:#75715e></span>    <span style=color:#75715e>// å› ä¸º channel ä¸å¯èƒ½è¢«é‡å¤æ‰“å¼€ï¼Œæ‰€ä»¥å‰ä¸€ä¸ªè§‚æµ‹çš„æ—¶å€™ channel ä¹Ÿæ˜¯æœªå…³é—­çš„ï¼Œ
</span><span style=color:#75715e></span>    <span style=color:#75715e>// å› æ­¤åœ¨è¿™ç§æƒ…å†µä¸‹å¯ä»¥ç›´æ¥å®£å¸ƒæ¥æ”¶å¤±è´¥ï¼Œè¿”å› (false, false)
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>block</span> <span style=color:#f92672>&amp;&amp;</span> (<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dataqsiz</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendq</span>.<span style=color:#a6e22e>first</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span>
        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dataqsiz</span> &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Loaduint</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>qcount</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>&amp;&amp;</span>
        <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>closed</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
        <span style=color:#66d9ef>return</span>
    }

    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>t0</span> <span style=color:#66d9ef>int64</span>
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>blockprofilerate</span> &gt; <span style=color:#ae81ff>0</span> {
        <span style=color:#a6e22e>t0</span> = <span style=color:#a6e22e>cputicks</span>()
    }

    <span style=color:#75715e>// åŠ é”
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)

    <span style=color:#75715e>// channel å·²å…³é—­ï¼Œå¹¶ä¸”å¾ªç¯æ•°ç»„ buf é‡Œæ²¡æœ‰å…ƒç´ 
</span><span style=color:#75715e></span>    <span style=color:#75715e>// è¿™é‡Œå¯ä»¥å¤„ç†éç¼“å†²å‹å…³é—­ å’Œ ç¼“å†²å‹å…³é—­ä½† buf æ— å…ƒç´ çš„æƒ…å†µ
</span><span style=color:#75715e></span>    <span style=color:#75715e>// ä¹Ÿå°±æ˜¯è¯´å³ä½¿æ˜¯å…³é—­çŠ¶æ€ï¼Œä½†åœ¨ç¼“å†²å‹çš„ channelï¼Œ
</span><span style=color:#75715e></span>    <span style=color:#75715e>// buf é‡Œæœ‰å…ƒç´ çš„æƒ…å†µä¸‹è¿˜èƒ½æ¥æ”¶åˆ°å…ƒç´ 
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>closed</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>qcount</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>raceenabled</span> {
            <span style=color:#a6e22e>raceacquire</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>c</span>))
        }
        <span style=color:#75715e>// è§£é”
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ep</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
            <span style=color:#75715e>// ä»ä¸€ä¸ªå·²å…³é—­çš„ channel æ‰§è¡Œæ¥æ”¶æ“ä½œï¼Œä¸”æœªå¿½ç•¥è¿”å›å€¼
</span><span style=color:#75715e></span>            <span style=color:#75715e>// é‚£ä¹ˆæ¥æ”¶çš„å€¼å°†æ˜¯ä¸€ä¸ªè¯¥ç±»å‹çš„é›¶å€¼
</span><span style=color:#75715e></span>            <span style=color:#75715e>// typedmemclr æ ¹æ®ç±»å‹æ¸…ç†ç›¸åº”åœ°å€çš„å†…å­˜
</span><span style=color:#75715e></span>            <span style=color:#a6e22e>typedmemclr</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>ep</span>)
        }
        <span style=color:#75715e>// ä»ä¸€ä¸ªå·²å…³é—­çš„ channel æ¥æ”¶ï¼Œselected ä¼šè¿”å›true
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>false</span>
    }

    <span style=color:#75715e>// ç­‰å¾…å‘é€é˜Ÿåˆ—é‡Œæœ‰ goroutine å­˜åœ¨ï¼Œè¯´æ˜ buf æ˜¯æ»¡çš„
</span><span style=color:#75715e></span>    <span style=color:#75715e>// è¿™æœ‰å¯èƒ½æ˜¯ï¼š
</span><span style=color:#75715e></span>    <span style=color:#75715e>// 1. éç¼“å†²å‹çš„ channel
</span><span style=color:#75715e></span>    <span style=color:#75715e>// 2. ç¼“å†²å‹çš„ channelï¼Œä½† buf æ»¡äº†
</span><span style=color:#75715e></span>    <span style=color:#75715e>// é’ˆå¯¹ 1ï¼Œç›´æ¥è¿›è¡Œå†…å­˜æ‹·è´ï¼ˆä» sender goroutine -&gt; receiver goroutineï¼‰
</span><span style=color:#75715e></span>    <span style=color:#75715e>// é’ˆå¯¹ 2ï¼Œæ¥æ”¶åˆ°å¾ªç¯æ•°ç»„å¤´éƒ¨çš„å…ƒç´ ï¼Œå¹¶å°†å‘é€è€…çš„å…ƒç´ æ”¾åˆ°å¾ªç¯æ•°ç»„å°¾éƒ¨
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendq</span>.<span style=color:#a6e22e>dequeue</span>(); <span style=color:#a6e22e>sg</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#75715e>// Found a waiting sender. If buffer is size 0, receive value
</span><span style=color:#75715e></span>        <span style=color:#75715e>// directly from sender. Otherwise, receive from head of queue
</span><span style=color:#75715e></span>        <span style=color:#75715e>// and add sender&#39;s value to the tail of the queue (both map to
</span><span style=color:#75715e></span>        <span style=color:#75715e>// the same buffer slot because the queue is full).
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>recv</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>sg</span>, <span style=color:#a6e22e>ep</span>, <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>) }, <span style=color:#ae81ff>3</span>)
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>true</span>
    }

    <span style=color:#75715e>// ç¼“å†²å‹ï¼Œbuf é‡Œæœ‰å…ƒç´ ï¼Œå¯ä»¥æ­£å¸¸æ¥æ”¶
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>qcount</span> &gt; <span style=color:#ae81ff>0</span> {
        <span style=color:#75715e>// ç›´æ¥ä»å¾ªç¯æ•°ç»„é‡Œæ‰¾åˆ°è¦æ¥æ”¶çš„å…ƒç´ 
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>qp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>chanbuf</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span>)

        <span style=color:#75715e>// â€¦â€¦â€¦â€¦
</span><span style=color:#75715e></span>
        <span style=color:#75715e>// ä»£ç é‡Œï¼Œæ²¡æœ‰å¿½ç•¥è¦æ¥æ”¶çš„å€¼ï¼Œä¸æ˜¯ &#34;&lt;- ch&#34;ï¼Œè€Œæ˜¯ &#34;val &lt;- ch&#34;ï¼Œep æŒ‡å‘ val
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ep</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
            <span style=color:#a6e22e>typedmemmove</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>ep</span>, <span style=color:#a6e22e>qp</span>)
        }
        <span style=color:#75715e>// æ¸…ç†æ‰å¾ªç¯æ•°ç»„é‡Œç›¸åº”ä½ç½®çš„å€¼
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>typedmemclr</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>qp</span>)
        <span style=color:#75715e>// æ¥æ”¶æ¸¸æ ‡å‘å‰ç§»åŠ¨
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span><span style=color:#f92672>++</span>
        <span style=color:#75715e>// æ¥æ”¶æ¸¸æ ‡å½’é›¶
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dataqsiz</span> {
            <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span> = <span style=color:#ae81ff>0</span>
        }
        <span style=color:#75715e>// buf æ•°ç»„é‡Œçš„å…ƒç´ ä¸ªæ•°å‡ 1
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>qcount</span><span style=color:#f92672>--</span>
        <span style=color:#75715e>// è§£é”
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>true</span>
    }

    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>block</span> {
        <span style=color:#75715e>// éé˜»å¡æ¥æ”¶ï¼Œè§£é”ã€‚selected è¿”å› falseï¼Œå› ä¸ºæ²¡æœ‰æ¥æ”¶åˆ°å€¼
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>
    }

    <span style=color:#75715e>// æ¥ä¸‹æ¥å°±æ˜¯è¦è¢«é˜»å¡çš„æƒ…å†µäº†
</span><span style=color:#75715e></span>    <span style=color:#75715e>// æ„é€ ä¸€ä¸ª sudog
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
    <span style=color:#a6e22e>mysg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>acquireSudog</span>()
    <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span> = <span style=color:#ae81ff>0</span>
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>t0</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
        <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
    }

    <span style=color:#75715e>// å¾…æ¥æ”¶æ•°æ®çš„åœ°å€ä¿å­˜ä¸‹æ¥
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>elem</span> = <span style=color:#a6e22e>ep</span>
    <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>waitlink</span> = <span style=color:#66d9ef>nil</span>
    <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>waiting</span> = <span style=color:#a6e22e>mysg</span>
    <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>g</span> = <span style=color:#a6e22e>gp</span>
    <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>selectdone</span> = <span style=color:#66d9ef>nil</span>
    <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>c</span> = <span style=color:#a6e22e>c</span>
    <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#66d9ef>nil</span>
    <span style=color:#75715e>// è¿›å…¥channel çš„ç­‰å¾…æ¥æ”¶é˜Ÿåˆ—
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvq</span>.<span style=color:#a6e22e>enqueue</span>(<span style=color:#a6e22e>mysg</span>)
    <span style=color:#75715e>// å°†å½“å‰ goroutine æŒ‚èµ·
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>goparkunlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>, <span style=color:#e6db74>&#34;chan receive&#34;</span>, <span style=color:#a6e22e>traceEvGoBlockRecv</span>, <span style=color:#ae81ff>3</span>)

    <span style=color:#75715e>// è¢«å”¤é†’äº†ï¼Œæ¥ç€ä»è¿™é‡Œç»§ç»­æ‰§è¡Œä¸€äº›æ‰«å°¾å·¥ä½œ
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mysg</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>waiting</span> {
        <span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;G waiting list is corrupted&#34;</span>)
    }
    <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>waiting</span> = <span style=color:#66d9ef>nil</span>
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span> &gt; <span style=color:#ae81ff>0</span> {
        <span style=color:#a6e22e>blockevent</span>(<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span><span style=color:#f92672>-</span><span style=color:#a6e22e>t0</span>, <span style=color:#ae81ff>2</span>)
    }
    <span style=color:#a6e22e>closed</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span>
    <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#66d9ef>nil</span>
    <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>c</span> = <span style=color:#66d9ef>nil</span>
    <span style=color:#a6e22e>releaseSudog</span>(<span style=color:#a6e22e>mysg</span>)
    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, !<span style=color:#a6e22e>closed</span>
}
</code></pre></div><h3 id=1ç›´æ¥æ¥æ”¶><a href=#1ç›´æ¥æ¥æ”¶ class=h-anchor>ğŸ”—</a>1ã€ç›´æ¥æ¥æ”¶</h3>
<blockquote>
<p>ä¸¤ç§æƒ…å†µï¼ˆå‰æchannelæ²¡æœ‰å…³é—­ï¼‰ï¼š</p>
<p>1ã€æœ‰ç¼“å­˜ä½†æ˜¯æ­¤æ—¶æ»¡äº†ä¸”å­˜åœ¨å†™ç­‰å¾…çš„å‘é€è€…</p>
<p>2ã€æ— ç¼“å­˜ä¸”å­˜åœ¨å†™ç­‰å¾…çš„å‘é€è€…</p>
<p>ä¸¤æ¡ä»¶ï¼š1ã€channelæ²¡æœ‰å…³é—­ 2ã€å­˜åœ¨å†™ç­‰å¾…çš„å‘é€è€…</p>
</blockquote>
<p>è¯¥å‡½æ•°ä¼šæ ¹æ®ç¼“å†²åŒºçš„å¤§å°åˆ†åˆ«å¤„ç†ä¸åŒçš„æƒ…å†µï¼š</p>
<ul>
<li>å¦‚æœ Channel ä¸å­˜åœ¨ç¼“å†²åŒºï¼›
<ol>
<li>è°ƒç”¨ <a href=https://github.com/golang/go/blob/e35876ec6591768edace6c6f3b12646899fd1b11/src/runtime/chan.go#L326><code>runtime.recvDirect</code></a> å‡½æ•°ä¼šå°† Channel å‘é€é˜Ÿåˆ—ä¸­ Goroutine å­˜å‚¨çš„ <code>elem</code> æ•°æ®æ‹·è´åˆ°ç›®æ ‡å†…å­˜åœ°å€ä¸­ï¼›</li>
</ol>
</li>
<li>å¦‚æœ Channel å­˜åœ¨ç¼“å†²åŒºï¼›
<ol>
<li>å°†ç¼“å­˜åŒºrecvxæŒ‡å‘çš„æ•°æ®æ‹·è´åˆ°æ¥æ”¶æ–¹çš„å†…å­˜åœ°å€ï¼›</li>
<li>å°†å‘é€é˜Ÿåˆ—å¤´çš„æ•°æ®æ‹·è´åˆ°ç¼“å†²åŒºä¸­ï¼Œé‡Šæ”¾ä¸€ä¸ªé˜»å¡çš„å‘é€æ–¹ï¼›</li>
</ol>
</li>
</ul>
<p>æ— è®ºå‘ç”Ÿå“ªç§æƒ…å†µï¼Œè¿è¡Œæ—¶éƒ½ä¼šè°ƒç”¨ <a href=https://draveness.me/golang/tree/runtime.goready><code>runtime.goready</code></a> å‡½æ•°å°†å½“å‰å¤„ç†å™¨çš„ <code>runnext</code> è®¾ç½®æˆå‘é€æ•°æ®çš„ Goroutineï¼Œåœ¨è°ƒåº¦å™¨ä¸‹ä¸€æ¬¡è°ƒåº¦æ—¶å°†é˜»å¡çš„å‘é€æ–¹å”¤é†’ã€‚</p>
<h3 id=2ç¼“å­˜åŒº><a href=#2ç¼“å­˜åŒº class=h-anchor>ğŸ”—</a>2ã€ç¼“å­˜åŒº</h3>
<p>å¦‚æœæ¥æ”¶æ•°æ®çš„å†…å­˜åœ°å€ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆå°±ä¼šç›´æ¥ä½¿ç”¨ <a href=https://github.com/golang/go/blob/db16de920370892b0241d3fa0617dddff2417a4d/src/runtime/mbarrier.go#L156><code>runtime.typedmemmove</code></a> å°†ç¼“å†²åŒºä¸­çš„æ•°æ®æ‹·è´åˆ°å†…å­˜ä¸­ã€æ¸…é™¤é˜Ÿåˆ—ä¸­çš„æ•°æ®å¹¶å®Œæˆæ”¶å°¾å·¥ä½œã€‚</p>
<p><img src=https://img.draveness.me/2020-01-28-15802171487125-channel-buffer-receive.png alt=channel-buffer-receive></p>
<h3 id=3é˜»å¡æ¥æ”¶><a href=#3é˜»å¡æ¥æ”¶ class=h-anchor>ğŸ”—</a>3ã€é˜»å¡æ¥æ”¶</h3>
<p>å½“ Channel çš„å‘é€é˜Ÿåˆ—ä¸­<strong>ä¸å­˜åœ¨ç­‰å¾…çš„ Goroutine å¹¶ä¸”ç¼“å†²åŒºä¸­ä¹Ÿä¸å­˜åœ¨ä»»ä½•æ•°æ®æ—¶</strong>ï¼Œä»ç®¡é“ä¸­æ¥æ”¶æ•°æ®çš„æ“ä½œä¼šå˜æˆé˜»å¡æ“ä½œï¼Œç„¶è€Œä¸æ˜¯æ‰€æœ‰çš„æ¥æ”¶æ“ä½œéƒ½æ˜¯é˜»å¡çš„ï¼Œä¸ <code>select</code> è¯­å¥ç»“åˆä½¿ç”¨æ—¶å°±å¯èƒ½ä¼šä½¿ç”¨åˆ°éé˜»å¡çš„æ¥æ”¶æ“ä½œï¼š</p>
<p>åœ¨æ­£å¸¸çš„æ¥æ”¶åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ <a href=https://github.com/golang/go/blob/895b7c85addfffe19b66d8ca71c31799d6e55990/src/runtime/runtime2.go#L342><code>runtime.sudog</code></a> ç»“æ„ä½“å°†å½“å‰ Goroutine åŒ…è£…æˆä¸€ä¸ªå¤„äºç­‰å¾…çŠ¶æ€çš„ Goroutine å¹¶å°†å…¶åŠ å…¥åˆ°æ¥æ”¶é˜Ÿåˆ—ä¸­ã€‚</p>
<p>å®Œæˆå…¥é˜Ÿä¹‹åï¼Œä¸Šè¿°ä»£ç è¿˜ä¼šè°ƒç”¨ <a href=https://github.com/golang/go/blob/cfe3cd903f018dec3cb5997d53b1744df4e53909/src/runtime/proc.go#L309><code>runtime.goparkunlock</code></a> å‡½æ•°ç«‹åˆ»è§¦å‘ Goroutine çš„è°ƒåº¦ï¼Œè®©å‡ºå¤„ç†å™¨çš„ä½¿ç”¨æƒå¹¶ç­‰å¾…è°ƒåº¦å™¨çš„è°ƒåº¦ã€‚</p>
<h3 id=4å°ç»“-1><a href=#4å°ç»“-1 class=h-anchor>ğŸ”—</a>4ã€å°ç»“</h3>
<p>æˆ‘ä»¬æ¢³ç†ä¸€ä¸‹ä» Channel ä¸­æ¥æ”¶æ•°æ®æ—¶å¯èƒ½ä¼šå‘ç”Ÿçš„äº”ç§æƒ…å†µï¼š</p>
<ol>
<li>å¦‚æœ Channel ä¸ºç©ºï¼Œé‚£ä¹ˆå°±ä¼šç›´æ¥è°ƒç”¨ <a href=https://github.com/golang/go/blob/64c22b70bf00e15615bb17c29f808b55bc339682/src/runtime/proc.go#L287><code>runtime.gopark</code></a> æŒ‚èµ·å½“å‰ Goroutineï¼›</li>
<li>å¦‚æœ Channel å·²ç»å…³é—­å¹¶ä¸”ç¼“å†²åŒºæ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œ<a href=https://github.com/golang/go/blob/e35876ec6591768edace6c6f3b12646899fd1b11/src/runtime/chan.go#L422><code>runtime.chanrecv</code></a> å‡½æ•°ä¼šç›´æ¥è¿”å›ï¼›</li>
<li>å¦‚æœ Channel çš„ <code>sendq</code> é˜Ÿåˆ—ä¸­å­˜åœ¨æŒ‚èµ·çš„ Goroutineï¼Œå°±ä¼šå°† <code>recvx</code> ç´¢å¼•æ‰€åœ¨çš„æ•°æ®æ‹·è´åˆ°æ¥æ”¶å˜é‡æ‰€åœ¨çš„å†…å­˜ç©ºé—´ä¸Šå¹¶å°† <code>sendq</code> é˜Ÿåˆ—ä¸­ Goroutine çš„æ•°æ®æ‹·è´åˆ°ç¼“å†²åŒºï¼›</li>
<li>å¦‚æœ Channel çš„ç¼“å†²åŒºä¸­åŒ…å«æ•°æ®å°±ä¼šç›´æ¥è¯»å– <code>recvx</code> ç´¢å¼•å¯¹åº”çš„æ•°æ®ï¼›</li>
<li>åœ¨é»˜è®¤æƒ…å†µä¸‹ä¼šæŒ‚èµ·å½“å‰çš„ Goroutineï¼Œå°† <a href=https://github.com/golang/go/blob/895b7c85addfffe19b66d8ca71c31799d6e55990/src/runtime/runtime2.go#L342><code>runtime.sudog</code></a> ç»“æ„åŠ å…¥ <code>recvq</code> é˜Ÿåˆ—å¹¶é™·å…¥ä¼‘çœ ç­‰å¾…è°ƒåº¦å™¨çš„å”¤é†’ï¼›</li>
</ol>
<p>æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ä» Channel æ¥æ”¶æ•°æ®æ—¶ï¼Œä¼šè§¦å‘ Goroutine è°ƒåº¦çš„ä¸¤ä¸ªæ—¶æœºï¼š</p>
<ol>
<li>å½“ Channel ä¸ºnilæ—¶ï¼›</li>
<li>æ¥æ”¶æ•°æ®æ—¶å‘ç° Channel ä¸Šå­˜åœ¨ç­‰å¾…å‘é€æ•°æ®çš„ Goroutineï¼Œç«‹åˆ»è®¾ç½®å¤„ç†å™¨çš„ <code>runnext</code> å±æ€§ï¼Œä½†æ˜¯å¹¶ä¸ä¼šç«‹åˆ»è§¦å‘è°ƒåº¦</li>
<li>å½“ç¼“å†²åŒºä¸­ä¸å­˜åœ¨æ•°æ®å¹¶ä¸”ä¹Ÿä¸å­˜åœ¨æ•°æ®çš„å‘é€è€…æ—¶ï¼›</li>
</ol>
<h2 id=å…³é—­ç®¡é“><a href=#å…³é—­ç®¡é“ class=h-anchor>ğŸ”—</a>å…³é—­ç®¡é“</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>closechan</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>) {
    <span style=color:#75715e>// å…³é—­ä¸€ä¸ª nil channelï¼Œpanic
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
        panic(<span style=color:#a6e22e>plainError</span>(<span style=color:#e6db74>&#34;close of nil channel&#34;</span>))
    }

    <span style=color:#75715e>// ä¸Šé”
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
    <span style=color:#75715e>// å¦‚æœ channel å·²ç»å…³é—­
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>closed</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
        <span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
        <span style=color:#75715e>// panic
</span><span style=color:#75715e></span>        panic(<span style=color:#a6e22e>plainError</span>(<span style=color:#e6db74>&#34;close of closed channel&#34;</span>))
    }

    <span style=color:#75715e>// â€¦â€¦â€¦â€¦
</span><span style=color:#75715e></span>
    <span style=color:#75715e>// ä¿®æ”¹å…³é—­çŠ¶æ€
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>closed</span> = <span style=color:#ae81ff>1</span>

    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>glist</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>

    <span style=color:#75715e>// å°† channel æ‰€æœ‰ç­‰å¾…æ¥æ”¶é˜Ÿåˆ—çš„é‡Œ sudog é‡Šæ”¾
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> {
        <span style=color:#75715e>// ä»æ¥æ”¶é˜Ÿåˆ—é‡Œå‡ºé˜Ÿä¸€ä¸ª sudog
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>sg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvq</span>.<span style=color:#a6e22e>dequeue</span>()
        <span style=color:#75715e>// å‡ºé˜Ÿå®Œæ¯•ï¼Œè·³å‡ºå¾ªç¯
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
            <span style=color:#66d9ef>break</span>
        }

        <span style=color:#75715e>// å¦‚æœ elem ä¸ä¸ºç©ºï¼Œè¯´æ˜æ­¤ receiver æœªå¿½ç•¥æ¥æ”¶æ•°æ®
</span><span style=color:#75715e></span>        <span style=color:#75715e>// ç»™å®ƒèµ‹ä¸€ä¸ªç›¸åº”ç±»å‹çš„é›¶å€¼
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
            <span style=color:#a6e22e>typedmemclr</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span>)
            <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span> = <span style=color:#66d9ef>nil</span>
        }
        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>releasetime</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
            <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>releasetime</span> = <span style=color:#a6e22e>cputicks</span>()
        }
        <span style=color:#75715e>// å–å‡º goroutine
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>g</span>
        <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#66d9ef>nil</span>
        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>raceenabled</span> {
            <span style=color:#a6e22e>raceacquireg</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>c</span>))
        }
        <span style=color:#75715e>// ç›¸è¿ï¼Œå½¢æˆé“¾è¡¨
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>schedlink</span>.<span style=color:#a6e22e>set</span>(<span style=color:#a6e22e>glist</span>)
        <span style=color:#a6e22e>glist</span> = <span style=color:#a6e22e>gp</span>
    }

    <span style=color:#75715e>// å°† channel ç­‰å¾…å‘é€é˜Ÿåˆ—é‡Œçš„ sudog é‡Šæ”¾
</span><span style=color:#75715e></span>    <span style=color:#75715e>// å¦‚æœå­˜åœ¨ï¼Œè¿™äº› goroutine å°†ä¼š panic
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> {
        <span style=color:#75715e>// ä»å‘é€é˜Ÿåˆ—é‡Œå‡ºé˜Ÿä¸€ä¸ª sudog
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>sg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendq</span>.<span style=color:#a6e22e>dequeue</span>()
        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
            <span style=color:#66d9ef>break</span>
        }

        <span style=color:#75715e>// å‘é€è€…ä¼š panic
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span> = <span style=color:#66d9ef>nil</span>
        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>releasetime</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
            <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>releasetime</span> = <span style=color:#a6e22e>cputicks</span>()
        }
        <span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>g</span>
        <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#66d9ef>nil</span>
        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>raceenabled</span> {
            <span style=color:#a6e22e>raceacquireg</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>c</span>))
        }
        <span style=color:#75715e>// å½¢æˆé“¾è¡¨
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>schedlink</span>.<span style=color:#a6e22e>set</span>(<span style=color:#a6e22e>glist</span>)
        <span style=color:#a6e22e>glist</span> = <span style=color:#a6e22e>gp</span>
    }
    <span style=color:#75715e>// è§£é”
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)

    <span style=color:#75715e>// Ready all Gs now that we&#39;ve dropped the channel lock.
</span><span style=color:#75715e></span>    <span style=color:#75715e>// éå†é“¾è¡¨
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>glist</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#75715e>// å–æœ€åä¸€ä¸ª
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>glist</span>
        <span style=color:#75715e>// å‘å‰èµ°ä¸€æ­¥ï¼Œä¸‹ä¸€ä¸ªå”¤é†’çš„ g
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>glist</span> = <span style=color:#a6e22e>glist</span>.<span style=color:#a6e22e>schedlink</span>.<span style=color:#a6e22e>ptr</span>()
        <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>schedlink</span> = <span style=color:#ae81ff>0</span>
        <span style=color:#75715e>// å”¤é†’ç›¸åº” goroutine
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>goready</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#ae81ff>3</span>)
    }
}
</code></pre></div><p>close é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå¯¹äºä¸€ä¸ª channelï¼Œrecvq å’Œ sendq ä¸­åˆ†åˆ«ä¿å­˜äº†é˜»å¡çš„å‘é€è€…å’Œæ¥æ”¶è€…ã€‚å…³é—­ channel åï¼Œå¯¹äºç­‰å¾…æ¥æ”¶è€…è€Œè¨€ï¼Œä¼šæ”¶åˆ°ä¸€ä¸ªç›¸åº”ç±»å‹çš„é›¶å€¼ã€‚å¯¹äºç­‰å¾…å‘é€è€…ï¼Œä¼šç›´æ¥ panicã€‚æ‰€ä»¥ï¼Œåœ¨ä¸äº†è§£ channel è¿˜æœ‰æ²¡æœ‰æ¥æ”¶è€…çš„æƒ…å†µä¸‹ï¼Œä¸èƒ½è´¸ç„¶å…³é—­ channelã€‚</p>
<p>close å‡½æ•°å…ˆä¸Šä¸€æŠŠå¤§é”ï¼Œæ¥ç€æŠŠæ‰€æœ‰æŒ‚åœ¨è¿™ä¸ª channel ä¸Šçš„ sender å’Œ receiver å…¨éƒ½è¿æˆä¸€ä¸ª sudog é“¾è¡¨ï¼Œå†è§£é”ã€‚æœ€åï¼Œå†å°†æ‰€æœ‰çš„ sudog å…¨éƒ½å”¤é†’ã€‚</p>
<p>å”¤é†’ä¹‹åï¼Œè¯¥å¹²å˜›å¹²å˜›ã€‚sender ä¼šç»§ç»­æ‰§è¡Œ chansend å‡½æ•°é‡Œ goparkunlock å‡½æ•°ä¹‹åçš„ä»£ç ï¼Œå¾ˆä¸å¹¸ï¼Œæ£€æµ‹åˆ° channel å·²ç»å…³é—­äº†ï¼Œpanicã€‚receiver åˆ™æ¯”è¾ƒå¹¸è¿ï¼Œè¿›è¡Œä¸€äº›æ‰«å°¾å·¥ä½œåï¼Œè¿”å›ã€‚è¿™é‡Œï¼Œselected è¿”å› trueï¼Œè€Œè¿”å›å€¼ received åˆ™è¦æ ¹æ® channel æ˜¯å¦å…³é—­ï¼Œè¿”å›ä¸åŒçš„å€¼ã€‚å¦‚æœ channel å…³é—­ï¼Œreceived ä¸º falseï¼Œå¦åˆ™ä¸º trueã€‚è¿™æˆ‘ä»¬åˆ†æçš„è¿™ç§æƒ…å†µä¸‹ï¼Œreceived è¿”å› falseã€‚</p>
<p>ä¸»è¦å·¥ä½œå°±æ˜¯å°† <code>recvq</code> å’Œ <code>sendq</code> ä¸¤ä¸ªé˜Ÿåˆ—ä¸­çš„æ•°æ®åŠ å…¥åˆ° Goroutine åˆ—è¡¨ <code>gList</code> ä¸­ï¼Œä¸æ­¤åŒæ—¶è¯¥å‡½æ•°ä¼šæ¸…é™¤æ‰€æœ‰ <code>sudog</code> ä¸Šæœªè¢«å¤„ç†çš„å…ƒç´ ã€‚</p>
<p>è¯¥å‡½æ•°åœ¨æœ€åä¼šä¸ºæ‰€æœ‰è¢«é˜»å¡çš„ Goroutine è°ƒç”¨ <a href=https://github.com/golang/go/blob/64c22b70bf00e15615bb17c29f808b55bc339682/src/runtime/proc.go#L313><code>runtime.goready</code></a> è§¦å‘è°ƒåº¦ã€‚</p>
<h2 id=æ€»ç»“><a href=#æ€»ç»“ class=h-anchor>ğŸ”—</a>æ€»ç»“</h2>
<h3 id=1æ— ç¼“å­˜channelæ€»æ˜¯é‡‡ç”¨ç›´æ¥å‘é€æ¥æ”¶çš„å½¢å¼>1ã€æ— ç¼“å­˜channel<strong>æ€»æ˜¯</strong>é‡‡ç”¨<strong>ç›´æ¥å‘é€æ¥æ”¶</strong><a href=#1æ— ç¼“å­˜channelæ€»æ˜¯é‡‡ç”¨ç›´æ¥å‘é€æ¥æ”¶çš„å½¢å¼ class=h-anchor>ğŸ”—</a>çš„å½¢å¼ï¼š</h3>
<ol>
<li>å­˜åœ¨è¯»ç­‰å¾…çš„æ¥æ”¶è€…ï¼Œå‘é€è€…ç›´æ¥å°†æ•°æ®ä»è‡ªå·±æ ˆæ‹·è´åˆ°æ¥æ”¶è€…çš„æ ˆä¸Š</li>
<li>å­˜åœ¨å†™ç­‰å¾…çš„å‘é€è€…ï¼Œæ¥æ”¶è€…ç›´æ¥ä»sudogä¸­æ¥æ”¶æ•°æ®</li>
</ol>
<h3 id=2ç®€å•ä¸æ€§èƒ½å–èˆ><a href=#2ç®€å•ä¸æ€§èƒ½å–èˆ class=h-anchor>ğŸ”—</a>2ã€ç®€å•ä¸æ€§èƒ½å–èˆ:</h3>
<p>å¤æ‚äº†ä»£ç ï¼Œä½†æ˜¯æé«˜äº†æ€§èƒ½</p>
<h1 id=select>select</h1>
<h2 id=ä¸¤å¤§ç‰¹ç‚¹><a href=#ä¸¤å¤§ç‰¹ç‚¹ class=h-anchor>ğŸ”—</a>ä¸¤å¤§ç‰¹ç‚¹ï¼š</h2>
<ol>
<li><code>select</code> èƒ½åœ¨ Channel ä¸Šè¿›è¡Œéé˜»å¡çš„æ”¶å‘æ“ä½œï¼›</li>
<li><code>select</code> åœ¨é‡åˆ°å¤šä¸ª Channel åŒæ—¶å“åº”æ—¶ä¼š<strong>éšæœº</strong>æŒ‘é€‰ <code>case</code> æ‰§è¡Œï¼›</li>
</ol>
<h2 id=æ•°æ®ç»“æ„-1><a href=#æ•°æ®ç»“æ„-1 class=h-anchor>ğŸ”—</a>æ•°æ®ç»“æ„</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>//select æ§åˆ¶ç»“æ„ä¸­çš„ caseä½¿ç”¨ runtime.scase ç»“æ„ä½“æ¥è¡¨ç¤º
</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>scase</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>c</span>           <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>
	<span style=color:#a6e22e>elem</span>        <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span> <span style=color:#75715e>//æ¥æ”¶æˆ–è€…å‘é€æ•°æ®çš„å˜é‡åœ°å€
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>kind</span>        <span style=color:#66d9ef>uint16</span>
	<span style=color:#a6e22e>pc</span>          <span style=color:#66d9ef>uintptr</span>
	<span style=color:#a6e22e>releasetime</span> <span style=color:#66d9ef>int64</span>
}
<span style=color:#75715e>//kind è¡¨ç¤º runtime.scase çš„ç§ç±»ï¼Œæ€»å…±åŒ…å«ä»¥ä¸‹å››ç§ï¼š
</span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> (
	<span style=color:#a6e22e>caseNil</span> = <span style=color:#66d9ef>iota</span>
	<span style=color:#a6e22e>caseRecv</span>
	<span style=color:#a6e22e>caseSend</span>
	<span style=color:#a6e22e>caseDefault</span>
)
</code></pre></div><h2 id=åŸç†><a href=#åŸç† class=h-anchor>ğŸ”—</a>åŸç†</h2>
<p><code>select</code> è¯­å¥åœ¨ç¼–è¯‘æœŸé—´ä¼šè¢«è½¬æ¢æˆ <code>OSELECT</code> èŠ‚ç‚¹ã€‚æ¯ä¸€ä¸ª <code>OSELECT</code> èŠ‚ç‚¹éƒ½ä¼šæŒæœ‰ä¸€ç»„ <code>OCASE</code> èŠ‚ç‚¹ï¼Œå¦‚æœ <code>OCASE</code> çš„æ‰§è¡Œæ¡ä»¶æ˜¯ç©ºï¼Œé‚£å°±æ„å‘³ç€è¿™æ˜¯ä¸€ä¸ª <code>default</code> èŠ‚ç‚¹:</p>
<p><img src=https://img.draveness.me/2020-01-18-15793463657473-golang-oselect-and-ocases.png alt=golang-oselect-and-ocases></p>
<p>â€‹ <strong>å›¾ 5-7 OSELECT å’Œå¤šä¸ª OCASE</strong></p>
<p>å››ä¸­æƒ…å†µï¼š</p>
<ol>
<li><code>select</code> ä¸å­˜åœ¨ä»»ä½•çš„ <code>case</code>ï¼›</li>
<li><code>select</code> åªå­˜åœ¨ä¸€ä¸ª <code>case</code>ï¼›</li>
<li><code>select</code> å­˜åœ¨ä¸¤ä¸ª <code>case</code>ï¼Œå…¶ä¸­ä¸€ä¸ª <code>case</code> æ˜¯ <code>default</code>ï¼›</li>
<li><code>select</code> å­˜åœ¨å¤šä¸ª <code>case</code>ï¼›</li>
</ol>
<h3 id=ç›´æ¥é˜»å¡><a href=#ç›´æ¥é˜»å¡ class=h-anchor>ğŸ”—</a>ç›´æ¥é˜»å¡</h3>
<p><code>select</code> ä¸å­˜åœ¨ä»»ä½•çš„ <code>case</code></p>
<p><code>select {}</code> çš„ç©ºè¯­å¥è½¬æ¢æˆè°ƒç”¨ <a href=https://github.com/golang/go/blob/c112289ee4141ebc31db50328c355b01278b987b/src/runtime/select.go#L104-L106><code>runtime.block</code></a> å‡½æ•°ï¼š</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>block</span>() {
	<span style=color:#a6e22e>gopark</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>waitReasonSelectNoCases</span>, <span style=color:#a6e22e>traceEvGoStop</span>, <span style=color:#ae81ff>1</span>)
}
</code></pre></div><p><a href=https://github.com/golang/go/blob/c112289ee4141ebc31db50328c355b01278b987b/src/runtime/select.go#L104-L106><code>runtime.block</code></a> å‡½æ•°çš„å®ç°éå¸¸ç®€å•ï¼Œå®ƒä¼šè°ƒç”¨ runtime.gopark è®©å‡ºå½“å‰ Goroutine å¯¹å¤„ç†å™¨çš„ä½¿ç”¨æƒï¼Œä¼ å…¥çš„ç­‰å¾…åŸå› æ˜¯ <code>waitReasonSelectNoCases</code>ã€‚</p>
<p>ç®€å•æ€»ç»“ä¸€ä¸‹ï¼Œç©ºçš„ <code>select</code> è¯­å¥ä¼šç›´æ¥é˜»å¡å½“å‰çš„ Goroutineï¼Œå¯¼è‡´ Goroutine è¿›å…¥<strong>æ— æ³•è¢«å”¤é†’çš„æ°¸ä¹…ä¼‘çœ çŠ¶æ€</strong>ã€‚</p>
<h3 id=å•ä¸€ç®¡é“><a href=#å•ä¸€ç®¡é“ class=h-anchor>ğŸ”—</a>å•ä¸€ç®¡é“</h3>
<p><code>select</code> åªå­˜åœ¨ä¸€ä¸ª <code>case</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// æ”¹å†™å‰
</span><span style=color:#75715e></span><span style=color:#66d9ef>select</span> {
<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ch</span>: <span style=color:#75715e>// case ch &lt;- v
</span><span style=color:#75715e></span>    <span style=color:#f92672>...</span>    
}

<span style=color:#75715e>// æ”¹å†™å
</span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ch</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
    <span style=color:#a6e22e>block</span>()
}
<span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ch</span> <span style=color:#75715e>// case ch &lt;- v
</span><span style=color:#75715e></span><span style=color:#f92672>...</span>
</code></pre></div><p><a href=https://github.com/golang/go/blob/c729116332ffb66a21dd587e3ee003cb8d0b16fe/src/cmd/compile/internal/gc/select.go#L108-L370><code>cmd/compile/internal/gc.walkselectcases</code></a> åœ¨å¤„ç†å•æ“ä½œ <code>select</code> è¯­å¥æ—¶ï¼Œä¼šæ ¹æ® Channel çš„æ”¶å‘æƒ…å†µç”Ÿæˆä¸åŒçš„è¯­å¥ã€‚å½“ <code>case</code> ä¸­çš„ Channel æ˜¯ç©ºæŒ‡é’ˆæ—¶ï¼Œå°±ä¼šç›´æ¥æŒ‚èµ·å½“å‰ Goroutine å¹¶æ°¸ä¹…ä¼‘çœ ã€‚</p>
<p>å¦‚æœchannelä¸æ˜¯ç©ºæŒ‡é’ˆï¼Œé˜»å¡ç­‰å¾…è¢«å”¤é†’</p>
<h3 id=éé˜»å¡æ“ä½œ><a href=#éé˜»å¡æ“ä½œ class=h-anchor>ğŸ”—</a>éé˜»å¡æ“ä½œ</h3>
<p><code>select</code> å­˜åœ¨ä¸¤ä¸ª <code>case</code>ï¼Œå…¶ä¸­ä¸€ä¸ª <code>case</code> æ˜¯ <code>default</code></p>
<h4 id=å‘é€><a href=#å‘é€ class=h-anchor>ğŸ”—</a>å‘é€</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>select</span> {
<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>i</span>:
    <span style=color:#f92672>...</span>
<span style=color:#66d9ef>default</span>:
    <span style=color:#f92672>...</span>
}

<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>selectnbsend</span>(<span style=color:#a6e22e>ch</span>, <span style=color:#a6e22e>i</span>) {
    <span style=color:#f92672>...</span>
} <span style=color:#66d9ef>else</span> {
    <span style=color:#f92672>...</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>selectnbsend</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>, <span style=color:#a6e22e>elem</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) (<span style=color:#a6e22e>selected</span> <span style=color:#66d9ef>bool</span>) {
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>chansend</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>elem</span>, <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>getcallerpc</span>())
}
<span style=color:#75715e>//ä¸å­˜åœ¨æ¥æ”¶æ–¹æˆ–è€…ç¼“å†²åŒºç©ºé—´ä¸è¶³éƒ½ä¸ä¼šé˜»å¡å½“å‰ Goroutine è€Œæ˜¯ä¼šç›´æ¥è¿”å›
</span></code></pre></div><h4 id=æ¥æ”¶><a href=#æ¥æ”¶ class=h-anchor>ğŸ”—</a>æ¥æ”¶</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// æ”¹å†™å‰
</span><span style=color:#75715e></span><span style=color:#66d9ef>select</span> {
<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>v</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>ch</span>: <span style=color:#75715e>// case v, ok &lt;- ch:
</span><span style=color:#75715e></span>    <span style=color:#f92672>......</span>
<span style=color:#66d9ef>default</span>:
    <span style=color:#f92672>......</span>
}

<span style=color:#75715e>// æ”¹å†™å
</span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>selectnbrecv</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>ch</span>) { <span style=color:#75715e>// if selectnbrecv2(&amp;v, &amp;ok, ch) {
</span><span style=color:#75715e></span>    <span style=color:#f92672>...</span>
} <span style=color:#66d9ef>else</span> {
    <span style=color:#f92672>...</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>selectnbrecv</span>(<span style=color:#a6e22e>elem</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>, <span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>) (<span style=color:#a6e22e>selected</span> <span style=color:#66d9ef>bool</span>) {
	<span style=color:#a6e22e>selected</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>chanrecv</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>elem</span>, <span style=color:#66d9ef>false</span>)
	<span style=color:#66d9ef>return</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>selectnbrecv2</span>(<span style=color:#a6e22e>elem</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>, <span style=color:#a6e22e>received</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>) (<span style=color:#a6e22e>selected</span> <span style=color:#66d9ef>bool</span>) {
	<span style=color:#a6e22e>selected</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>received</span> = <span style=color:#a6e22e>chanrecv</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>elem</span>, <span style=color:#66d9ef>false</span>)
	<span style=color:#66d9ef>return</span>
}
</code></pre></div><h3 id=å¤„ç†æµç¨‹><a href=#å¤„ç†æµç¨‹ class=h-anchor>ğŸ”—</a>å¤„ç†æµç¨‹</h3>
<p>åœ¨é»˜è®¤çš„æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¼šä½¿ç”¨å¦‚ä¸‹çš„æµç¨‹å¤„ç† <code>select</code> è¯­å¥ï¼š</p>
<ol>
<li>
<p>å°†æ‰€æœ‰çš„ <code>case</code> è½¬æ¢æˆåŒ…å« Channel ä»¥åŠç±»å‹ç­‰ä¿¡æ¯çš„ <a href=https://github.com/golang/go/blob/d1969015b4ac29be4f518b94817d3f525380639d/src/runtime/select.go#L28-L34><code>runtime.scase</code></a> ç»“æ„ä½“ï¼›</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>//select æ§åˆ¶ç»“æ„ä¸­çš„ caseä½¿ç”¨ runtime.scase ç»“æ„ä½“æ¥è¡¨ç¤º
</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>scase</span> <span style=color:#66d9ef>struct</span> {
<span style=color:#a6e22e>c</span>           <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>
<span style=color:#a6e22e>elem</span>        <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span> <span style=color:#75715e>//æ¥æ”¶æˆ–è€…å‘é€æ•°æ®çš„å˜é‡åœ°å€
</span><span style=color:#75715e></span><span style=color:#a6e22e>kind</span>        <span style=color:#66d9ef>uint16</span>
<span style=color:#a6e22e>pc</span>          <span style=color:#66d9ef>uintptr</span>
<span style=color:#a6e22e>releasetime</span> <span style=color:#66d9ef>int64</span>
}
</code></pre></div></li>
<li>
<p>è°ƒç”¨è¿è¡Œæ—¶å‡½æ•° <a href=https://github.com/golang/go/blob/d1969015b4ac29be4f518b94817d3f525380639d/src/runtime/select.go#L118-L497><code>runtime.selectgo</code></a> ä»å¤šä¸ªå‡†å¤‡å°±ç»ªçš„ Channel ä¸­é€‰æ‹©ä¸€ä¸ªå¯æ‰§è¡Œçš„ <a href=https://github.com/golang/go/blob/d1969015b4ac29be4f518b94817d3f525380639d/src/runtime/select.go#L28-L34><code>runtime.scase</code></a> ç»“æ„ä½“ï¼›</p>
</li>
<li>
<p>é€šè¿‡ <code>for</code> å¾ªç¯ç”Ÿæˆä¸€ç»„ <code>if</code> è¯­å¥ï¼Œåœ¨è¯­å¥ä¸­åˆ¤æ–­è‡ªå·±æ˜¯ä¸æ˜¯è¢«é€‰ä¸­çš„ <code>case</code></p>
</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>selv</span> <span style=color:#f92672>:=</span> [<span style=color:#ae81ff>3</span>]<span style=color:#a6e22e>scase</span>{}
<span style=color:#a6e22e>order</span> <span style=color:#f92672>:=</span> [<span style=color:#ae81ff>6</span>]<span style=color:#66d9ef>uint16</span>
<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>cas</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>cases</span> {
    <span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>scase</span>{}
    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>kind</span> = <span style=color:#f92672>...</span>
    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elem</span> = <span style=color:#f92672>...</span>
    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>c</span> = <span style=color:#f92672>...</span>
}
<span style=color:#a6e22e>chosen</span>, <span style=color:#a6e22e>revcOK</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>selectgo</span>(<span style=color:#a6e22e>selv</span>, <span style=color:#a6e22e>order</span>, <span style=color:#ae81ff>3</span>)
<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>chosen</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
    <span style=color:#f92672>...</span>
    <span style=color:#66d9ef>break</span>
}
<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>chosen</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> {
    <span style=color:#f92672>...</span>
    <span style=color:#66d9ef>break</span>
}
<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>chosen</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span> {
    <span style=color:#f92672>...</span>
    <span style=color:#66d9ef>break</span>
}
</code></pre></div><p><a href=https://github.com/golang/go/blob/d1969015b4ac29be4f518b94817d3f525380639d/src/runtime/select.go#L118-L497><code>runtime.selectgo</code></a> è¿™é‡Œåˆ†ä¸¤éƒ¨åˆ†åˆ†æå®ƒçš„æ‰§è¡Œè¿‡ç¨‹ï¼š</p>
<ol>
<li>æ‰§è¡Œä¸€äº›å¿…è¦çš„åˆå§‹åŒ–æ“ä½œå¹¶ç¡®å®š <code>case</code> çš„å¤„ç†é¡ºåºï¼›</li>
<li>å¤„ç†æµç¨‹
åœ¨é»˜è®¤çš„æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¼šä½¿ç”¨å¦‚ä¸‹çš„æµç¨‹å¤„ç† select è¯­å¥ï¼šåœ¨å¾ªç¯ä¸­æ ¹æ® <code>case</code> çš„ç±»å‹åšå‡ºä¸åŒçš„å¤„ç†ï¼›</li>
</ol>
<h4 id=åˆå§‹åŒ–><a href=#åˆå§‹åŒ– class=h-anchor>ğŸ”—</a>åˆå§‹åŒ–</h4>
<p><a href=https://github.com/golang/go/blob/d1969015b4ac29be4f518b94817d3f525380639d/src/runtime/select.go#L118-L497><code>runtime.selectgo</code></a> å‡½æ•°é¦–å…ˆä¼šè¿›è¡Œæ‰§è¡Œå¿…è¦çš„åˆå§‹åŒ–æ“ä½œå¹¶å†³å®šå¤„ç† <code>case</code> çš„ä¸¤ä¸ªé¡ºåº â€” è½®è¯¢é¡ºåº <code>pollOrder</code> å’ŒåŠ é”é¡ºåº <code>lockOrder</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>selectgo</span>(<span style=color:#a6e22e>cas0</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>scase</span>, <span style=color:#a6e22e>order0</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>uint16</span>, <span style=color:#a6e22e>ncases</span> <span style=color:#66d9ef>int</span>) (<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>bool</span>) {
	<span style=color:#a6e22e>cas1</span> <span style=color:#f92672>:=</span> (<span style=color:#f92672>*</span>[<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>16</span>]<span style=color:#a6e22e>scase</span>)(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>cas0</span>))
	<span style=color:#a6e22e>order1</span> <span style=color:#f92672>:=</span> (<span style=color:#f92672>*</span>[<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>17</span>]<span style=color:#66d9ef>uint16</span>)(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>order0</span>))
	
	<span style=color:#a6e22e>scases</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cas1</span>[:<span style=color:#a6e22e>ncases</span>:<span style=color:#a6e22e>ncases</span>]
	<span style=color:#a6e22e>pollorder</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>order1</span>[:<span style=color:#a6e22e>ncases</span>:<span style=color:#a6e22e>ncases</span>]
	<span style=color:#a6e22e>lockorder</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>order1</span>[<span style=color:#a6e22e>ncases</span>:][:<span style=color:#a6e22e>ncases</span>:<span style=color:#a6e22e>ncases</span>]
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>scases</span> {
		<span style=color:#a6e22e>cas</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>scases</span>[<span style=color:#a6e22e>i</span>]
	}

	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>ncases</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
		<span style=color:#a6e22e>j</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fastrandn</span>(uint32(<span style=color:#a6e22e>i</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>))
		<span style=color:#a6e22e>pollorder</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>pollorder</span>[<span style=color:#a6e22e>j</span>]
		<span style=color:#a6e22e>pollorder</span>[<span style=color:#a6e22e>j</span>] = uint16(<span style=color:#a6e22e>i</span>)
	}

	<span style=color:#75715e>// æ ¹æ® Channel çš„åœ°å€æ’åºç¡®å®šåŠ é”é¡ºåº
</span><span style=color:#75715e></span>	<span style=color:#f92672>...</span>
	<span style=color:#a6e22e>sellock</span>(<span style=color:#a6e22e>scases</span>, <span style=color:#a6e22e>lockorder</span>)
  <span style=color:#960050;background-color:#1e0010>ã€‚ã€‚ã€‚</span>
}
</code></pre></div><p>è½®è¯¢é¡ºåº <code>pollOrder</code> å’ŒåŠ é”é¡ºåº <code>lockOrder</code> åˆ†åˆ«æ˜¯é€šè¿‡ä»¥ä¸‹çš„æ–¹å¼ç¡®è®¤çš„ï¼š</p>
<ul>
<li>è½®è¯¢é¡ºåºï¼šé€šè¿‡ runtime.fastrandnå‡½æ•°å¼•å…¥éšæœºæ€§ï¼›</li>
<li>åŠ é”é¡ºåºï¼šæŒ‰ç…§ Channel çš„åœ°å€æ’åºåç¡®å®šåŠ é”é¡ºåºï¼›</li>
</ul>
<p>éšæœºçš„è½®è¯¢é¡ºåºå¯ä»¥é¿å… Channel çš„é¥¥é¥¿é—®é¢˜ï¼Œä¿è¯å…¬å¹³æ€§ï¼›è€Œæ ¹æ® Channel çš„åœ°å€é¡ºåºç¡®å®šåŠ é”é¡ºåºèƒ½å¤Ÿé¿å…æ­»é”çš„å‘ç”Ÿã€‚è¿™æ®µä»£ç æœ€åè°ƒç”¨çš„ runtime.sellock å‡½æ•°ä¼šæŒ‰ç…§ä¹‹å‰ç”Ÿæˆçš„åŠ é”é¡ºåºé”å®š <code>select</code> è¯­å¥ä¸­åŒ…å«æ‰€æœ‰çš„ Channelã€‚</p>
<h4 id=ä¸»å¾ªç¯><a href=#ä¸»å¾ªç¯ class=h-anchor>ğŸ”—</a>ä¸»å¾ªç¯</h4>
<p>å½“æˆ‘ä»¬ä¸º <code>select</code> è¯­å¥é”å®šäº†æ‰€æœ‰ Channel ä¹‹åå°±ä¼šè¿›å…¥ <a href=https://github.com/golang/go/blob/d1969015b4ac29be4f518b94817d3f525380639d/src/runtime/select.go#L118-L497><code>runtime.selectgo</code></a> å‡½æ•°çš„ä¸»å¾ªç¯ï¼Œå®ƒä¼šåˆ†ä¸‰ä¸ªé˜¶æ®µæŸ¥æ‰¾æˆ–è€…ç­‰å¾…æŸä¸ª Channel å‡†å¤‡å°±ç»ªï¼š</p>
<ol>
<li>æŸ¥æ‰¾æ˜¯å¦å·²ç»å­˜åœ¨å‡†å¤‡å°±ç»ªçš„ Channelï¼Œå³å¯ä»¥æ‰§è¡Œæ”¶å‘æ“ä½œï¼›</li>
<li>å°†å½“å‰ Goroutine åŠ å…¥ Channel å¯¹åº”çš„æ”¶å‘é˜Ÿåˆ—ä¸Šå¹¶ç­‰å¾…å…¶ä»– Goroutine çš„å”¤é†’ï¼›</li>
<li>å½“å‰ Goroutine è¢«å”¤é†’ä¹‹åæ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„ Channel å¹¶è¿›è¡Œå¤„ç†ï¼›</li>
</ol>
<p>ç¬¬ä¸€é˜¶æ®µï¼šï¼ˆæ”¶å‘ï¼‰</p>
<p><img src=https://img.draveness.me/2020-01-18-15793463657488-golang-runtime-selectgo.png alt=golang-runtime-selectgo></p>
<p>â€‹ <strong>è¿è¡Œæ—¶ selectgo å‡½æ•°</strong></p>
<p>ç¬¬äºŒé˜¶æ®µï¼šï¼ˆé˜»å¡ï¼‰</p>
<p>é™¤äº†å°†å½“å‰ Goroutine å¯¹åº”çš„ <a href=https://github.com/golang/go/blob/cfe3cd903f018dec3cb5997d53b1744df4e53909/src/runtime/runtime2.go#L342-L368><code>runtime.sudog</code></a> ç»“æ„ä½“åŠ å…¥é˜Ÿåˆ—ä¹‹å¤–ï¼Œè¿™äº› <a href=https://github.com/golang/go/blob/cfe3cd903f018dec3cb5997d53b1744df4e53909/src/runtime/runtime2.go#L342-L368><code>runtime.sudog</code></a> ç»“æ„ä½“éƒ½ä¼šè¢«ä¸²æˆé“¾è¡¨é™„ç€åœ¨ Goroutine ä¸Šã€‚åœ¨å…¥é˜Ÿä¹‹åä¼šè°ƒç”¨ <a href=https://github.com/golang/go/blob/c112289ee4141ebc31db50328c355b01278b987b/src/runtime/proc.go#L287-L305><code>runtime.gopark</code></a> å‡½æ•°æŒ‚èµ·å½“å‰ Goroutine ç­‰å¾…è°ƒåº¦å™¨çš„å”¤é†’ã€‚</p>
<p><img src=https://img.draveness.me/2020-01-19-15794018429558-Golang-Select-Waiting.png alt=Golang-Select-Waiting></p>
<p>â€‹ <strong>Goroutine ä¸Šç­‰å¾…æ”¶å‘çš„ sudog é“¾è¡¨</strong></p>
<p>ç¬¬ä¸‰é˜¶æ®µï¼šï¼ˆå”¤é†’ï¼‰</p>
<p>ç­‰åˆ° <code>select</code> ä¸­çš„ä¸€äº› Channel å‡†å¤‡å°±ç»ªä¹‹åï¼Œå½“å‰ Goroutine å°±ä¼šè¢«è°ƒåº¦å™¨å”¤é†’ã€‚è¿™æ—¶ä¼šç»§ç»­æ‰§è¡Œ <a href=https://github.com/golang/go/blob/d1969015b4ac29be4f518b94817d3f525380639d/src/runtime/select.go#L118-L497><code>runtime.selectgo</code></a> å‡½æ•°çš„ç¬¬ä¸‰é˜¶æ®µï¼Œä» <a href=https://github.com/golang/go/blob/cfe3cd903f018dec3cb5997d53b1744df4e53909/src/runtime/runtime2.go#L342-L368><code>runtime.sudog</code></a> ç»“æ„ä½“ä¸­è·å–æ•°æ®</p>
<p>ç¬¬ä¸‰æ¬¡éå†å…¨éƒ¨ <code>case</code> æ—¶ï¼Œæˆ‘ä»¬ä¼šå…ˆè·å–å½“å‰ Goroutine æ¥æ”¶åˆ°çš„å‚æ•° <code>sudog</code> ç»“æ„ï¼Œæˆ‘ä»¬ä¼šä¾æ¬¡å¯¹æ¯”æ‰€æœ‰ <code>case</code> å¯¹åº”çš„ <code>sudog</code> ç»“æ„æ‰¾åˆ°è¢«å”¤é†’çš„ <code>case</code>ï¼Œè·å–è¯¥ <code>case</code> å¯¹åº”çš„ç´¢å¼•å¹¶è¿”å›ã€‚</p>
<p>ç”±äºå½“å‰çš„ <code>select</code> ç»“æ„æ‰¾åˆ°äº†ä¸€ä¸ª <code>case</code> æ‰§è¡Œï¼Œé‚£ä¹ˆå‰©ä¸‹ <code>case</code> ä¸­æ²¡æœ‰è¢«ç”¨åˆ°çš„ <code>sudog</code> å°±ä¼šè¢«å¿½ç•¥å¹¶ä¸”é‡Šæ”¾æ‰ã€‚ä¸ºäº†ä¸å½±å“ Channel çš„æ­£å¸¸ä½¿ç”¨ï¼Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦å°†è¿™äº›åºŸå¼ƒçš„ <code>sudog</code> ä» Channel ä¸­å‡ºé˜Ÿã€‚</p>
<h2 id=æ€»ç»“-1><a href=#æ€»ç»“-1 class=h-anchor>ğŸ”—</a>æ€»ç»“</h2>
<p>æˆ‘ä»¬ç®€å•æ€»ç»“ä¸€ä¸‹ <code>select</code> ç»“æ„çš„æ‰§è¡Œè¿‡ç¨‹ä¸å®ç°åŸç†ï¼Œé¦–å…ˆåœ¨ç¼–è¯‘æœŸé—´ï¼ŒGo è¯­è¨€ä¼šå¯¹ <code>select</code> è¯­å¥è¿›è¡Œä¼˜åŒ–ï¼Œå®ƒä¼šæ ¹æ® <code>select</code> ä¸­ <code>case</code> çš„ä¸åŒé€‰æ‹©ä¸åŒçš„ä¼˜åŒ–è·¯å¾„ï¼š</p>
<ol>
<li>
<p>ç©ºçš„ <code>select</code> è¯­å¥ä¼šè¢«è½¬æ¢æˆ <a href=https://github.com/golang/go/blob/c112289ee4141ebc31db50328c355b01278b987b/src/runtime/select.go#L104-L106><code>runtime.block</code></a> å‡½æ•°çš„è°ƒç”¨ï¼Œç›´æ¥æŒ‚èµ·å½“å‰ Goroutineï¼›</p>
</li>
<li>
<p>å¦‚æœselectè¯­å¥ä¸­åªåŒ…å«ä¸€ä¸ªcaseï¼Œå°±ä¼šè¢«è½¬æ¢æˆ if ch == nil { block }; n;</p>
<p>è¡¨è¾¾å¼ï¼›</p>
<ul>
<li>é¦–å…ˆåˆ¤æ–­æ“ä½œçš„ Channel æ˜¯ä¸æ˜¯ç©ºçš„ï¼›</li>
<li>ç„¶åæ‰§è¡Œ <code>case</code> ç»“æ„ä¸­çš„å†…å®¹ï¼›</li>
</ul>
</li>
<li>
<p>å¦‚æœ <code>select</code> è¯­å¥ä¸­åªåŒ…å«ä¸¤ä¸ª <code>case</code> å¹¶ä¸”å…¶ä¸­ä¸€ä¸ªæ˜¯ <code>default</code>ï¼Œé‚£ä¹ˆä¼šä½¿ç”¨ <a href=https://github.com/golang/go/blob/d1969015b4ac29be4f518b94817d3f525380639d/src/runtime/chan.go#L683-L686><code>runtime.selectnbrecv</code></a> å’Œ <a href=https://github.com/golang/go/blob/d1969015b4ac29be4f518b94817d3f525380639d/src/runtime/chan.go#L662-L664><code>runtime.selectnbsend</code></a> éé˜»å¡åœ°æ‰§è¡Œæ”¶å‘æ“ä½œï¼›</p>
</li>
<li>
<p>åœ¨é»˜è®¤æƒ…å†µä¸‹ä¼šé€šè¿‡ <a href=https://github.com/golang/go/blob/d1969015b4ac29be4f518b94817d3f525380639d/src/runtime/select.go#L118-L497><code>runtime.selectgo</code></a> å‡½æ•°è·å–æ‰§è¡Œ <code>case</code> çš„ç´¢å¼•ï¼Œå¹¶é€šè¿‡å¤šä¸ª <code>if</code> è¯­å¥æ‰§è¡Œå¯¹åº” <code>case</code> ä¸­çš„ä»£ç ï¼›</p>
</li>
</ol>
<p>åœ¨ç¼–è¯‘å™¨å·²ç»å¯¹ <code>select</code> è¯­å¥è¿›è¡Œä¼˜åŒ–ä¹‹åï¼ŒGo è¯­è¨€ä¼šåœ¨è¿è¡Œæ—¶æ‰§è¡Œç¼–è¯‘æœŸé—´å±•å¼€çš„ <a href=https://github.com/golang/go/blob/d1969015b4ac29be4f518b94817d3f525380639d/src/runtime/select.go#L118-L497><code>runtime.selectgo</code></a> å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šæŒ‰ç…§ä»¥ä¸‹çš„æµç¨‹æ‰§è¡Œï¼š</p>
<ol>
<li>éšæœºç”Ÿæˆä¸€ä¸ªéå†çš„è½®è¯¢é¡ºåº <code>pollOrder</code> å¹¶æ ¹æ® Channel åœ°å€ç”Ÿæˆé”å®šé¡ºåº <code>lockOrder</code>ï¼›</li>
<li>æ ¹æ® pollOrder éå†æ‰€æœ‰çš„caseæŸ¥çœ‹æ˜¯å¦æœ‰å¯ä»¥ç«‹åˆ»å¤„ç†çš„ Channelï¼›
<ol>
<li>å¦‚æœå­˜åœ¨å°±ç›´æ¥è·å– <code>case</code> å¯¹åº”çš„ç´¢å¼•å¹¶è¿”å›ï¼›</li>
<li>å¦‚æœä¸å­˜åœ¨å°±ä¼šåˆ›å»º <a href=https://github.com/golang/go/blob/cfe3cd903f018dec3cb5997d53b1744df4e53909/src/runtime/runtime2.go#L342-L368><code>runtime.sudog</code></a> ç»“æ„ä½“ï¼Œå°†å½“å‰ Goroutine åŠ å…¥åˆ°æ‰€æœ‰ç›¸å…³ Channel çš„æ”¶å‘é˜Ÿåˆ—ï¼Œå¹¶è°ƒç”¨ <a href=https://github.com/golang/go/blob/c112289ee4141ebc31db50328c355b01278b987b/src/runtime/proc.go#L287-L305><code>runtime.gopark</code></a> æŒ‚èµ·å½“å‰ Goroutine ç­‰å¾…è°ƒåº¦å™¨çš„å”¤é†’ï¼›</li>
</ol>
</li>
<li>å½“è°ƒåº¦å™¨å”¤é†’å½“å‰ Goroutine æ—¶å°±ä¼šå†æ¬¡æŒ‰ç…§ <code>lockOrder</code> éå†æ‰€æœ‰çš„ <code>case</code>ï¼Œä»ä¸­æŸ¥æ‰¾éœ€è¦è¢«å¤„ç†çš„ <a href=https://github.com/golang/go/blob/cfe3cd903f018dec3cb5997d53b1744df4e53909/src/runtime/runtime2.go#L342-L368><code>runtime.sudog</code></a> ç»“æ„å¯¹åº”çš„ç´¢å¼•ï¼›</li>
</ol>
<p><code>select</code> å…³é”®å­—æ˜¯ Go è¯­è¨€ç‰¹æœ‰çš„æ§åˆ¶ç»“æ„ï¼Œå®ƒçš„å®ç°åŸç†æ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦ç¼–è¯‘å™¨å’Œè¿è¡Œæ—¶å‡½æ•°çš„é€šåŠ›åˆä½œ</p>
<h2 id=ä¸ªäººç†è§£><a href=#ä¸ªäººç†è§£ class=h-anchor>ğŸ”—</a>ä¸ªäººç†è§£</h2>
<p>selectè¯­å¥ä¸­åŠ å…¥defaultå…³é”®å­—ï¼Œä½¿å¾—selectæ”¯æŒéé˜»å¡æ”¶å‘ï¼Œè°ƒç”¨å¦‚ä¸‹ä¸¤ä¸ªæ”¶å‘å‡½æ•°ï¼š</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>selectnbsend</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>, <span style=color:#a6e22e>elem</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) (<span style=color:#a6e22e>selected</span> <span style=color:#66d9ef>bool</span>) {
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>chansend</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>elem</span>, <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>getcallerpc</span>())
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>selectnbrecv</span>(<span style=color:#a6e22e>elem</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>, <span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>) (<span style=color:#a6e22e>selected</span> <span style=color:#66d9ef>bool</span>) {
	<span style=color:#a6e22e>selected</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>chanrecv</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>elem</span>, <span style=color:#66d9ef>false</span>)
	<span style=color:#66d9ef>return</span>
}
</code></pre></div><h1 id=ç›¸å…³é—®é¢˜>ç›¸å…³é—®é¢˜</h1>
<h2 id=goçš„ä¸¤ç§å¹¶å‘å½¢å¼><a href=#goçš„ä¸¤ç§å¹¶å‘å½¢å¼ class=h-anchor>ğŸ”—</a>Goçš„ä¸¤ç§å¹¶å‘å½¢å¼</h2>
<p>1ã€å¤šçº¿ç¨‹å…±äº«å†…å­˜</p>
<p>å…¶å®å°±æ˜¯Javaæˆ–è€…C++ç­‰è¯­è¨€ä¸­çš„å¤šçº¿ç¨‹å¼€å‘</p>
<p>2ã€CSPå¹¶å‘æ¨¡å‹</p>
<p>Goè¯­è¨€ç‰¹æœ‰çš„</p>
<h2 id=ä»€ä¹ˆæ˜¯csp><a href=#ä»€ä¹ˆæ˜¯csp class=h-anchor>ğŸ”—</a>ä»€ä¹ˆæ˜¯CSPï¼Ÿ</h2>
<p>ä¸è¦ä»¥å…±äº«å†…å­˜çš„æ–¹å¼æ¥é€šä¿¡ï¼Œç›¸åï¼Œè¦é€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜ã€‚</p>
<p>CSP æ˜¯ Communicating Sequential Process çš„ç®€ç§°ï¼Œä¸­æ–‡å¯ä»¥å«åšé€šä¿¡é¡ºåºè¿›ç¨‹ï¼Œæ˜¯ä¸€ç§å¹¶å‘ç¼–ç¨‹æ¨¡å‹ï¼Œç”± <a href=https://en.wikipedia.org/wiki/Tony_Hoare>Tony Hoare</a> äº 1977 å¹´æå‡ºã€‚ç®€å•æ¥è¯´ï¼ŒCSP æ¨¡å‹ç”±å¹¶å‘æ‰§è¡Œçš„å®ä½“ï¼ˆçº¿ç¨‹æˆ–è€…è¿›ç¨‹ï¼‰æ‰€ç»„æˆï¼Œå®ä½“ä¹‹é—´é€šè¿‡å‘é€æ¶ˆæ¯è¿›è¡Œé€šä¿¡ï¼Œè¿™é‡Œå‘é€æ¶ˆæ¯æ—¶ä½¿ç”¨çš„å°±æ˜¯é€šé“ï¼Œæˆ–è€…å« channelã€‚CSP æ¨¡å‹çš„å…³é”®æ˜¯å…³æ³¨ channelï¼Œè€Œä¸å…³æ³¨å‘é€æ¶ˆæ¯çš„å®ä½“ã€‚Go è¯­è¨€å®ç°äº† CSP éƒ¨åˆ†ç†è®ºã€‚</p>
<p>Goçš„CSPå¹¶å‘æ¨¡å‹ï¼Œæ˜¯é€šè¿‡goroutineå’Œchannelæ¥å®ç°çš„ã€‚</p>
<p>goroutine æ˜¯Goè¯­è¨€ä¸­å¹¶å‘çš„æ‰§è¡Œå•ä½ã€‚</p>
<p>channelæ˜¯Goè¯­è¨€ä¸­å„ä¸ªå¹¶å‘ç»“æ„ä½“(goroutine)ä¹‹å‰çš„é€šä¿¡æœºåˆ¶ã€‚ é€šä¿—çš„è®²ï¼Œå°±æ˜¯å„ä¸ªgoroutineä¹‹é—´é€šä¿¡çš„â€ç®¡é“â€œï¼Œæœ‰ç‚¹ç±»ä¼¼äºLinuxä¸­çš„ç®¡é“ã€‚</p>
<p><strong>Channel</strong></p>
<blockquote>
<p>Golangä¸­ä½¿ç”¨ CSPä¸­ channel è¿™ä¸ªæ¦‚å¿µã€‚channel æ˜¯è¢«å•ç‹¬åˆ›å»ºå¹¶ä¸”å¯ä»¥åœ¨è¿›ç¨‹ä¹‹é—´ä¼ é€’ï¼Œå®ƒçš„é€šä¿¡æ¨¡å¼ç±»ä¼¼äº boss-worker æ¨¡å¼çš„ï¼Œä¸€ä¸ªå®ä½“é€šè¿‡å°†æ¶ˆæ¯å‘é€åˆ°channel ä¸­ï¼Œç„¶ååˆç›‘å¬è¿™ä¸ª channel çš„å®ä½“å¤„ç†ï¼Œä¸¤ä¸ªå®ä½“ä¹‹é—´æ˜¯åŒ¿åçš„ï¼Œè¿™ä¸ªå°±å®ç°å®ä½“ä¸­é—´çš„è§£è€¦ï¼Œå…¶ä¸­ channel æ˜¯åŒæ­¥çš„ä¸€ä¸ªæ¶ˆæ¯è¢«å‘é€åˆ° channel ä¸­ï¼Œæœ€ç»ˆæ˜¯ä¸€å®šè¦è¢«å¦å¤–çš„å®ä½“æ¶ˆè´¹æ‰çš„ã€‚</p>
</blockquote>
<p><strong>Goroutine</strong></p>
<blockquote>
<p>Goroutine æ˜¯å®é™…å¹¶å‘æ‰§è¡Œçš„å®ä½“ï¼Œå®ƒåº•å±‚æ˜¯ä½¿ç”¨åç¨‹(coroutine)å®ç°å¹¶å‘ï¼Œcoroutineæ˜¯ä¸€ç§è¿è¡Œåœ¨ç”¨æˆ·æ€çš„ç”¨æˆ·çº¿ç¨‹ï¼Œç±»ä¼¼äº greenthreadï¼Œgoåº•å±‚é€‰æ‹©ä½¿ç”¨coroutineçš„å‡ºå‘ç‚¹æ˜¯å› ä¸ºï¼Œå®ƒå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<p>ç”¨æˆ·ç©ºé—´ é¿å…äº†å†…æ ¸æ€å’Œç”¨æˆ·æ€çš„åˆ‡æ¢å¯¼è‡´çš„æˆæœ¬</p>
<p>å¯ä»¥ç”±è¯­è¨€å’Œæ¡†æ¶å±‚è¿›è¡Œè°ƒåº¦</p>
<p>æ›´å°çš„æ ˆç©ºé—´å…è®¸åˆ›å»ºå¤§é‡çš„å®ä¾‹</p>
<p>ç”¨æˆ·ç©ºé—´çº¿ç¨‹çš„è°ƒåº¦ä¸æ˜¯ç”±æ“ä½œç³»ç»Ÿæ¥å®Œæˆçš„ï¼Œåƒåœ¨java 1.3ä¸­ä½¿ç”¨çš„greenthreadçš„æ˜¯ç”±JVMç»Ÿä¸€è°ƒåº¦çš„(åjavaå·²ç»æ”¹ä¸ºå†…æ ¸çº¿ç¨‹)ï¼Œè¿˜æœ‰åœ¨rubyä¸­çš„fiber(åŠåç¨‹) æ˜¯éœ€è¦åœ¨é‡æ–°ä¸­è‡ªå·±è¿›è¡Œè°ƒåº¦çš„ï¼Œè€Œgoroutineæ˜¯åœ¨golangå±‚é¢æä¾›äº†è°ƒåº¦å™¨ï¼Œå¹¶ä¸”å¯¹ç½‘ç»œIOåº“è¿›è¡Œäº†å°è£…ï¼Œå±è”½äº†å¤æ‚çš„ç»†èŠ‚ï¼Œå¯¹å¤–æä¾›ç»Ÿä¸€çš„è¯­æ³•å…³é”®å­—æ”¯æŒï¼Œç®€åŒ–äº†å¹¶å‘ç¨‹åºç¼–å†™çš„æˆæœ¬ã€‚</p>
</blockquote>
<h2 id=è¿›ç¨‹çº¿ç¨‹å’Œåç¨‹çš„åŒºåˆ«><a href=#è¿›ç¨‹çº¿ç¨‹å’Œåç¨‹çš„åŒºåˆ« class=h-anchor>ğŸ”—</a>è¿›ç¨‹ã€çº¿ç¨‹å’Œåç¨‹çš„åŒºåˆ«ï¼Ÿ</h2>
<p>è¿›ç¨‹æ‹¥æœ‰ä»£ç å’Œæ‰“å¼€çš„æ–‡ä»¶èµ„æºã€æ•°æ®èµ„æºã€ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ã€‚</p>
<p>çº¿ç¨‹ä»å±äºè¿›ç¨‹ï¼Œæ˜¯ç¨‹åºçš„å®é™…æ‰§è¡Œè€…ã€‚ä¸€ä¸ªè¿›ç¨‹è‡³å°‘åŒ…å«ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥æœ‰æ›´å¤šçš„å­çº¿ç¨‹ã€‚çº¿ç¨‹æ‹¥æœ‰è‡ªå·±çš„æ ˆç©ºé—´ã€‚</p>
<p>åŒä¸€è¿›ç¨‹çš„çº¿ç¨‹å…±äº«æœ¬è¿›ç¨‹çš„åœ°å€ç©ºé—´å’Œèµ„æºï¼Œè€Œè¿›ç¨‹ä¹‹é—´çš„åœ°å€ç©ºé—´å’Œèµ„æºæ˜¯ç›¸äº’ç‹¬ç«‹çš„</p>
<p><strong>å¯¹æ“ä½œç³»ç»Ÿæ¥è¯´ï¼Œçº¿ç¨‹æ˜¯æœ€å°çš„æ‰§è¡Œå•å…ƒï¼Œè¿›ç¨‹æ˜¯æœ€å°çš„èµ„æºç®¡ç†å•å…ƒã€‚</strong></p>
<p>æ— è®ºè¿›ç¨‹è¿˜æ˜¯çº¿ç¨‹ï¼Œéƒ½æ˜¯ç”±æ“ä½œç³»ç»Ÿæ‰€ç®¡ç†çš„ã€‚</p>
<p><img src=https://upload-images.jianshu.io/upload_images/1604966-2a3a741343c0d16c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/724/format/webp alt=img></p>
<p>çº¿ç¨‹çš„äº”ç§çŠ¶æ€ï¼š</p>
<p><img src=https://upload-images.jianshu.io/upload_images/1604966-0e8f701ed9a0eb20.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/836/format/webp alt=img></p>
<p>æ­£å¦‚ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ‹¥æœ‰å¤šä¸ªçº¿ç¨‹ä¸€æ ·ï¼Œä¸€ä¸ªçº¿ç¨‹ä¹Ÿå¯ä»¥æ‹¥æœ‰å¤šä¸ªåç¨‹ã€‚åç¨‹çš„è°ƒåº¦å®Œå…¨ç”±ç”¨æˆ·æ§åˆ¶ã€‚åç¨‹æ‹¥æœ‰è‡ªå·±çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆã€‚åç¨‹è°ƒåº¦åˆ‡æ¢æ—¶ï¼Œå°†å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆä¿å­˜åˆ°å…¶ä»–åœ°æ–¹ï¼Œåœ¨åˆ‡å›æ¥çš„æ—¶å€™ï¼Œæ¢å¤å…ˆå‰ä¿å­˜çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆï¼Œç›´æ¥æ“ä½œæ ˆåˆ™åŸºæœ¬æ²¡æœ‰å†…æ ¸åˆ‡æ¢çš„å¼€é”€ï¼Œå¯ä»¥ä¸åŠ é”çš„è®¿é—®å…¨å±€å˜é‡ï¼Œæ‰€ä»¥ä¸Šä¸‹æ–‡çš„åˆ‡æ¢éå¸¸å¿«ã€‚<em><strong>åç¨‹ä¸çº¿ç¨‹ä¸»è¦åŒºåˆ«æ˜¯å®ƒå°†ä¸å†è¢«å†…æ ¸è°ƒåº¦ï¼Œè€Œæ˜¯äº¤ç»™äº†ç¨‹åºè‡ªå·±è€Œçº¿ç¨‹æ˜¯å°†è‡ªå·±äº¤ç»™å†…æ ¸è°ƒåº¦ï¼Œæ‰€ä»¥ä¹Ÿä¸éš¾ç†è§£golangä¸­è°ƒåº¦å™¨çš„å­˜åœ¨ã€‚</strong></em><img src=https://upload-images.jianshu.io/upload_images/1604966-1e45c5e197f5b28c.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/724/format/webp alt=img></p>
<p>æœ€é‡è¦çš„æ˜¯ï¼Œ<strong>åç¨‹ä¸æ˜¯è¢«æ“ä½œç³»ç»Ÿå†…æ ¸æ‰€ç®¡ç†ï¼Œè€Œå®Œå…¨æ˜¯ç”±ç¨‹åºæ‰€æ§åˆ¶ï¼ˆä¹Ÿå°±æ˜¯åœ¨ç”¨æˆ·æ€æ‰§è¡Œï¼‰</strong>ã€‚</p>
<p>è¿™æ ·å¸¦æ¥çš„å¥½å¤„å°±æ˜¯æ€§èƒ½å¾—åˆ°äº†å¾ˆå¤§çš„æå‡ï¼Œä¸ä¼šåƒçº¿ç¨‹åˆ‡æ¢é‚£æ ·æ¶ˆè€—èµ„æºã€‚</p>
<h3 id=è¿›ç¨‹ä¸çº¿ç¨‹çš„åŒºåˆ«æ€»ç»“><a href=#è¿›ç¨‹ä¸çº¿ç¨‹çš„åŒºåˆ«æ€»ç»“ class=h-anchor>ğŸ”—</a>è¿›ç¨‹ä¸çº¿ç¨‹çš„åŒºåˆ«æ€»ç»“</h3>
<p>çº¿ç¨‹å…·æœ‰è®¸å¤šä¼ ç»Ÿè¿›ç¨‹æ‰€å…·æœ‰çš„ç‰¹å¾ï¼Œæ•…åˆç§°ä¸ºè½»å‹è¿›ç¨‹(Lightâ€”Weight Process)æˆ–è¿›ç¨‹å…ƒï¼›è€ŒæŠŠä¼ ç»Ÿçš„è¿›ç¨‹ç§°ä¸ºé‡å‹è¿›ç¨‹(Heavyâ€”Weight Process)ï¼Œå®ƒç›¸å½“äºåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„ä»»åŠ¡ã€‚åœ¨å¼•å…¥äº†çº¿ç¨‹çš„æ“ä½œç³»ç»Ÿä¸­ï¼Œé€šå¸¸ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰è‹¥å¹²ä¸ªçº¿ç¨‹ï¼Œè‡³å°‘åŒ…å«ä¸€ä¸ªçº¿ç¨‹ã€‚</p>
<p><strong>æ ¹æœ¬åŒºåˆ«</strong>ï¼šè¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿèµ„æºåˆ†é…çš„åŸºæœ¬å•ä½ï¼Œè€Œçº¿ç¨‹æ˜¯å¤„ç†å™¨ä»»åŠ¡è°ƒåº¦å’Œæ‰§è¡Œçš„åŸºæœ¬å•ä½</p>
<p><strong>èµ„æºå¼€é”€</strong>ï¼šæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„ä»£ç å’Œæ•°æ®ç©ºé—´ï¼ˆç¨‹åºä¸Šä¸‹æ–‡ï¼‰ï¼Œç¨‹åºä¹‹é—´çš„åˆ‡æ¢ä¼šæœ‰è¾ƒå¤§çš„å¼€é”€ï¼›çº¿ç¨‹å¯ä»¥çœ‹åšè½»é‡çº§çš„è¿›ç¨‹ï¼ŒåŒä¸€ç±»çº¿ç¨‹å…±äº«ä»£ç å’Œæ•°æ®ç©ºé—´ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„è¿è¡Œæ ˆå’Œç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰ï¼Œçº¿ç¨‹ä¹‹é—´åˆ‡æ¢çš„å¼€é”€å°ã€‚</p>
<p><strong>åŒ…å«å…³ç³»</strong>ï¼šå¦‚æœä¸€ä¸ªè¿›ç¨‹å†…æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œåˆ™æ‰§è¡Œè¿‡ç¨‹ä¸æ˜¯ä¸€æ¡çº¿çš„ï¼Œè€Œæ˜¯å¤šæ¡çº¿ï¼ˆçº¿ç¨‹ï¼‰å…±åŒå®Œæˆçš„ï¼›çº¿ç¨‹æ˜¯è¿›ç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥çº¿ç¨‹ä¹Ÿè¢«ç§°ä¸ºè½»æƒè¿›ç¨‹æˆ–è€…è½»é‡çº§è¿›ç¨‹ã€‚</p>
<p><strong>å†…å­˜åˆ†é…</strong>ï¼šåŒä¸€è¿›ç¨‹çš„çº¿ç¨‹å…±äº«æœ¬è¿›ç¨‹çš„åœ°å€ç©ºé—´å’Œèµ„æºï¼Œè€Œè¿›ç¨‹ä¹‹é—´çš„åœ°å€ç©ºé—´å’Œèµ„æºæ˜¯ç›¸äº’ç‹¬ç«‹çš„</p>
<p><strong>å½±å“å…³ç³»</strong>ï¼šä¸€ä¸ªè¿›ç¨‹å´©æºƒåï¼Œåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ä¸ä¼šå¯¹å…¶ä»–è¿›ç¨‹äº§ç”Ÿå½±å“ï¼Œä½†æ˜¯ä¸€ä¸ªçº¿ç¨‹å´©æºƒæ•´ä¸ªè¿›ç¨‹éƒ½æ­»æ‰ã€‚æ‰€ä»¥å¤šè¿›ç¨‹è¦æ¯”å¤šçº¿ç¨‹å¥å£®ã€‚</p>
<p><strong>æ‰§è¡Œè¿‡ç¨‹</strong>ï¼šæ¯ä¸ªç‹¬ç«‹çš„è¿›ç¨‹æœ‰ç¨‹åºè¿è¡Œçš„å…¥å£ã€é¡ºåºæ‰§è¡Œåºåˆ—å’Œç¨‹åºå‡ºå£ã€‚ä½†æ˜¯çº¿ç¨‹ä¸èƒ½ç‹¬ç«‹æ‰§è¡Œï¼Œå¿…é¡»ä¾å­˜åœ¨åº”ç”¨ç¨‹åºä¸­ï¼Œç”±åº”ç”¨ç¨‹åºæä¾›å¤šä¸ªçº¿ç¨‹æ‰§è¡Œæ§åˆ¶ï¼Œä¸¤è€…å‡å¯å¹¶å‘æ‰§è¡Œ</p>
<h2 id=ä»ä¸€ä¸ªå…³é—­çš„-channel-ä»ç„¶èƒ½è¯»å‡ºæ•°æ®å—><a href=#ä»ä¸€ä¸ªå…³é—­çš„-channel-ä»ç„¶èƒ½è¯»å‡ºæ•°æ®å— class=h-anchor>ğŸ”—</a>ä»ä¸€ä¸ªå…³é—­çš„ channel ä»ç„¶èƒ½è¯»å‡ºæ•°æ®å—ï¼Ÿ</h2>
<p>ä»ä¸€ä¸ªæœ‰ç¼“å†²çš„ channel é‡Œè¯»æ•°æ®ï¼Œå½“ channel è¢«å…³é—­ï¼Œä¾ç„¶èƒ½è¯»å‡ºæœ‰æ•ˆå€¼ã€‚åªæœ‰å½“è¿”å›çš„ ok ä¸º false æ—¶ï¼Œè¯»å‡ºçš„æ•°æ®æ‰æ˜¯æ— æ•ˆçš„ã€‚</p>
<h2 id=channelçš„ä½¿ç”¨åœºæ™¯><a href=#channelçš„ä½¿ç”¨åœºæ™¯ class=h-anchor>ğŸ”—</a>channelçš„ä½¿ç”¨åœºæ™¯ï¼Ÿ</h2>
<h3 id=é€€å‡ºä¿¡å·><a href=#é€€å‡ºä¿¡å· class=h-anchor>ğŸ”—</a>é€€å‡ºä¿¡å·</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>task</span>)<span style=color:#a6e22e>run</span>{
  <span style=color:#75715e>//ä»»åŠ¡ä¸»å¾ªç¯
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>for</span>{
    <span style=color:#f92672>...</span>
		<span style=color:#66d9ef>select</span> {
    <span style=color:#75715e>//æ”¶åˆ°å…³é—­ä¿¡å·ï¼Œé€€å‡ºå¾ªç¯
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>closeCh</span>:
			<span style=color:#66d9ef>break</span> <span style=color:#a6e22e>Loop</span>
		<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>timer</span>.<span style=color:#a6e22e>C</span>:
		}
	}
  <span style=color:#75715e>//å…³é—­å‰å‡†å¤‡å·¥ä½œï¼Œå¦‚è®¾ç½®ä¸‹ä»»åŠ¡çŠ¶æ€
</span><span style=color:#75715e></span>  <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>setError</span>(<span style=color:#a6e22e>vpsapi</span>.<span style=color:#a6e22e>TaskStatus_FINISHED</span>, <span style=color:#66d9ef>nil</span>)
  <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;task ended&#34;</span>)
  close(<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>doneCh</span>)
}

<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>task</span>)close()<span style=color:#66d9ef>error</span>{
  <span style=color:#f92672>...</span>
  <span style=color:#75715e>//æˆ‘è¦å…³é—­è¯¥ä»»åŠ¡äº†
</span><span style=color:#75715e></span>  close(<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>closeCh</span>)
  <span style=color:#a6e22e>timer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTimer</span>(<span style=color:#ae81ff>20</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>timer</span>.<span style=color:#a6e22e>Stop</span>()
	<span style=color:#66d9ef>select</span> {
  <span style=color:#75715e>//ç­‰å¾…ä»»åŠ¡å…³é—­å®Œæˆ
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>doneCh</span>:
  <span style=color:#75715e>//è¶…æ—¶é€€å‡º
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>timer</span>.<span style=color:#a6e22e>C</span>:
		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Warnf</span>(<span style=color:#e6db74>&#34;loop not exit after 20 seconds&#34;</span>)
	}
}
</code></pre></div><h3 id=æ•°æ®ä¼ è¾“><a href=#æ•°æ®ä¼ è¾“ class=h-anchor>ğŸ”—</a>æ•°æ®ä¼ è¾“</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>//tracket--&gt;analyser
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>TrackExecutor</span>) <span style=color:#a6e22e>writeResult</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>TrackContext</span>, <span style=color:#a6e22e>out</span> <span style=color:#a6e22e>motanalyser</span>.<span style=color:#a6e22e>Tracklet</span>) <span style=color:#66d9ef>bool</span> {
	<span style=color:#a6e22e>written</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span>
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>offline</span> {
		<span style=color:#a6e22e>timer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTimer</span>(<span style=color:#a6e22e>pcommon</span>.<span style=color:#a6e22e>DefaultOfflineChannelWriteTimeout</span>)
		<span style=color:#66d9ef>select</span> {
		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>outputCh</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>out</span>:
			<span style=color:#a6e22e>written</span> = <span style=color:#66d9ef>true</span>
		<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>timer</span>.<span style=color:#a6e22e>C</span>:
		}
		<span style=color:#a6e22e>timer</span>.<span style=color:#a6e22e>Stop</span>()
	} <span style=color:#66d9ef>else</span> {
		<span style=color:#66d9ef>select</span> {
    <span style=color:#75715e>//å‘æœ‰ç¼“å†²channelå†™å…¥ç»“æœ
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>outputCh</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>out</span>:
			<span style=color:#a6e22e>written</span> = <span style=color:#66d9ef>true</span>
		<span style=color:#66d9ef>default</span>:
		}
	}
}
</code></pre></div><h3 id=è§£è€¦ç”Ÿäº§æ–¹å’Œæ¶ˆè´¹æ–¹><a href=#è§£è€¦ç”Ÿäº§æ–¹å’Œæ¶ˆè´¹æ–¹ class=h-anchor>ğŸ”—</a>è§£è€¦ç”Ÿäº§æ–¹å’Œæ¶ˆè´¹æ–¹</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#a6e22e>taskCh</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>int</span>, <span style=color:#ae81ff>100</span>)
    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>worker</span>(<span style=color:#a6e22e>taskCh</span>)

    <span style=color:#75715e>// å¡ä»»åŠ¡
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>10</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
        <span style=color:#a6e22e>taskCh</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>i</span>
    }

    <span style=color:#75715e>// ç­‰å¾… 1 å°æ—¶ 
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>select</span> {
    <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>After</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Hour</span>):
    }
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>worker</span>(<span style=color:#a6e22e>taskCh</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>int</span>) {
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>N</span> = <span style=color:#ae81ff>5</span>
    <span style=color:#75715e>// å¯åŠ¨ 5 ä¸ªå·¥ä½œåç¨‹
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>N</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>id</span> <span style=color:#66d9ef>int</span>) {
            <span style=color:#66d9ef>for</span> {
                <span style=color:#a6e22e>task</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>taskCh</span>
                <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;finish task: %d by worker %d\n&#34;</span>, <span style=color:#a6e22e>task</span>, <span style=color:#a6e22e>id</span>)
                <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
            }
        }(<span style=color:#a6e22e>i</span>)
    }
}
<span style=color:#75715e>//5 ä¸ªå·¥ä½œåç¨‹åœ¨ä¸æ–­åœ°ä»å·¥ä½œé˜Ÿåˆ—é‡Œå–ä»»åŠ¡ï¼Œç”Ÿäº§æ–¹åªç®¡å¾€ channel å‘é€ä»»åŠ¡å³å¯ï¼Œè§£è€¦ç”Ÿäº§æ–¹å’Œæ¶ˆè´¹æ–¹ã€‚
</span></code></pre></div><h3 id=æ§åˆ¶å¹¶å‘æ•°><a href=#æ§åˆ¶å¹¶å‘æ•° class=h-anchor>ğŸ”—</a>æ§åˆ¶å¹¶å‘æ•°</h3>
<p>æœ‰æ—¶éœ€è¦å®šæ—¶æ‰§è¡Œå‡ ç™¾ä¸ªä»»åŠ¡ï¼Œä¾‹å¦‚æ¯å¤©å®šæ—¶æŒ‰åŸå¸‚æ¥æ‰§è¡Œä¸€äº›ç¦»çº¿è®¡ç®—çš„ä»»åŠ¡ã€‚ä½†æ˜¯å¹¶å‘æ•°åˆä¸èƒ½å¤ªé«˜ï¼Œå› ä¸ºä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¾èµ–ç¬¬ä¸‰æ–¹çš„ä¸€äº›èµ„æºï¼Œå¯¹è¯·æ±‚çš„é€Ÿç‡æœ‰é™åˆ¶ã€‚è¿™æ—¶å°±å¯ä»¥é€šè¿‡ channel æ¥æ§åˆ¶å¹¶å‘æ•°ã€‚</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>limit</span> = make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>int</span>, <span style=color:#ae81ff>3</span>)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#75715e>// â€¦â€¦â€¦â€¦
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>w</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>work</span> {
        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
            <span style=color:#a6e22e>limit</span> <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>1</span>
            <span style=color:#a6e22e>w</span>()
            <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>limit</span>
        }()
    }
    <span style=color:#75715e>// â€¦â€¦â€¦â€¦
</span><span style=color:#75715e></span>}
<span style=color:#75715e>//æ§åˆ¶åŒæ—¶è¿è¡Œçš„ goroutine æ•°æœ€å¤š3ä¸ªã€‚
</span><span style=color:#75715e>//è¿˜æœ‰ä¸€ç‚¹è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœ w() å‘ç”Ÿ panicï¼Œé‚£â€œè®¸å¯è¯â€å¯èƒ½å°±è¿˜ä¸å›å»äº†ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ defer æ¥ä¿è¯ã€‚
</span></code></pre></div><h2 id=å¦‚ä½•ä¼˜é›…çš„å…³é—­channel><a href=#å¦‚ä½•ä¼˜é›…çš„å…³é—­channel class=h-anchor>ğŸ”—</a>å¦‚ä½•ä¼˜é›…çš„å…³é—­channelï¼Ÿ</h2>
<blockquote>
<p>don&rsquo;t close a channel from the receiver side and don&rsquo;t close a channel if the channel has multiple concurrent senders.</p>
<p>don&rsquo;t close (or send values to) closed channels.</p>
</blockquote>
<p>æ ¹æ® sender å’Œ receiver çš„ä¸ªæ•°ï¼Œåˆ†ä¸‹é¢å‡ ç§æƒ…å†µï¼š</p>
<ol>
<li>
<p>ä¸€ä¸ª senderï¼Œä¸€ä¸ª receiver</p>
</li>
<li>
<p>ä¸€ä¸ª senderï¼Œ M ä¸ª receiver</p>
<p>ç›´æ¥ä»senderç«¯å…³é—­</p>
<p>ä»¥ä¸‹ä¸¤ç§ä¸è°ƒç”¨closeä¸»åŠ¨å…³é—­channelï¼Œç­‰å¾…GCæ¥å…³é—­</p>
</li>
<li>
<p>N ä¸ª senderï¼Œä¸€ä¸ª reciver</p>
<p>ä¸€ä¸ªä¼ é€’å…³é—­ä¿¡å·çš„ channelï¼Œreceiver é€šè¿‡ä¿¡å· channel ä¸‹è¾¾å…³é—­æ•°æ® channel æŒ‡ä»¤ã€‚senders ç›‘å¬åˆ°å…³é—­ä¿¡å·åï¼Œåœæ­¢å‘é€æ•°æ®</p>
</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Seed</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>UnixNano</span>())

    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Max</span> = <span style=color:#ae81ff>100000</span>
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>NumSenders</span> = <span style=color:#ae81ff>1000</span>

    <span style=color:#a6e22e>dataCh</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>int</span>, <span style=color:#ae81ff>100</span>)
    <span style=color:#a6e22e>stopCh</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{})

    <span style=color:#75715e>// senders
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>NumSenders</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
            <span style=color:#66d9ef>for</span> {
                <span style=color:#66d9ef>select</span> {
                <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>stopCh</span>:
                    <span style=color:#66d9ef>return</span>
                <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>dataCh</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Intn</span>(<span style=color:#a6e22e>Max</span>):
                }
            }
        }()
    }

    <span style=color:#75715e>// the receiver
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>value</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>dataCh</span> {
            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>value</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>Max</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
                <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;send stop signal to senders.&#34;</span>)
                close(<span style=color:#a6e22e>stopCh</span>)
                <span style=color:#66d9ef>return</span>
            }

            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>value</span>)
        }
    }()

    <span style=color:#66d9ef>select</span> {
    <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>After</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Hour</span>):
    }
}
<span style=color:#75715e>//åœ¨ Go è¯­è¨€ä¸­ï¼Œå¯¹äºä¸€ä¸ª channelï¼Œå¦‚æœæœ€ç»ˆæ²¡æœ‰ä»»ä½• goroutine å¼•ç”¨å®ƒï¼Œä¸ç®¡ channel æœ‰æ²¡æœ‰è¢«å…³é—­ï¼Œæœ€ç»ˆéƒ½ä¼šè¢« gc å›æ”¶ã€‚æ‰€ä»¥ï¼Œåœ¨è¿™ç§æƒ…å½¢ä¸‹ï¼Œæ‰€è°“çš„ä¼˜é›…åœ°å…³é—­ channel å°±æ˜¯ä¸å…³é—­ channelï¼Œè®© gc ä»£åŠ³
</span></code></pre></div><p>â€‹ 4.N ä¸ª senderï¼Œ M ä¸ª receiver</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Seed</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>UnixNano</span>())

    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Max</span> = <span style=color:#ae81ff>100000</span>
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>NumReceivers</span> = <span style=color:#ae81ff>10</span>
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>NumSenders</span> = <span style=color:#ae81ff>1000</span>

    <span style=color:#a6e22e>dataCh</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>int</span>, <span style=color:#ae81ff>100</span>)
    <span style=color:#a6e22e>stopCh</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{})

    <span style=color:#75715e>// It must be a buffered channel.
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>toStop</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>string</span>, <span style=color:#ae81ff>1</span>)

    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>stoppedBy</span> <span style=color:#66d9ef>string</span>

    <span style=color:#75715e>// moderator
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
        <span style=color:#a6e22e>stoppedBy</span> = <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>toStop</span>
        close(<span style=color:#a6e22e>stopCh</span>)
    }()

    <span style=color:#75715e>// senders
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>NumSenders</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>id</span> <span style=color:#66d9ef>string</span>) {
            <span style=color:#66d9ef>for</span> {
                <span style=color:#a6e22e>value</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Intn</span>(<span style=color:#a6e22e>Max</span>)
                <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>value</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
                    <span style=color:#66d9ef>select</span> {
                    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>toStop</span> <span style=color:#f92672>&lt;-</span> <span style=color:#e6db74>&#34;sender#&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>id</span>:
                    <span style=color:#66d9ef>default</span>:
                    }
                    <span style=color:#66d9ef>return</span>
                }

                <span style=color:#66d9ef>select</span> {
                <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>stopCh</span>:
                    <span style=color:#66d9ef>return</span>
                <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>dataCh</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>value</span>:
                }
            }
        }(<span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Itoa</span>(<span style=color:#a6e22e>i</span>))
    }

    <span style=color:#75715e>// receivers
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>NumReceivers</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>id</span> <span style=color:#66d9ef>string</span>) {
            <span style=color:#66d9ef>for</span> {
                <span style=color:#66d9ef>select</span> {
                <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>stopCh</span>:
                    <span style=color:#66d9ef>return</span>
                <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>value</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>dataCh</span>:
                    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>value</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>Max</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
                        <span style=color:#66d9ef>select</span> {
                        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>toStop</span> <span style=color:#f92672>&lt;-</span> <span style=color:#e6db74>&#34;receiver#&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>id</span>:
                        <span style=color:#66d9ef>default</span>:
                        }
                        <span style=color:#66d9ef>return</span>
                    }

                    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>value</span>)
                }
            }
        }(<span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Itoa</span>(<span style=color:#a6e22e>i</span>))
    }

    <span style=color:#66d9ef>select</span> {
    <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>After</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Hour</span>):
    }
}
<span style=color:#75715e>//ä»£ç é‡Œ toStop å°±æ˜¯ä¸­é—´äººçš„è§’è‰²ï¼Œä½¿ç”¨å®ƒæ¥æ¥æ”¶ senders å’Œ receivers å‘é€è¿‡æ¥çš„å…³é—­ dataCh è¯·æ±‚ã€‚
</span><span style=color:#75715e>//è¿™é‡Œå°† toStop å£°æ˜æˆäº†ä¸€ä¸ª ç¼“å†²å‹çš„ channelã€‚å‡è®¾ toStop å£°æ˜çš„æ˜¯ä¸€ä¸ªéç¼“å†²å‹çš„ channelï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå‘é€çš„å…³é—­ dataCh è¯·æ±‚å¯èƒ½ä¼šä¸¢å¤±ã€‚å› ä¸ºæ— è®ºæ˜¯ sender è¿˜æ˜¯ receiver éƒ½æ˜¯é€šè¿‡ select è¯­å¥æ¥å‘é€è¯·æ±‚ï¼Œå¦‚æœä¸­é—´äººæ‰€åœ¨çš„ goroutine æ²¡æœ‰å‡†å¤‡å¥½ï¼Œé‚£ select è¯­å¥å°±ä¸ä¼šé€‰ä¸­ï¼Œç›´æ¥èµ° default é€‰é¡¹ï¼Œä»€ä¹ˆä¹Ÿä¸åšã€‚è¿™æ ·ï¼Œç¬¬ä¸€ä¸ªå…³é—­ dataCh çš„è¯·æ±‚å°±ä¼šä¸¢å¤±ã€‚
</span><span style=color:#75715e>//å¦‚æœï¼Œæˆ‘ä»¬æŠŠ toStop çš„å®¹é‡å£°æ˜æˆ Num(senders) + Num(receivers)ï¼Œé‚£å‘é€ dataCh è¯·æ±‚çš„éƒ¨åˆ†å¯ä»¥æ”¹æˆæ›´ç®€æ´çš„å½¢å¼ï¼š
</span><span style=color:#75715e></span><span style=color:#f92672>...</span>
<span style=color:#a6e22e>toStop</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>NumReceivers</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>NumSenders</span>)
<span style=color:#f92672>...</span>
            <span style=color:#a6e22e>value</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Intn</span>(<span style=color:#a6e22e>Max</span>)
            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>value</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
                <span style=color:#a6e22e>toStop</span> <span style=color:#f92672>&lt;-</span> <span style=color:#e6db74>&#34;sender#&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>id</span>
                <span style=color:#66d9ef>return</span>
            }
<span style=color:#f92672>...</span>
                <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>value</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>Max</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
                    <span style=color:#a6e22e>toStop</span> <span style=color:#f92672>&lt;-</span> <span style=color:#e6db74>&#34;receiver#&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>id</span>
                    <span style=color:#66d9ef>return</span>
                }
<span style=color:#f92672>...</span>
<span style=color:#75715e>//ç›´æ¥å‘ toStop å‘é€è¯·æ±‚ï¼Œå› ä¸º toStop å®¹é‡è¶³å¤Ÿå¤§ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒé˜»å¡ï¼Œè‡ªç„¶ä¹Ÿå°±ä¸ç”¨ select è¯­å¥å†åŠ ä¸€ä¸ª default case æ¥é¿å…é˜»å¡ã€‚
</span></code></pre></div><h2 id=channel-åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå¼•èµ·èµ„æºæ³„æ¼><a href=#channel-åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå¼•èµ·èµ„æºæ³„æ¼ class=h-anchor>ğŸ”—</a>channel åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå¼•èµ·èµ„æºæ³„æ¼ï¼Ÿ</h2>
<p>æ³„æ¼çš„åŸå› æ˜¯ goroutine æ“ä½œ channel åï¼Œå¤„äºå‘é€æˆ–æ¥æ”¶é˜»å¡çŠ¶æ€ï¼Œè€Œ channel å¤„äºæ»¡æˆ–ç©ºçš„çŠ¶æ€ï¼Œä¸€ç›´å¾—ä¸åˆ°æ”¹å˜ã€‚åŒæ—¶ï¼Œåƒåœ¾å›æ”¶å™¨ä¹Ÿä¸ä¼šå›æ”¶æ­¤ç±»èµ„æºï¼Œè¿›è€Œå¯¼è‡´ gouroutine ä¼šä¸€ç›´å¤„äºç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œä¸è§å¤©æ—¥ã€‚</p>
<p>å¦å¤–ï¼Œç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯¹äºä¸€ä¸ª channelï¼Œå¦‚æœæ²¡æœ‰ä»»ä½• goroutine å¼•ç”¨äº†ï¼Œgc ä¼šå¯¹å…¶è¿›è¡Œå›æ”¶æ“ä½œï¼Œä¸ä¼šå¼•èµ·å†…å­˜æ³„æ¼ã€‚</p>
<h2 id=channel-å‘é€å’Œæ¥æ”¶å…ƒç´ çš„æœ¬è´¨æ˜¯ä»€ä¹ˆ><a href=#channel-å‘é€å’Œæ¥æ”¶å…ƒç´ çš„æœ¬è´¨æ˜¯ä»€ä¹ˆ class=h-anchor>ğŸ”—</a>channel å‘é€å’Œæ¥æ”¶å…ƒç´ çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ</h2>
<p>Channel å‘é€å’Œæ¥æ”¶å…ƒç´ çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<blockquote>
<p>All transfer of value on the go channels happens with the copy of value.</p>
</blockquote>
<p>å°±æ˜¯è¯´ channel çš„å‘é€å’Œæ¥æ”¶æ“ä½œæœ¬è´¨ä¸Šéƒ½æ˜¯ â€œå€¼çš„æ‹·è´â€ï¼Œæ— è®ºæ˜¯ä» sender goroutine çš„æ ˆåˆ° chan bufï¼Œè¿˜æ˜¯ä» chan buf åˆ° receiver goroutineï¼Œæˆ–è€…æ˜¯ç›´æ¥ä» sender goroutine åˆ° receiver goroutine</p>
<h2 id=æ“ä½œchannelçš„æƒ…å†µ><a href=#æ“ä½œchannelçš„æƒ…å†µ class=h-anchor>ğŸ”—</a>æ“ä½œchannelçš„æƒ…å†µ</h2>
<p>æ€»ç»“ä¸€ä¸‹æ“ä½œ channel çš„ç»“æœï¼š</p>
<table>
<thead>
<tr>
<th>æ“ä½œ</th>
<th>nil channel</th>
<th>closed channel</th>
<th>not nil, not closed channel</th>
</tr>
</thead>
<tbody>
<tr>
<td>close</td>
<td>panic</td>
<td>panic</td>
<td>æ­£å¸¸å…³é—­</td>
</tr>
<tr>
<td>è¯» &lt;- ch</td>
<td>é˜»å¡</td>
<td>è¯»åˆ°å¯¹åº”ç±»å‹çš„é›¶å€¼</td>
<td>é˜»å¡æˆ–æ­£å¸¸è¯»å–æ•°æ®ã€‚ç¼“å†²å‹ channel ä¸ºç©ºæˆ–éç¼“å†²å‹ channel æ²¡æœ‰ç­‰å¾…å‘é€è€…æ—¶ä¼šé˜»å¡</td>
</tr>
<tr>
<td>å†™ ch &lt;-</td>
<td>é˜»å¡</td>
<td>panic</td>
<td>é˜»å¡æˆ–æ­£å¸¸å†™å…¥æ•°æ®ã€‚éç¼“å†²å‹ channel æ²¡æœ‰ç­‰å¾…æ¥æ”¶è€…æˆ–ç¼“å†²å‹ channel buf æ»¡æ—¶ä¼šè¢«é˜»å¡</td>
</tr>
</tbody>
</table>
<p>æ€»ç»“ä¸€ä¸‹ï¼Œå‘ç”Ÿ panic çš„æƒ…å†µæœ‰ä¸‰ç§ï¼šå‘ä¸€ä¸ªå…³é—­çš„ channel è¿›è¡Œå†™æ“ä½œï¼›å…³é—­ä¸€ä¸ª nil çš„ channelï¼›é‡å¤å…³é—­ä¸€ä¸ª channelã€‚</p>
<p>è¯»ã€å†™ä¸€ä¸ª nil channel éƒ½ä¼šè¢«é˜»å¡ã€‚<strong>å¦‚æœä¸ºéé˜»å¡æ”¶å‘ï¼Œå³æ”¶å‘æ“ä½œä¸ºselectçš„ä¸€ä¸ªcaseï¼ˆä¸”å­˜åœ¨defaultåˆ†æ”¯ï¼‰ï¼Œä¸ä¼šè¢«é˜»å¡ï¼Œç›´æ¥è¿”å›ã€‚</strong></p>
<h2 id=å…³äº-channel-çš„-happened-before-æœ‰å“ªäº›><a href=#å…³äº-channel-çš„-happened-before-æœ‰å“ªäº› class=h-anchor>ğŸ”—</a>å…³äº channel çš„ happened-before æœ‰å“ªäº›?</h2>
<p>å…³äº channel çš„å‘é€ï¼ˆsendï¼‰ã€å‘é€å®Œæˆï¼ˆsend finishedï¼‰ã€æ¥æ”¶ï¼ˆreceiveï¼‰ã€æ¥æ”¶å®Œæˆï¼ˆreceive finishedï¼‰çš„ happened-before å…³ç³»å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç¬¬ n ä¸ª <code>send</code> ä¸€å®š <code>happened before</code> ç¬¬ n ä¸ª <code>receive finished</code>ï¼Œæ— è®ºæ˜¯ç¼“å†²å‹è¿˜æ˜¯éç¼“å†²å‹çš„ channelã€‚</li>
<li>å¯¹äºå®¹é‡ä¸º m çš„ç¼“å†²å‹ channelï¼Œç¬¬ n ä¸ª <code>receive</code> ä¸€å®š <code>happened before</code> ç¬¬ n+m ä¸ª <code>send finished</code>ã€‚</li>
<li>å¯¹äºéç¼“å†²å‹çš„ channelï¼Œç¬¬ n ä¸ª <code>receive</code> ä¸€å®š <code>happened before</code> ç¬¬ n ä¸ª <code>send finished</code>ã€‚</li>
<li>channel close ä¸€å®š <code>happened before</code> receiver å¾—åˆ°é€šçŸ¥ã€‚</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>done</span> = make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>)
<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>msg</span> <span style=color:#66d9ef>string</span>

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>aGoroutine</span>() {
    <span style=color:#a6e22e>msg</span> = <span style=color:#e6db74>&#34;hello, world&#34;</span>
    <span style=color:#a6e22e>done</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>true</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>aGoroutine</span>()
    <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>done</span>
    println(<span style=color:#a6e22e>msg</span>)
}
<span style=color:#75715e>//è¿™é‡Œä¾èµ–çš„ happened before å°±æ˜¯å‰é¢è®²çš„ç¬¬ä¸€æ¡ã€‚ç¬¬ä¸€ä¸ª send ä¸€å®š happened before ç¬¬ä¸€ä¸ª receive finishedï¼Œå³ done &lt;- true å…ˆäº &lt;-done å‘ç”Ÿï¼Œè¿™æ„å‘³ç€ main å‡½æ•°é‡Œæ‰§è¡Œå®Œ &lt;-done åæ¥ç€æ‰§è¡Œ println(msg) è¿™ä¸€è¡Œä»£ç æ—¶ï¼Œmsg å·²ç»è¢«èµ‹è¿‡å€¼äº†ï¼Œæ‰€ä»¥ä¼šæ‰“å°å‡ºæƒ³è¦çš„ç»“æœ
</span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>done</span> = make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>)
<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>msg</span> <span style=color:#66d9ef>string</span>

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>aGoroutine</span>() {
    <span style=color:#a6e22e>msg</span> = <span style=color:#e6db74>&#34;hello, world&#34;</span>
    <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>done</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>aGoroutine</span>()
    <span style=color:#a6e22e>done</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>true</span>
    println(<span style=color:#a6e22e>msg</span>)
}
<span style=color:#75715e>//æ ¹æ®ç¬¬ä¸‰æ¡è§„åˆ™ï¼Œå¯¹äºéç¼“å†²å‹çš„ channelï¼Œç¬¬ä¸€ä¸ª receive ä¸€å®š happened before ç¬¬ä¸€ä¸ª send finishedã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ åœ¨ done &lt;- true å®Œæˆä¹‹å‰ï¼Œ&lt;-done å°±å·²ç»å‘ç”Ÿäº†ï¼Œä¹Ÿå°±æ„å‘³ç€ msg å·²ç»è¢«èµ‹ä¸Šå€¼äº†ï¼Œæœ€ç»ˆä¹Ÿä¼šæ‰“å°å‡º hello, worldã€‚
</span></code></pre></div>
</div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=/posts/rust%E5%AD%A6%E4%B9%A0/>
<span class=button__icon>â†</span>
<span class=button__text>Rustå­¦ä¹ </span>
</a>
</span>
<span class="button next">
<a href=/posts/readlist/>
<span class=button__text>ReadList</span>
<span class=button__icon>â†’</span>
</a>
</span>
</div>
</div>
<script>localStorage.getItem('theme')=='dark'&&document.documentElement.classList.add('dark-mode')</script>
<div id=light-mode>
<script src=https://utteranc.es/client.js repo=gongqij/blog_comment issue-term=title theme=github-light crossorigin=anonymous async></script>
</div>
<div id=dark-mode>
<script src=https://utteranc.es/client.js repo=gongqij/blog_comment issue-term=title theme=github-dark crossorigin=anonymous async></script>
</div>
<script>var root=document.getElementsByClassName("dark-mode");root.length>0?(document.getElementById("light-mode").style.display="none",document.getElementById("dark-mode").style.display="block"):(document.getElementById("light-mode").style.display="block",document.getElementById("dark-mode").style.display="none")</script>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<a href=/ class=logo style=text-decoration:none>
<span class=logo__text>K:)eep</span>
</a>
<div class=copyright>
<span>Â© 2021 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
</div>
</div>
</footer>
<script src=/assets/main.js></script>
<script src=/assets/prism.js></script>
</div>
</body>
</html>