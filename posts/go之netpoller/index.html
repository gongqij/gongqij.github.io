<!doctype html><html lang=en><head><title>goä¹‹netpoller</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I/O æ¨¡å‹ ç°ä»£çš„ç½‘ç»œæœåŠ¡çš„ä¸»æµå·²ç»å®Œæˆä» CPU å¯†é›†å‹åˆ° IO å¯†é›†å‹çš„è½¬å˜ï¼Œæ‰€ä»¥æœåŠ¡ç«¯ç¨‹åºå¯¹ I/O çš„å¤„ç†å¿…ä¸å¯å°‘ï¼Œè€Œä¸€æ—¦æ“ä½œ I/O åˆ™å¿…å®šè¦åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´æ¥å›åˆ‡æ¢ã€‚
é˜»å¡ I/O (Blocking I/O) éé˜»å¡ I/O (Nonblocking I/O) I/O å¤šè·¯å¤ç”¨ (I/O multiplexing) ä¿¡å·é©±åŠ¨ I/O (Signal driven I/O) å¼‚æ­¥ I/O (Asynchronous I/O) æ“ä½œç³»ç»Ÿä¸Šçš„ I/O æ˜¯ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®äº¤äº’ï¼Œå› æ­¤ I/O æ“ä½œé€šå¸¸åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š
ç­‰å¾…ç½‘ç»œæ•°æ®åˆ°è¾¾ç½‘å¡(è¯»å°±ç»ª)/ç­‰å¾…ç½‘å¡å¯å†™(å†™å°±ç»ª) â€“&amp;gt; è¯»å–/å†™å…¥åˆ°å†…æ ¸ç¼“å†²åŒº
ç½‘å¡&amp;lt;&amp;ndash;&amp;gt;å†…æ ¸ç¼“å†²åŒº
ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶æ•°æ® â€“&amp;gt; ç”¨æˆ·ç©ºé—´(è¯»)/ä»ç”¨æˆ·ç©ºé—´å¤åˆ¶æ•°æ® -&amp;gt; å†…æ ¸ç¼“å†²åŒº(å†™)
å†…æ ¸ç¼“å†²åŒº&amp;lt;&amp;ndash;&amp;gt;ç”¨æˆ·ç©ºé—´
è€Œåˆ¤å®šä¸€ä¸ª I/O æ¨¡å‹æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Œä¸»è¦çœ‹ç¬¬äºŒæ­¥ï¼šæ•°æ®åœ¨ç”¨æˆ·å’Œå†…æ ¸ç©ºé—´ä¹‹é—´å¤åˆ¶çš„æ—¶å€™æ˜¯ä¸æ˜¯ä¼šé˜»å¡å½“å‰è¿›ç¨‹ï¼Œå¦‚æœä¼šï¼Œåˆ™æ˜¯åŒæ­¥ I/Oï¼Œå¦åˆ™ï¼Œå°±æ˜¯å¼‚æ­¥ I/Oã€‚åŸºäºè¿™ä¸ªåŸåˆ™ï¼Œè¿™ 5 ç§ I/O æ¨¡å‹ä¸­åªæœ‰ä¸€ç§å¼‚æ­¥ I/O æ¨¡å‹ï¼šAsynchronous I/Oï¼Œå…¶ä½™éƒ½æ˜¯åŒæ­¥ I/O æ¨¡å‹ã€‚
ç”±äºä½¿ç”¨ epoll çš„ I/O å¤šè·¯å¤ç”¨éœ€è¦ç”¨æˆ·è¿›ç¨‹è‡ªå·±è´Ÿè´£ I/O è¯»å†™ï¼Œä»ç”¨æˆ·è¿›ç¨‹çš„è§’åº¦çœ‹ï¼Œè¯»å†™è¿‡ç¨‹æ˜¯é˜»å¡çš„ï¼Œæ‰€ä»¥ select&amp;amp;poll&amp;amp;epoll æœ¬è´¨ä¸Šéƒ½æ˜¯åŒæ­¥ I/O æ¨¡å‹ï¼Œè€Œåƒ Windows çš„ IOCP è¿™ä¸€ç±»çš„å¼‚æ­¥ I/Oï¼Œåªéœ€è¦åœ¨è°ƒç”¨ WSARecv æˆ– WSASend æ–¹æ³•è¯»å†™æ•°æ®çš„æ—¶å€™æŠŠç”¨æˆ·ç©ºé—´çš„å†…å­˜ buffer æäº¤ç»™ kernelï¼Œkernel è´Ÿè´£æ•°æ®åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´æ‹·è´ï¼Œå®Œæˆä¹‹åå°±ä¼šé€šçŸ¥ç”¨æˆ·è¿›ç¨‹ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸éœ€è¦ç”¨æˆ·è¿›ç¨‹å‚ä¸ï¼Œæ‰€ä»¥æ˜¯çœŸæ­£çš„å¼‚æ­¥ I/Oã€‚"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/go%E4%B9%8Bnetpoller/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png><link href=/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="goä¹‹netpoller"><meta name=twitter:description content="I/O æ¨¡å‹ ç°ä»£çš„ç½‘ç»œæœåŠ¡çš„ä¸»æµå·²ç»å®Œæˆä» CPU å¯†é›†å‹åˆ° IO å¯†é›†å‹çš„è½¬å˜ï¼Œæ‰€ä»¥æœåŠ¡ç«¯ç¨‹åºå¯¹ I/O çš„å¤„ç†å¿…ä¸å¯å°‘ï¼Œè€Œä¸€æ—¦æ“ä½œ I/O åˆ™å¿…å®šè¦åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´æ¥å›åˆ‡æ¢ã€‚
é˜»å¡ I/O (Blocking I/O) éé˜»å¡ I/O (Nonblocking I/O) I/O å¤šè·¯å¤ç”¨ (I/O multiplexing) ä¿¡å·é©±åŠ¨ I/O (Signal driven I/O) å¼‚æ­¥ I/O (Asynchronous I/O) æ“ä½œç³»ç»Ÿä¸Šçš„ I/O æ˜¯ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®äº¤äº’ï¼Œå› æ­¤ I/O æ“ä½œé€šå¸¸åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š
ç­‰å¾…ç½‘ç»œæ•°æ®åˆ°è¾¾ç½‘å¡(è¯»å°±ç»ª)/ç­‰å¾…ç½‘å¡å¯å†™(å†™å°±ç»ª) â€“> è¯»å–/å†™å…¥åˆ°å†…æ ¸ç¼“å†²åŒº
ç½‘å¡<&ndash;>å†…æ ¸ç¼“å†²åŒº
ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶æ•°æ® â€“> ç”¨æˆ·ç©ºé—´(è¯»)/ä»ç”¨æˆ·ç©ºé—´å¤åˆ¶æ•°æ® -> å†…æ ¸ç¼“å†²åŒº(å†™)
å†…æ ¸ç¼“å†²åŒº<&ndash;>ç”¨æˆ·ç©ºé—´
è€Œåˆ¤å®šä¸€ä¸ª I/O æ¨¡å‹æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Œä¸»è¦çœ‹ç¬¬äºŒæ­¥ï¼šæ•°æ®åœ¨ç”¨æˆ·å’Œå†…æ ¸ç©ºé—´ä¹‹é—´å¤åˆ¶çš„æ—¶å€™æ˜¯ä¸æ˜¯ä¼šé˜»å¡å½“å‰è¿›ç¨‹ï¼Œå¦‚æœä¼šï¼Œåˆ™æ˜¯åŒæ­¥ I/Oï¼Œå¦åˆ™ï¼Œå°±æ˜¯å¼‚æ­¥ I/Oã€‚åŸºäºè¿™ä¸ªåŸåˆ™ï¼Œè¿™ 5 ç§ I/O æ¨¡å‹ä¸­åªæœ‰ä¸€ç§å¼‚æ­¥ I/O æ¨¡å‹ï¼šAsynchronous I/Oï¼Œå…¶ä½™éƒ½æ˜¯åŒæ­¥ I/O æ¨¡å‹ã€‚
ç”±äºä½¿ç”¨ epoll çš„ I/O å¤šè·¯å¤ç”¨éœ€è¦ç”¨æˆ·è¿›ç¨‹è‡ªå·±è´Ÿè´£ I/O è¯»å†™ï¼Œä»ç”¨æˆ·è¿›ç¨‹çš„è§’åº¦çœ‹ï¼Œè¯»å†™è¿‡ç¨‹æ˜¯é˜»å¡çš„ï¼Œæ‰€ä»¥ select&poll&epoll æœ¬è´¨ä¸Šéƒ½æ˜¯åŒæ­¥ I/O æ¨¡å‹ï¼Œè€Œåƒ Windows çš„ IOCP è¿™ä¸€ç±»çš„å¼‚æ­¥ I/Oï¼Œåªéœ€è¦åœ¨è°ƒç”¨ WSARecv æˆ– WSASend æ–¹æ³•è¯»å†™æ•°æ®çš„æ—¶å€™æŠŠç”¨æˆ·ç©ºé—´çš„å†…å­˜ buffer æäº¤ç»™ kernelï¼Œkernel è´Ÿè´£æ•°æ®åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´æ‹·è´ï¼Œå®Œæˆä¹‹åå°±ä¼šé€šçŸ¥ç”¨æˆ·è¿›ç¨‹ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸éœ€è¦ç”¨æˆ·è¿›ç¨‹å‚ä¸ï¼Œæ‰€ä»¥æ˜¯çœŸæ­£çš„å¼‚æ­¥ I/Oã€‚"><meta property="og:title" content="goä¹‹netpoller"><meta property="og:description" content="I/O æ¨¡å‹ ç°ä»£çš„ç½‘ç»œæœåŠ¡çš„ä¸»æµå·²ç»å®Œæˆä» CPU å¯†é›†å‹åˆ° IO å¯†é›†å‹çš„è½¬å˜ï¼Œæ‰€ä»¥æœåŠ¡ç«¯ç¨‹åºå¯¹ I/O çš„å¤„ç†å¿…ä¸å¯å°‘ï¼Œè€Œä¸€æ—¦æ“ä½œ I/O åˆ™å¿…å®šè¦åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´æ¥å›åˆ‡æ¢ã€‚
é˜»å¡ I/O (Blocking I/O) éé˜»å¡ I/O (Nonblocking I/O) I/O å¤šè·¯å¤ç”¨ (I/O multiplexing) ä¿¡å·é©±åŠ¨ I/O (Signal driven I/O) å¼‚æ­¥ I/O (Asynchronous I/O) æ“ä½œç³»ç»Ÿä¸Šçš„ I/O æ˜¯ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®äº¤äº’ï¼Œå› æ­¤ I/O æ“ä½œé€šå¸¸åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š
ç­‰å¾…ç½‘ç»œæ•°æ®åˆ°è¾¾ç½‘å¡(è¯»å°±ç»ª)/ç­‰å¾…ç½‘å¡å¯å†™(å†™å°±ç»ª) â€“> è¯»å–/å†™å…¥åˆ°å†…æ ¸ç¼“å†²åŒº
ç½‘å¡<&ndash;>å†…æ ¸ç¼“å†²åŒº
ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶æ•°æ® â€“> ç”¨æˆ·ç©ºé—´(è¯»)/ä»ç”¨æˆ·ç©ºé—´å¤åˆ¶æ•°æ® -> å†…æ ¸ç¼“å†²åŒº(å†™)
å†…æ ¸ç¼“å†²åŒº<&ndash;>ç”¨æˆ·ç©ºé—´
è€Œåˆ¤å®šä¸€ä¸ª I/O æ¨¡å‹æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Œä¸»è¦çœ‹ç¬¬äºŒæ­¥ï¼šæ•°æ®åœ¨ç”¨æˆ·å’Œå†…æ ¸ç©ºé—´ä¹‹é—´å¤åˆ¶çš„æ—¶å€™æ˜¯ä¸æ˜¯ä¼šé˜»å¡å½“å‰è¿›ç¨‹ï¼Œå¦‚æœä¼šï¼Œåˆ™æ˜¯åŒæ­¥ I/Oï¼Œå¦åˆ™ï¼Œå°±æ˜¯å¼‚æ­¥ I/Oã€‚åŸºäºè¿™ä¸ªåŸåˆ™ï¼Œè¿™ 5 ç§ I/O æ¨¡å‹ä¸­åªæœ‰ä¸€ç§å¼‚æ­¥ I/O æ¨¡å‹ï¼šAsynchronous I/Oï¼Œå…¶ä½™éƒ½æ˜¯åŒæ­¥ I/O æ¨¡å‹ã€‚
ç”±äºä½¿ç”¨ epoll çš„ I/O å¤šè·¯å¤ç”¨éœ€è¦ç”¨æˆ·è¿›ç¨‹è‡ªå·±è´Ÿè´£ I/O è¯»å†™ï¼Œä»ç”¨æˆ·è¿›ç¨‹çš„è§’åº¦çœ‹ï¼Œè¯»å†™è¿‡ç¨‹æ˜¯é˜»å¡çš„ï¼Œæ‰€ä»¥ select&poll&epoll æœ¬è´¨ä¸Šéƒ½æ˜¯åŒæ­¥ I/O æ¨¡å‹ï¼Œè€Œåƒ Windows çš„ IOCP è¿™ä¸€ç±»çš„å¼‚æ­¥ I/Oï¼Œåªéœ€è¦åœ¨è°ƒç”¨ WSARecv æˆ– WSASend æ–¹æ³•è¯»å†™æ•°æ®çš„æ—¶å€™æŠŠç”¨æˆ·ç©ºé—´çš„å†…å­˜ buffer æäº¤ç»™ kernelï¼Œkernel è´Ÿè´£æ•°æ®åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´æ‹·è´ï¼Œå®Œæˆä¹‹åå°±ä¼šé€šçŸ¥ç”¨æˆ·è¿›ç¨‹ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸éœ€è¦ç”¨æˆ·è¿›ç¨‹å‚ä¸ï¼Œæ‰€ä»¥æ˜¯çœŸæ­£çš„å¼‚æ­¥ I/Oã€‚"><meta property="og:type" content="article"><meta property="og:url" content="/posts/go%E4%B9%8Bnetpoller/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-23T10:53:03+08:00"><meta property="article:modified_time" content="2022-07-23T10:53:03+08:00"><meta property="og:site_name" content="K:)eep"></head><body><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__text>K:)eep</span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=https://github.com/gongqij>Github</a></li><li><a href=/>Home</a></li><li><a href=/posts/readlist>ReadList</a></li><li><a href=/posts/wechat>WeChat</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=https://github.com/gongqij>Github</a></li><li><a href=/>Home</a></li><li><a href=/posts/readlist>ReadList</a></li><li><a href=/posts/wechat>WeChat</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg style="width:24px;height:24px" viewBox="0 0 24 24"><path fill="currentcolor" d="M12 6a6 6 0 016 6c0 2.22-1.21 4.16-3 5.2V19a1 1 0 01-1 1H10A1 1 0 019 19V17.2C7.21 16.16 6 14.22 6 12a6 6 0 016-6m2 15v1a1 1 0 01-1 1H11a1 1 0 01-1-1V21h4m6-10h3v2H20V11M1 11H4v2H1V11M13 1V4H11V1h2M4.92 3.5 7.05 5.64 5.63 7.05 3.5 4.93 4.92 3.5M16.95 5.63 19.07 3.5 20.5 4.93 18.37 7.05 16.95 5.63z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title style=text-align:center>goä¹‹netpoller</h1><div class=post-meta style=text-align:center;color:#999><span class=post-date>2022-07-23</span>
<span class=post-read-time>Â· 11 min read</span></div><div class=post-content><h1 id=io-æ¨¡å‹>I/O æ¨¡å‹</h1><p>ç°ä»£çš„ç½‘ç»œæœåŠ¡çš„ä¸»æµå·²ç»å®Œæˆä» CPU å¯†é›†å‹åˆ° IO å¯†é›†å‹çš„è½¬å˜ï¼Œæ‰€ä»¥æœåŠ¡ç«¯ç¨‹åºå¯¹ I/O çš„å¤„ç†å¿…ä¸å¯å°‘ï¼Œè€Œä¸€æ—¦æ“ä½œ I/O åˆ™å¿…å®šè¦åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´æ¥å›åˆ‡æ¢ã€‚</p><ul><li>é˜»å¡ I/O (Blocking I/O)</li><li>éé˜»å¡ I/O (Nonblocking I/O)</li><li>I/O å¤šè·¯å¤ç”¨ (I/O multiplexing)</li><li>ä¿¡å·é©±åŠ¨ I/O (Signal driven I/O)</li><li>å¼‚æ­¥ I/O (Asynchronous I/O)</li></ul><p><strong>æ“ä½œç³»ç»Ÿä¸Šçš„ I/O æ˜¯ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®äº¤äº’ï¼Œå› æ­¤ I/O æ“ä½œé€šå¸¸åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤</strong>ï¼š</p><ol><li><p>ç­‰å¾…ç½‘ç»œæ•°æ®åˆ°è¾¾ç½‘å¡(è¯»å°±ç»ª)/ç­‰å¾…ç½‘å¡å¯å†™(å†™å°±ç»ª) â€“> è¯»å–/å†™å…¥åˆ°å†…æ ¸ç¼“å†²åŒº</p><blockquote><p>ç½‘å¡&lt;&ndash;>å†…æ ¸ç¼“å†²åŒº</p></blockquote></li><li><p>ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶æ•°æ® â€“> ç”¨æˆ·ç©ºé—´(è¯»)/ä»ç”¨æˆ·ç©ºé—´å¤åˆ¶æ•°æ® -> å†…æ ¸ç¼“å†²åŒº(å†™)</p><blockquote><p>å†…æ ¸ç¼“å†²åŒº&lt;&ndash;>ç”¨æˆ·ç©ºé—´</p></blockquote></li></ol><p>è€Œåˆ¤å®šä¸€ä¸ª I/O æ¨¡å‹æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Œä¸»è¦çœ‹ç¬¬äºŒæ­¥ï¼šæ•°æ®åœ¨ç”¨æˆ·å’Œå†…æ ¸ç©ºé—´ä¹‹é—´å¤åˆ¶çš„æ—¶å€™æ˜¯ä¸æ˜¯ä¼šé˜»å¡å½“å‰è¿›ç¨‹ï¼Œå¦‚æœä¼šï¼Œåˆ™æ˜¯åŒæ­¥ I/Oï¼Œå¦åˆ™ï¼Œå°±æ˜¯å¼‚æ­¥ I/Oã€‚åŸºäºè¿™ä¸ªåŸåˆ™ï¼Œè¿™ 5 ç§ I/O æ¨¡å‹ä¸­åªæœ‰ä¸€ç§å¼‚æ­¥ I/O æ¨¡å‹ï¼šAsynchronous I/Oï¼Œå…¶ä½™éƒ½æ˜¯åŒæ­¥ I/O æ¨¡å‹ã€‚</p><p>ç”±äºä½¿ç”¨ epoll çš„ I/O å¤šè·¯å¤ç”¨éœ€è¦ç”¨æˆ·è¿›ç¨‹è‡ªå·±è´Ÿè´£ I/O è¯»å†™ï¼Œä»ç”¨æˆ·è¿›ç¨‹çš„è§’åº¦çœ‹ï¼Œè¯»å†™è¿‡ç¨‹æ˜¯é˜»å¡çš„ï¼Œæ‰€ä»¥ select&poll&epoll æœ¬è´¨ä¸Šéƒ½æ˜¯åŒæ­¥ I/O æ¨¡å‹ï¼Œè€Œåƒ Windows çš„ IOCP è¿™ä¸€ç±»çš„å¼‚æ­¥ I/Oï¼Œåªéœ€è¦åœ¨è°ƒç”¨ WSARecv æˆ– WSASend æ–¹æ³•è¯»å†™æ•°æ®çš„æ—¶å€™æŠŠ<strong>ç”¨æˆ·ç©ºé—´çš„å†…å­˜ buffer</strong> æäº¤ç»™ kernelï¼Œkernel è´Ÿè´£æ•°æ®åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´æ‹·è´ï¼Œå®Œæˆä¹‹åå°±ä¼šé€šçŸ¥ç”¨æˆ·è¿›ç¨‹ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸éœ€è¦ç”¨æˆ·è¿›ç¨‹å‚ä¸ï¼Œæ‰€ä»¥æ˜¯çœŸæ­£çš„å¼‚æ­¥ I/Oã€‚</p><h2 id=éé˜»å¡-iononblocking-io><a href=#éé˜»å¡-iononblocking-io class=h-anchor>ğŸ”—</a>éé˜»å¡ I/O(Nonblocking I/O)</h2><p><img src=https://s2.loli.net/2022/07/23/ipm61UzEA9GMtQe.png alt></p><p>Non-blocking I/O çš„ç‰¹ç‚¹æ˜¯ç”¨æˆ·è¿›ç¨‹éœ€è¦ä¸æ–­çš„ä¸»åŠ¨è¯¢é—® kernel æ•°æ®å¥½äº†æ²¡æœ‰.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>//ç³»ç»Ÿè°ƒç”¨fcntlï¼Œå°†socketè®¾ç½®æˆ Non-blocking
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>SetNonblock</span>(<span style=color:#a6e22e>fd</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>nonblocking</span> <span style=color:#66d9ef>bool</span>) (<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>flag</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fcntl</span>(<span style=color:#a6e22e>fd</span>, <span style=color:#a6e22e>F_GETFL</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>nonblocking</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>flag</span> <span style=color:#f92672>|=</span> <span style=color:#a6e22e>O_NONBLOCK</span>
</span></span><span style=display:flex><span>   } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>flag</span> <span style=color:#f92672>&amp;^=</span> <span style=color:#a6e22e>O_NONBLOCK</span>
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>fcntl</span>(<span style=color:#a6e22e>fd</span>, <span style=color:#a6e22e>F_SETFL</span>, <span style=color:#a6e22e>flag</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=io-å¤šè·¯å¤ç”¨-io-multiplexing><a href=#io-å¤šè·¯å¤ç”¨-io-multiplexing class=h-anchor>ğŸ”—</a>I/O å¤šè·¯å¤ç”¨ (I/O multiplexing)</h2><p>æ‰€è°“ I/O å¤šè·¯å¤ç”¨æŒ‡çš„å°±æ˜¯ <strong>select/poll/epoll</strong> è¿™ä¸€ç³»åˆ—çš„å¤šè·¯é€‰æ‹©å™¨ï¼šæ”¯æŒå•ä¸€çº¿ç¨‹åŒæ—¶ç›‘å¬å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆI/O äº‹ä»¶ï¼‰ï¼Œé˜»å¡ç­‰å¾…ï¼Œå¹¶åœ¨å…¶ä¸­æŸä¸ªæ–‡ä»¶æè¿°ç¬¦<strong>å¯è¯»å†™</strong>æ—¶æ”¶åˆ°é€šçŸ¥ã€‚ I/O å¤ç”¨å…¶å®å¤ç”¨çš„ä¸æ˜¯ I/O è¿æ¥ï¼Œè€Œæ˜¯<strong>å¤ç”¨çº¿ç¨‹</strong>ï¼Œè®©ä¸€ä¸ª thread of control èƒ½å¤Ÿå¤„ç†<strong>å¤šä¸ªè¿æ¥ï¼ˆI/O äº‹ä»¶ï¼‰</strong>ã€‚</p><p><strong>fd==æ–‡ä»¶æè¿°ç¬¦=I/Oäº‹ä»¶==è¿æ¥</strong></p><h3 id=selectpoll><a href=#selectpoll class=h-anchor>ğŸ”—</a>Select/poll</h3><p>ç¼ºç‚¹ï¼š</p><ol><li>æœ€å¤§å¹¶å‘æ•°é™åˆ¶ï¼šä½¿ç”¨ 32 ä¸ªæ•´æ•°çš„ 32 ä½ï¼Œå³ 32*32=1024 æ¥æ ‡è¯† fdï¼Œè™½ç„¶å¯ä¿®æ”¹ï¼Œä½†æ˜¯æœ‰ä»¥ä¸‹ç¬¬ 2, 3 ç‚¹çš„ç“¶é¢ˆ</li><li>æ¯æ¬¡è°ƒç”¨ selectï¼Œéƒ½éœ€è¦æŠŠ fd é›†åˆä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ï¼Œè¿™ä¸ªå¼€é”€åœ¨ fd å¾ˆå¤šæ—¶ä¼šå¾ˆå¤§</li><li>æ€§èƒ½è¡°å‡ä¸¥é‡ï¼šæ¯æ¬¡ kernel éƒ½éœ€è¦çº¿æ€§æ‰«ææ•´ä¸ª fd_setï¼Œæ‰€ä»¥éšç€ç›‘æ§çš„æè¿°ç¬¦ fd æ•°é‡å¢é•¿ï¼Œå…¶ I/O æ€§èƒ½ä¼šçº¿æ€§ä¸‹é™</li></ol><p><strong>è¿”å›çš„æ´»è·ƒè¿æ¥ == select(å…¨éƒ¨å¾…ç›‘æ§çš„è¿æ¥)</strong></p><p><strong>å…¨éƒ¨å¾…ç›‘æ§è¿æ¥</strong>æ˜¯æ•°ä»¥åä¸‡è®¡çš„ï¼Œè¿”å›çš„åªæ˜¯æ•°ç™¾ä¸ª<strong>æ´»è·ƒè¿æ¥</strong>ï¼Œè¿™æœ¬èº«å°±æ˜¯æ— æ•ˆç‡çš„è¡¨ç°ã€‚è¢«æ”¾å¤§åå°±ä¼šå‘ç°ï¼Œå¤„ç†å¹¶å‘ä¸Šä¸‡ä¸ªè¿æ¥æ—¶ï¼Œselect&poll å°±å®Œå…¨åŠ›ä¸ä»å¿ƒäº†</p><h3 id=epoll><a href=#epoll class=h-anchor>ğŸ”—</a>epoll</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/epoll.h&gt;  </span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>epoll_create</span>(<span style=color:#66d9ef>int</span> size); <span style=color:#75715e>// int epoll_create1(int flags);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>epoll_ctl</span>(<span style=color:#66d9ef>int</span> epfd, <span style=color:#66d9ef>int</span> op, <span style=color:#66d9ef>int</span> fd, <span style=color:#66d9ef>struct</span> epoll_event <span style=color:#f92672>*</span>event);
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>epoll_wait</span>(<span style=color:#66d9ef>int</span> epfd, <span style=color:#66d9ef>struct</span> epoll_event <span style=color:#f92672>*</span>events, <span style=color:#66d9ef>int</span> maxevents, <span style=color:#66d9ef>int</span> timeout);
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>//epoll_create
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>do_epoll_create</span>(<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>flags</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>error</span> = <span style=color:#a6e22e>ep_alloc</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ep</span>); <span style=color:#75715e>//å¼€è¾Ÿçº¢é»‘æ ‘ç­‰å†…å­˜ç©ºé—´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>error</span> &lt; <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>error</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>error</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>//epoll_ctl
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>SYSCALL_DEFINE4(epoll_ctl, <span style=color:#66d9ef>int</span>, epfd, <span style=color:#66d9ef>int</span>, op, <span style=color:#66d9ef>int</span>, fd,
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>struct</span> epoll_event __user <span style=color:#f92672>*</span>, event)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	epi <span style=color:#f92672>=</span> ep_find(ep, tf.file, fd);
</span></span><span style=display:flex><span>	error <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>EINVAL;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> (op) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> EPOLL_CTL_ADD: <span style=color:#75715e>//å‘çº¢é»‘æ ‘æ·»åŠ 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>epi) {
</span></span><span style=display:flex><span>			epds.events <span style=color:#f92672>|=</span> EPOLLERR <span style=color:#f92672>|</span> EPOLLHUP;
</span></span><span style=display:flex><span>			error <span style=color:#f92672>=</span> ep_insert(ep, <span style=color:#f92672>&amp;</span>epds, tf.file, fd, full_check);
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>			error <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>EEXIST;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (full_check)
</span></span><span style=display:flex><span>			clear_tfile_check_list();
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> EPOLL_CTL_DEL:<span style=color:#75715e>//åˆ é™¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> (epi)
</span></span><span style=display:flex><span>			error <span style=color:#f92672>=</span> ep_remove(ep, epi);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>			error <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>ENOENT;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> EPOLL_CTL_MOD:<span style=color:#75715e>//ä¿®æ”¹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> (epi) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>(epi<span style=color:#f92672>-&gt;</span>event.events <span style=color:#f92672>&amp;</span> EPOLLEXCLUSIVE)) {
</span></span><span style=display:flex><span>				epds.events <span style=color:#f92672>|=</span> EPOLLERR <span style=color:#f92672>|</span> EPOLLHUP;
</span></span><span style=display:flex><span>				error <span style=color:#f92672>=</span> ep_modify(ep, epi, <span style=color:#f92672>&amp;</span>epds);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>			error <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>ENOENT;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> ep_insert(<span style=color:#66d9ef>struct</span> eventpoll <span style=color:#f92672>*</span>ep, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> epoll_event <span style=color:#f92672>*</span>event,
</span></span><span style=display:flex><span>		     <span style=color:#66d9ef>struct</span> file <span style=color:#f92672>*</span>tfile, <span style=color:#66d9ef>int</span> fd, <span style=color:#66d9ef>int</span> full_check)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	ep_rbtree_insert(ep, epi);<span style=color:#75715e>//åŠ å…¥çº¢é»‘æ ‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> ep_ptable_queue_proc(<span style=color:#66d9ef>struct</span> file <span style=color:#f92672>*</span>file, wait_queue_head_t <span style=color:#f92672>*</span>whead,
</span></span><span style=display:flex><span>				 poll_table <span style=color:#f92672>*</span>pt)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (epi<span style=color:#f92672>-&gt;</span>nwait <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> (pwq <span style=color:#f92672>=</span> kmem_cache_alloc(pwq_cache, GFP_KERNEL))) {
</span></span><span style=display:flex><span>		init_waitqueue_func_entry(<span style=color:#f92672>&amp;</span>pwq<span style=color:#f92672>-&gt;</span>wait, ep_poll_callback);<span style=color:#75715e>//ä¸ºæ–°åŠ çš„fdæ³¨å†Œå›è°ƒå‡½æ•°ep_poll_callbackï¼Œåœ¨ fd ç›¸åº”çš„äº‹ä»¶è§¦å‘ï¼ˆä¸­æ–­ï¼‰ä¹‹åï¼ˆè®¾å¤‡å°±ç»ªäº†ï¼‰ï¼Œå†…æ ¸å°±ä¼šè°ƒç”¨ep_poll_callbackï¼Œå°†fd æ·»åŠ åˆ° rdllist è¿™ä¸ªåŒå‘é“¾è¡¨ï¼ˆå°±ç»ªé“¾è¡¨ï¼‰ä¸­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>/* We have to signal that an error occurred */</span>
</span></span><span style=display:flex><span>		epi<span style=color:#f92672>-&gt;</span>nwait <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>//epoll_wait
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>do_epoll_wait</span>(<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>epfd</span>, <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>epoll_event</span> <span style=color:#a6e22e>__user</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>events</span>,
</span></span><span style=display:flex><span>			 <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>maxevents</span>, <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>timeout</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>error</span> = <span style=color:#a6e22e>ep_poll</span>(<span style=color:#a6e22e>ep</span>, <span style=color:#a6e22e>events</span>, <span style=color:#a6e22e>maxevents</span>, <span style=color:#a6e22e>timeout</span>); <span style=color:#75715e>//æ£€æŸ¥ rdllist åŒå‘é“¾è¡¨ä¸­æ˜¯å¦æœ‰å°±ç»ªçš„ fds
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>error_fput</span>:
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fdput</span>(<span style=color:#a6e22e>f</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>error</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>ep_poll</span>(<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>eventpoll</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ep</span>, <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>epoll_event</span> <span style=color:#a6e22e>__user</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>events</span>,
</span></span><span style=display:flex><span>		   <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>maxevents</span>, <span style=color:#a6e22e>long</span> <span style=color:#a6e22e>timeout</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>timeout</span> &gt; <span style=color:#ae81ff>0</span>) {         <span style=color:#75715e>//æˆªæ­¢timeoutè·å–rdllist
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>timespec64</span> <span style=color:#a6e22e>end_time</span> = <span style=color:#a6e22e>ep_set_mstimeout</span>(<span style=color:#a6e22e>timeout</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>slack</span> = <span style=color:#a6e22e>select_estimate_accuracy</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>end_time</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>to</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>expires</span>;
</span></span><span style=display:flex><span>		<span style=color:#f92672>*</span><span style=color:#a6e22e>to</span> = <span style=color:#a6e22e>timespec64_to_ktime</span>(<span style=color:#a6e22e>end_time</span>);
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>timeout</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) { <span style=color:#75715e>//éé˜»å¡è·å–rdllist
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>timed_out</span> = <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>write_lock_irq</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ep</span><span style=color:#f92672>-</span>&gt;<span style=color:#a6e22e>lock</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>eavail</span> = <span style=color:#a6e22e>ep_events_available</span>(<span style=color:#a6e22e>ep</span>);<span style=color:#75715e>//åˆ¤æ–­rdllistæ˜¯å¦ä¸ºç©º
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>write_unlock_irq</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ep</span><span style=color:#f92672>-</span>&gt;<span style=color:#a6e22e>lock</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>goto</span> <span style=color:#a6e22e>send_events</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span><span style=color:#a6e22e>fetch_events</span>:<span style=color:#75715e>//æŒç»­è·å–
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  	<span style=color:#66d9ef>for</span> (;;) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>eavail</span> = <span style=color:#a6e22e>ep_events_available</span>(<span style=color:#a6e22e>ep</span>); <span style=color:#75715e>//rdllistä¸ä¸ºç©ºï¼Œé€€å‡º
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>eavail</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (!<span style=color:#a6e22e>schedule_hrtimeout_range</span>(<span style=color:#a6e22e>to</span>, <span style=color:#a6e22e>slack</span>, <span style=color:#a6e22e>HRTIMER_MODE_ABS</span>)) {<span style=color:#75715e>//timeouté€€å‡º
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>timed_out</span> = <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span><span style=color:#a6e22e>send_events</span>:
</span></span><span style=display:flex><span>	<span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * Try to transfer events to user space. In case we get 0 events and
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * there&#39;s still timeout left over, we go trying again in search of
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * more luck.
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (!<span style=color:#a6e22e>res</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>eavail</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>	    !(<span style=color:#a6e22e>res</span> = <span style=color:#a6e22e>ep_send_events</span>(<span style=color:#a6e22e>ep</span>, <span style=color:#a6e22e>events</span>, <span style=color:#a6e22e>maxevents</span>)) <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>timed_out</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>goto</span> <span style=color:#a6e22e>fetch_events</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src=https://s2.loli.net/2022/07/23/ltkHhgRuYaLEcdO.png alt></p><p>epoll_create åˆ›å»ºä¸€ä¸ª epoll å®ä¾‹å¹¶è¿”å› epollfdï¼›</p><p>epoll_ctl æ³¨å†Œ file descriptor ç­‰å¾…çš„ I/O äº‹ä»¶(æ¯”å¦‚ EPOLLINã€EPOLLOUT ç­‰) åˆ° epoll å®ä¾‹ä¸Šï¼›</p><p>epoll_wait åˆ™æ˜¯é˜»å¡ç›‘å¬ epoll å®ä¾‹ä¸Šæ‰€æœ‰çš„ file descriptor çš„ I/O äº‹ä»¶ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªç”¨æˆ·ç©ºé—´ä¸Šçš„ä¸€å—å†…å­˜åœ°å€ (events æ•°ç»„)ï¼Œkernel ä¼šåœ¨æœ‰ I/O äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™æŠŠæ–‡ä»¶æè¿°ç¬¦åˆ—è¡¨å¤åˆ¶åˆ°è¿™å—å†…å­˜åœ°å€ä¸Šï¼Œç„¶å epoll_wait è§£é™¤é˜»å¡å¹¶è¿”å›ï¼Œæœ€åç”¨æˆ·ç©ºé—´ä¸Šçš„ç¨‹åºå°±å¯ä»¥å¯¹ç›¸åº”çš„ fd è¿›è¡Œè¯»å†™äº†</p><p>åœ¨å®ç°ä¸Š epoll é‡‡ç”¨çº¢é»‘æ ‘æ¥å­˜å‚¨æ‰€æœ‰ç›‘å¬çš„ fdï¼Œè€Œ<strong>çº¢é»‘æ ‘</strong>æœ¬èº«æ’å…¥å’Œåˆ é™¤æ€§èƒ½æ¯”è¾ƒç¨³å®šï¼Œæ—¶é—´å¤æ‚åº¦ O(logN)ã€‚é€šè¿‡ epoll_ctl å‡½æ•°æ·»åŠ è¿›æ¥çš„ fd éƒ½ä¼šè¢«æ”¾åœ¨çº¢é»‘æ ‘çš„æŸä¸ªèŠ‚ç‚¹å†…ï¼Œæ‰€ä»¥ï¼Œé‡å¤æ·»åŠ æ˜¯æ²¡æœ‰ç”¨çš„ã€‚å½“æŠŠ fd æ·»åŠ è¿›æ¥çš„æ—¶å€™æ—¶å€™ä¼šå®Œæˆå…³é”®çš„ä¸€æ­¥ï¼š<strong>è¯¥ fd ä¼šä¸ç›¸åº”çš„è®¾å¤‡ï¼ˆç½‘å¡ï¼‰é©±åŠ¨ç¨‹åºå»ºç«‹å›è°ƒå…³ç³»</strong>ï¼Œä¹Ÿå°±æ˜¯åœ¨å†…æ ¸ä¸­æ–­å¤„ç†ç¨‹åºä¸ºå®ƒæ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œåœ¨ fd ç›¸åº”çš„äº‹ä»¶è§¦å‘ï¼ˆä¸­æ–­ï¼‰ä¹‹åï¼ˆè®¾å¤‡å°±ç»ªäº†ï¼‰ï¼Œå†…æ ¸å°±ä¼šè°ƒç”¨è¿™ä¸ªå›è°ƒå‡½æ•°ï¼Œè¯¥å›è°ƒå‡½æ•°åœ¨å†…æ ¸ä¸­è¢«ç§°ä¸ºï¼š <code>ep_poll_callback</code> ï¼Œ<strong>è¿™ä¸ªå›è°ƒå‡½æ•°å…¶å®å°±æ˜¯æŠŠè¿™ä¸ª fd æ·»åŠ åˆ° rdllist è¿™ä¸ªåŒå‘é“¾è¡¨ï¼ˆå°±ç»ªé“¾è¡¨ï¼‰ä¸­</strong>ã€‚epoll_wait å®é™…ä¸Šå°±æ˜¯å»æ£€æŸ¥ rdllist åŒå‘é“¾è¡¨ä¸­æ˜¯å¦æœ‰å°±ç»ªçš„ fdï¼Œå½“ rdllist ä¸ºç©ºï¼ˆæ— å°±ç»ª fdï¼‰æ—¶æŒ‚èµ·å½“å‰è¿›ç¨‹ï¼Œç›´åˆ° rdllist éç©ºæ—¶è¿›ç¨‹æ‰è¢«å”¤é†’å¹¶è¿”å›ã€‚</p><p>ç›¸æ¯”äº select&poll è°ƒç”¨æ—¶ä¼šå°†å…¨éƒ¨ç›‘å¬çš„ fd <strong>ä»ç”¨æˆ·æ€ç©ºé—´æ‹·è´è‡³å†…æ ¸æ€ç©ºé—´</strong>å¹¶<strong>çº¿æ€§æ‰«æ</strong>ä¸€éæ‰¾å‡ºå°±ç»ªçš„ fd å†è¿”å›åˆ°ç”¨æˆ·æ€ï¼Œepoll_wait åˆ™æ˜¯<strong>ç›´æ¥è¿”å›å·²å°±ç»ª fd</strong>ï¼Œå› æ­¤ epoll çš„ I/O æ€§èƒ½ä¸ä¼šåƒ select&poll é‚£æ ·éšç€ç›‘å¬çš„ fd æ•°é‡å¢åŠ è€Œå‡ºç°çº¿æ€§è¡°å‡ï¼Œæ˜¯ä¸€ä¸ªéå¸¸é«˜æ•ˆçš„ I/O äº‹ä»¶é©±åŠ¨æŠ€æœ¯ã€‚</p><h1 id=go-scheduler>Go scheduler</h1><h2 id=cpu-boundio-bound><a href=#cpu-boundio-bound class=h-anchor>ğŸ”—</a>CPU-Boundã€IO-Bound</h2><p>CPU-Boundæ˜¯ä¸€ç§ä»æ¥æ²¡æœ‰äº§ç”Ÿè¿‡Goroutinesè‡ªç„¶è¿›å…¥å’Œé€€å‡ºç­‰å¾…çŠ¶æ€çš„æƒ…å†µçš„å·¥ä½œè´Ÿè½½ã€‚è¿™æ˜¯ä¸€ä¸ªä¸æ–­è¿›è¡Œè®¡ç®—çš„å·¥ä½œã€‚ä¸€ä¸ªè®¡ç®—Piåˆ°ç¬¬Nä½çš„çº¿ç¨‹å°±æ˜¯CPUç»‘å®šçš„ã€‚</p><p>å¯¹äºCPU-Boundçš„å·¥ä½œè´Ÿè½½ï¼Œä½ éœ€è¦**å¹¶è¡Œæ€§(å¤šæ ¸)**æ¥åˆ©ç”¨å¹¶å‘æ€§ã€‚ä¸€ä¸ªå¤„ç†å¤šä¸ªGoroutineçš„æ“ä½œç³»ç»Ÿ/ç¡¬ä»¶çº¿ç¨‹å¹¶ä¸é«˜æ•ˆï¼Œå› ä¸ºè¿™äº›Goroutineå¹¶æ²¡æœ‰ä½œä¸ºå…¶å·¥ä½œè´Ÿè½½çš„ä¸€éƒ¨åˆ†è¿›å‡ºç­‰å¾…çŠ¶æ€ã€‚ç”±äºå°†Goroutineç§»å…¥å’Œç§»å‡ºæ“ä½œç³»ç»Ÿçº¿ç¨‹çš„å»¶è¿Ÿæˆæœ¬ï¼ˆæ‰€éœ€æ—¶é—´ï¼‰ï¼Œæ‹¥æœ‰æ¯”æ“ä½œç³»ç»Ÿ/ç¡¬ä»¶çº¿ç¨‹æ›´å¤šçš„Goroutineä¼šå‡æ…¢å·¥ä½œè´Ÿè½½çš„æ‰§è¡Œã€‚ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸ºä½ çš„å·¥ä½œè´Ÿè½½åˆ›é€ äº†ä¸€ä¸ª &ldquo;åœæ­¢ä¸–ç•Œ &ldquo;çš„äº‹ä»¶ï¼Œå› ä¸ºä½ çš„å·¥ä½œè´Ÿè½½åœ¨åˆ‡æ¢æœŸé—´æ²¡æœ‰è¢«æ‰§è¡Œï¼Œè€Œå®ƒæœ¬æ¥æ˜¯å¯ä»¥è¢«æ‰§è¡Œçš„ã€‚</p><p>IO-Boundæ˜¯ä¸€ä¸ªå¯¼è‡´Goroutineè‡ªç„¶è¿›å…¥ç­‰å¾…çŠ¶æ€çš„å·¥ä½œè´Ÿè½½ã€‚è¿™ç§å·¥ä½œåŒ…æ‹¬é€šè¿‡ç½‘ç»œè¯·æ±‚è®¿é—®èµ„æºï¼Œæˆ–å¯¹æ“ä½œç³»ç»Ÿè¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œæˆ–ç­‰å¾…ä¸€ä¸ªäº‹ä»¶çš„å‘ç”Ÿã€‚ä¸€ä¸ªéœ€è¦è¯»å–æ–‡ä»¶çš„Goroutineå°†æ˜¯IO-Boundã€‚æˆ‘å°†åŒ…æ‹¬åŒæ­¥äº‹ä»¶ï¼ˆmutexes, atomicï¼‰ï¼Œè¿™äº›äº‹ä»¶å¯¼è‡´Goroutineç­‰å¾…ï¼Œä¹Ÿæ˜¯è¿™ä¸ªç±»åˆ«çš„ä¸€éƒ¨åˆ†ã€‚</p><p>å¯¹äºIO-Boundçš„å·¥ä½œè´Ÿè½½ï¼Œä½ ä¸éœ€è¦<strong>å¹¶è¡Œæ€§(å¤šæ ¸</strong>)æ¥ä½¿ç”¨å¹¶å‘æ€§ã€‚ä¸€ä¸ªæ“ä½œç³»ç»Ÿ/ç¡¬ä»¶çº¿ç¨‹å¯ä»¥é«˜æ•ˆåœ°å¤„ç†å¤šä¸ªGoroutinesï¼Œå› ä¸ºGoroutinesä½œä¸ºå…¶å·¥ä½œè´Ÿè½½çš„ä¸€éƒ¨åˆ†ï¼Œè‡ªç„¶ä¼šåœ¨ç­‰å¾…çŠ¶æ€ä¸­ç§»åŠ¨ã€‚æ‹¥æœ‰æ¯”æ“ä½œç³»ç»Ÿ/ç¡¬ä»¶çº¿ç¨‹æ›´å¤šçš„Goroutineså¯ä»¥åŠ é€Ÿå·¥ä½œè´Ÿè½½çš„æ‰§è¡Œï¼Œå› ä¸ºå°†Goroutinesç§»å…¥å’Œç§»å‡ºæ“ä½œç³»ç»Ÿçº¿ç¨‹çš„å»¶è¿Ÿæˆæœ¬ä¸ä¼šäº§ç”Ÿä¸€ä¸ª &ldquo;åœæ­¢ä¸–ç•Œ &ldquo;äº‹ä»¶ã€‚ä½ çš„å·¥ä½œè´Ÿè½½è‡ªç„¶ä¼šåœæ­¢ï¼Œè¿™ä½¿å¾—ä¸åŒçš„Goroutineå¯ä»¥æœ‰æ•ˆåœ°åˆ©ç”¨åŒä¸€ä¸ªæ“ä½œç³»ç»Ÿ/ç¡¬ä»¶çº¿ç¨‹ï¼Œè€Œä¸æ˜¯è®©æ“ä½œç³»ç»Ÿ/ç¡¬ä»¶çº¿ç¨‹é—²ç½®ã€‚</p><h2 id=ä¸Šä¸‹æ–‡åˆ‡æ¢><a href=#ä¸Šä¸‹æ–‡åˆ‡æ¢ class=h-anchor>ğŸ”—</a>ä¸Šä¸‹æ–‡åˆ‡æ¢</h2><p>ä¸Šä¸‹æ–‡åˆ‡æ¢è¢«è®¤ä¸ºæ˜¯æ˜‚è´µçš„ï¼Œå› ä¸ºå®ƒéœ€è¦æ—¶é—´æ¥äº¤æ¢coreä¸Šçš„çº¿ç¨‹å’Œå…³é—­ã€‚åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢è¿‡ç¨‹ä¸­å‘ç”Ÿçš„å»¶è¿Ÿé‡å–å†³äºä¸åŒçš„å› ç´ ï¼Œä½†å®ƒéœ€è¦1000åˆ°1500çº³ç§’çš„æ—¶é—´ä¹Ÿä¸æ˜¯ä¸åˆç†çš„ã€‚è€ƒè™‘åˆ°ç¡¬ä»¶åº”è¯¥èƒ½å¤Ÿåˆç†åœ°æ‰§è¡Œï¼ˆå¹³å‡ï¼‰æ¯çº³ç§’12æ¡æŒ‡ä»¤ï¼Œä¸€ä¸ªä¸Šä¸‹æ–‡åˆ‡æ¢ä¼šä½¿ä½ æŸå¤±12000åˆ°18000æ¡æŒ‡ä»¤çš„å»¶è¿Ÿã€‚ä»æœ¬è´¨ä¸Šè®²ï¼Œä½ çš„ç¨‹åºåœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢æœŸé—´å¤±å»äº†æ‰§è¡Œå¤§é‡æŒ‡ä»¤çš„èƒ½åŠ›ã€‚</p><p>å¦‚æœä½ æœ‰ä¸€ä¸ªä¸“æ³¨äºIO-Boundå·¥ä½œçš„ç¨‹åºï¼Œé‚£ä¹ˆä¸Šä¸‹æ–‡åˆ‡æ¢å°†æ˜¯ä¸€ä¸ªä¼˜åŠ¿ã€‚ä¸€æ—¦ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œå¦ä¸€ä¸ªå¤„äºå¯è¿è¡ŒçŠ¶æ€çš„çº¿ç¨‹å°±ä¼šæ¥æ›¿å®ƒçš„ä½ç½®ã€‚è¿™å…è®¸coreä¸€ç›´åœ¨åšå·¥ä½œã€‚è¿™æ˜¯è°ƒåº¦çš„ä¸€ä¸ªæœ€é‡è¦çš„æ–¹é¢ã€‚å¦‚æœæœ‰å·¥ä½œï¼ˆå¤„äºå¯è¿è¡ŒçŠ¶æ€çš„çº¿ç¨‹ï¼‰è¦åšï¼Œå°±ä¸è¦è®©ä¸€ä¸ªcoreé—²ç½®ä¸‹æ¥ã€‚</p><p>å¦‚æœä½ çš„ç¨‹åºä¸“æ³¨äºCPUç»‘å®šçš„å·¥ä½œï¼Œé‚£ä¹ˆä¸Šä¸‹æ–‡åˆ‡æ¢å°†æ˜¯ä¸€ä¸ªæ€§èƒ½å™©æ¢¦ã€‚å› ä¸ºThreadæ€»æ˜¯æœ‰å·¥ä½œè¦åšï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢æ˜¯åœ¨é˜»æ­¢å·¥ä½œçš„è¿›è¡Œã€‚è¿™ç§æƒ…å†µä¸IO-Boundå·¥ä½œè´Ÿè½½çš„æƒ…å†µæˆªç„¶ä¸åŒ</p><h2 id=go-schedulerè®¾è®¡å“²å­¦><a href=#go-schedulerè®¾è®¡å“²å­¦ class=h-anchor>ğŸ”—</a>Go schedulerè®¾è®¡å“²å­¦</h2><p><strong>å°±åƒæ“ä½œç³»ç»Ÿçº¿ç¨‹æ˜¯åœ¨coreä¸Šè¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ŒGoroutinesæ˜¯åœ¨Mä¸Šè¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢</strong></p><p><strong>å‹æ¦¨æ›´å¤šCPUçš„æ€§èƒ½</strong></p><p>ä»æœ¬è´¨ä¸Šè®²ï¼ŒGoå°† IO/Blocking workå˜æˆäº†æ“ä½œç³»ç»Ÿå±‚é¢ä¸Šçš„CPU-bound workã€‚ç”±äºæ‰€æœ‰çš„ä¸Šä¸‹æ–‡åˆ‡æ¢éƒ½å‘ç”Ÿåœ¨<strong>åº”ç”¨å±‚é¢</strong>ï¼Œæˆ‘ä»¬ä¸ä¼šåƒä½¿ç”¨OS Threadsæ—¶é‚£æ ·ï¼Œæ¯æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢æŸå¤±çº¦12kæŒ‡ä»¤ï¼ˆå¹³å‡ï¼‰ã€‚åœ¨Goä¸­ï¼Œè¿™äº›ç›¸åŒçš„ä¸Šä¸‹æ–‡åˆ‡æ¢ä¼šè®©ä½ æŸå¤±çº¦200çº³ç§’æˆ–çº¦2.4kæŒ‡ä»¤ã€‚è°ƒåº¦å™¨ä¹Ÿæœ‰åŠ©äºæé«˜ç¼“å­˜çº¿çš„æ•ˆç‡å’ŒNUMAã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸éœ€è¦æ¯”æˆ‘ä»¬çš„è™šæ‹Ÿæ ¸å¿ƒæ›´å¤šçš„çº¿ç¨‹ã€‚åœ¨Goä¸­ï¼Œéšç€æ—¶é—´çš„æ¨ç§»ï¼Œæˆ‘ä»¬æœ‰å¯èƒ½å®Œæˆæ›´å¤šçš„å·¥ä½œï¼Œå› ä¸ºGoè°ƒåº¦å™¨è¯•å›¾ä½¿ç”¨æ›´å°‘çš„çº¿ç¨‹ï¼Œåœ¨æ¯ä¸ªçº¿ç¨‹ä¸Šåšæ›´å¤šçš„å·¥ä½œï¼Œè¿™æœ‰åŠ©äºå‡å°‘æ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶çš„è´Ÿè½½ã€‚</p><h2 id=go-netpoller><a href=#go-netpoller class=h-anchor>ğŸ”—</a>Go netpoller</h2><h3 id=åŸºæœ¬åŸç†><a href=#åŸºæœ¬åŸç† class=h-anchor>ğŸ”—</a>åŸºæœ¬åŸç†</h3><p>Go netpoller é€šè¿‡åœ¨åº•å±‚å¯¹ epoll/kqueue/iocp çš„å°è£…ï¼Œä»è€Œå®ç°äº†<strong>ä½¿ç”¨åŒæ­¥ç¼–ç¨‹æ¨¡å¼è¾¾åˆ°å¼‚æ­¥æ‰§è¡Œçš„æ•ˆæœ</strong>ï¼ˆsocketè¯»å†™æœªå°±ç»ªæ—¶ï¼Œconn.readã€conn.writeé˜»å¡ã€‚é˜»å¡æ—¶goroutineè¢«goparkï¼Œnetpolleræ£€æµ‹socketè¯»å†™æ˜¯å¦å°±ç»ªï¼Œè‹¥å°±ç»ªï¼Œconn.readã€conn.writeæ­£å¸¸æ‰§è¡Œï¼‰ã€‚æ€»ç»“æ¥è¯´ï¼Œæ‰€æœ‰çš„ç½‘ç»œæ“ä½œéƒ½ä»¥ç½‘ç»œæè¿°ç¬¦ netFD ä¸ºä¸­å¿ƒå®ç°ã€‚netFD ä¸åº•å±‚ PollDesc ç»“æ„ç»‘å®šï¼Œå½“åœ¨ä¸€ä¸ª netFD ä¸Šè¯»å†™é‡åˆ° EAGAIN é”™è¯¯æ—¶ï¼Œå°±å°†å½“å‰ goroutine å­˜å‚¨åˆ°è¿™ä¸ª netFD å¯¹åº”çš„ PollDesc ä¸­ï¼ŒåŒæ—¶è°ƒç”¨ gopark æŠŠå½“å‰ goroutine ç»™ park ä½ï¼Œç›´åˆ°è¿™ä¸ª netFD ä¸Šå†æ¬¡å‘ç”Ÿè¯»å†™äº‹ä»¶ï¼Œæ‰å°†æ­¤ goroutine ç»™ ready æ¿€æ´»é‡æ–°è¿è¡Œã€‚æ˜¾ç„¶ï¼Œåœ¨åº•å±‚é€šçŸ¥ goroutine å†æ¬¡å‘ç”Ÿè¯»å†™ç­‰äº‹ä»¶çš„æ–¹å¼å°±æ˜¯ epoll/kqueue/iocp ç­‰äº‹ä»¶é©±åŠ¨æœºåˆ¶ã€‚</p><h3 id=1ä¸»è¦æµç¨‹><a href=#1ä¸»è¦æµç¨‹ class=h-anchor>ğŸ”—</a>1ã€ä¸»è¦æµç¨‹</h3><p><img src=https://s2.loli.net/2022/07/23/QedOnMCSWA498i2.png alt></p><ol><li><strong>æ–°è¿æ¥å»ºç«‹</strong>ã€‚client è¿æ¥ server çš„æ—¶å€™ï¼Œlistener é€šè¿‡ accept è°ƒç”¨æ¥æ”¶æ–° connectionï¼Œæ¯ä¸€ä¸ªæ–° connection éƒ½å¯åŠ¨ä¸€ä¸ª goroutine å¤„ç†ï¼Œaccept è°ƒç”¨ä¼šæŠŠè¯¥ connection çš„ fd è¿å¸¦æ‰€åœ¨çš„ goroutine ä¸Šä¸‹æ–‡ä¿¡æ¯å°è£…æ³¨å†Œåˆ° epoll çš„ç›‘å¬åˆ—è¡¨é‡Œå»ã€‚(<strong>ç³»ç»Ÿè°ƒç”¨epoll_ctlï¼Œepollé‡‡ç”¨çº¢é»‘æ ‘æ¥å­˜å‚¨æ‰€æœ‰ç›‘å¬çš„ fd</strong>)</li><li><strong>é˜»å¡</strong>ã€‚å½“ goroutine è°ƒç”¨ <code>conn.Read</code> æˆ–è€… <code>conn.Write</code> ç­‰éœ€è¦é˜»å¡ç­‰å¾…çš„å‡½æ•°æ—¶ï¼Œä¼šè¢« <code>gopark</code> ç»™å°å­˜èµ·æ¥å¹¶ä½¿ä¹‹ä¼‘çœ ï¼Œè®© P å»æ‰§è¡Œæœ¬åœ°è°ƒåº¦é˜Ÿåˆ—é‡Œçš„ä¸‹ä¸€ä¸ªå¯æ‰§è¡Œçš„ goroutineï¼Œå¾€å Go scheduler ä¼šåœ¨å¾ªç¯è°ƒåº¦çš„ <code>runtime.schedule()</code> å‡½æ•°ä»¥åŠ sysmon ç›‘æ§çº¿ç¨‹ä¸­è°ƒç”¨ <code>runtime.netpoll</code> ä»¥è·å–å¯è¿è¡Œçš„ goroutine åˆ—è¡¨å¹¶é€šè¿‡è°ƒç”¨ injectglist æŠŠå‰©ä¸‹çš„ g æ”¾å…¥å…¨å±€è°ƒåº¦é˜Ÿåˆ—æˆ–è€…å½“å‰ P æœ¬åœ°è°ƒåº¦é˜Ÿåˆ—å»é‡æ–°æ‰§è¡Œã€‚ï¼ˆgoroutine<strong>è°ƒåº¦</strong>ï¼‰</li><li><strong>å”¤é†’</strong>ã€‚netpoller é€šè¿‡ <code>runtime.netpoll</code>å”¤é†’é‚£äº›åœ¨ I/O wait çš„ goroutine çš„ã€‚ï¼ˆç³»ç»Ÿè°ƒç”¨epoll_waitï¼Œæ£€æŸ¥å¹¶å”¤é†’å°±ç»ªçš„FDï¼‰</li></ol><p>Go åœ¨å¤šç§åœºæ™¯ä¸‹éƒ½å¯èƒ½ä¼šè°ƒç”¨ <code>netpoll</code> æ£€æŸ¥FDçŠ¶æ€ï¼Œ<code>netpoll</code> é‡Œä¼šè°ƒç”¨ <code>epoll_wait</code> ä» epoll çš„ <code>eventpoll.rdllist</code> <strong>å°±ç»ªåŒå‘é“¾è¡¨</strong>è¿”å›ï¼Œä»è€Œå¾—åˆ° I/O å°±ç»ªçš„ socket fd åˆ—è¡¨ï¼Œå¹¶æ ¹æ®å–å‡ºæœ€åˆè°ƒç”¨ <code>epoll_ctl</code> æ—¶ä¿å­˜çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæ¢å¤ <code>g</code>ã€‚æ‰€ä»¥æ‰§è¡Œå®Œ<code>netpoll</code> ä¹‹åï¼Œä¼šè¿”å›ä¸€ä¸ªå°±ç»ª fd åˆ—è¡¨å¯¹åº”çš„ goroutine é“¾è¡¨ï¼Œæ¥ä¸‹æ¥å°†å°±ç»ªçš„ goroutine é€šè¿‡è°ƒç”¨ <code>injectglist</code> åŠ å…¥åˆ°<strong>å…¨å±€è°ƒåº¦é˜Ÿåˆ—</strong>æˆ–è€… P çš„<strong>æœ¬åœ°è°ƒåº¦é˜Ÿåˆ—</strong>ä¸­ï¼Œå¯åŠ¨ M ç»‘å®š P å»æ‰§è¡Œã€‚</p><h3 id=2ä»£ç å®ç°><a href=#2ä»£ç å®ç° class=h-anchor>ğŸ”—</a>2ã€ä»£ç å®ç°</h3><h4 id=netlisten><a href=#netlisten class=h-anchor>ğŸ”—</a>net.Listen</h4><ol><li>æ˜¯è°ƒç”¨ <code>epollcreate1</code> åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>epoll</code> æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¼šåœ¨æ•´ä¸ªç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸä¸­ä½¿ç”¨ï¼›</li><li>é€šè¿‡ <a href=https://draveness.me/golang/tree/runtime.nonblockingPipe><code>runtime.nonblockingPipe</code></a> åˆ›å»ºä¸€ä¸ªç”¨äºé€šä¿¡çš„ç®¡é“ï¼›</li><li>ä½¿ç”¨ <code>epollctl</code> å°†ç”¨äºè¯»å–æ•°æ®çš„æ–‡ä»¶æè¿°ç¬¦æ‰“åŒ…æˆ <code>epollevent</code> äº‹ä»¶åŠ å…¥ç›‘å¬ï¼›</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// è°ƒç”¨ linux ç³»ç»Ÿè°ƒç”¨ socket åˆ›å»º listener fd å¹¶è®¾ç½®ä¸ºä¸ºé˜»å¡ I/O
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>socketFunc</span>(<span style=color:#a6e22e>family</span>, <span style=color:#a6e22e>sotype</span>|<span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>SOCK_NONBLOCK</span>|<span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>SOCK_CLOEXEC</span>, <span style=color:#a6e22e>proto</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>// On Linux the SOCK_NONBLOCK and SOCK_CLOEXEC flags were
</span></span></span><span style=display:flex><span><span style=color:#75715e>// introduced in 2.6.27 kernel and on FreeBSD both flags were
</span></span></span><span style=display:flex><span><span style=color:#75715e>// introduced in 10 kernel. If we get an EINVAL error on Linux
</span></span></span><span style=display:flex><span><span style=color:#75715e>// or EPROTONOSUPPORT error on FreeBSD, fall back to using
</span></span></span><span style=display:flex><span><span style=color:#75715e>// socket without them.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> 
</span></span><span style=display:flex><span><span style=color:#a6e22e>socketFunc</span>        <span style=color:#66d9ef>func</span>(<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>int</span>) (<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>error</span>)  = <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>Socket</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e>// ç”¨ä¸Šé¢åˆ›å»ºçš„ listener fd åˆå§‹åŒ– listener netFD
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>fd</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>newFD</span>(<span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>family</span>, <span style=color:#a6e22e>sotype</span>, <span style=color:#a6e22e>net</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>poll</span>.<span style=color:#a6e22e>CloseFunc</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e>// å¯¹ listener fd è¿›è¡Œ bind&amp;listen æ“ä½œï¼Œå¹¶ä¸”è°ƒç”¨ init æ–¹æ³•å®Œæˆåˆå§‹åŒ–
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>fd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>netFD</span>) <span style=color:#a6e22e>listenStream</span>(<span style=color:#a6e22e>laddr</span> <span style=color:#a6e22e>sockaddr</span>, <span style=color:#a6e22e>backlog</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>ctrlFn</span> <span style=color:#66d9ef>func</span>(<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>RawConn</span>) <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å®Œæˆç»‘å®šæ“ä½œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>Bind</span>(<span style=color:#a6e22e>fd</span>.<span style=color:#a6e22e>pfd</span>.<span style=color:#a6e22e>Sysfd</span>, <span style=color:#a6e22e>lsa</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>NewSyscallError</span>(<span style=color:#e6db74>&#34;bind&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å®Œæˆç›‘å¬æ“ä½œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>listenFunc</span>(<span style=color:#a6e22e>fd</span>.<span style=color:#a6e22e>pfd</span>.<span style=color:#a6e22e>Sysfd</span>, <span style=color:#a6e22e>backlog</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>NewSyscallError</span>(<span style=color:#e6db74>&#34;listen&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è°ƒç”¨ initï¼Œå†…éƒ¨ä¼šè°ƒç”¨ poll.FD.Initï¼Œæœ€åè°ƒç”¨ pollDesc.init
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>fd</span>.<span style=color:#a6e22e>init</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lsa</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>Getsockname</span>(<span style=color:#a6e22e>fd</span>.<span style=color:#a6e22e>pfd</span>.<span style=color:#a6e22e>Sysfd</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fd</span>.<span style=color:#a6e22e>setAddr</span>(<span style=color:#a6e22e>fd</span>.<span style=color:#a6e22e>addrFunc</span>()(<span style=color:#a6e22e>lsa</span>), <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e>// ä½¿ç”¨ sync.Once æ¥ç¡®ä¿ä¸€ä¸ª listener åªæŒæœ‰ä¸€ä¸ª epoll å®ä¾‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>serverInit</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Once</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e>// netFD.init ä¼šè°ƒç”¨ poll.FD.Init å¹¶æœ€ç»ˆè°ƒç”¨åˆ° pollDesc.initï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e>// å®ƒä¼šåˆ›å»º epoll å®ä¾‹å¹¶æŠŠ listener fd åŠ å…¥ç›‘å¬é˜Ÿåˆ—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>pd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pollDesc</span>) <span style=color:#a6e22e>init</span>(<span style=color:#a6e22e>fd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>FD</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// runtime_pollServerInit é€šè¿‡ `go:linkname` é“¾æ¥åˆ°å…·ä½“çš„å®ç°å‡½æ•° poll_runtime_pollServerInitï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// æ¥ç€å†è°ƒç”¨ netpollGenericInitï¼Œç„¶åä¼šæ ¹æ®ä¸åŒçš„ç³»ç»Ÿå¹³å°å»è°ƒç”¨ç‰¹å®šçš„ netpollinit æ¥åˆ›å»º epoll å®ä¾‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>serverInit</span>.<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>runtime_pollServerInit</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// runtime_pollOpen å†…éƒ¨è°ƒç”¨äº† netpollopen æ¥å°† listener fd æ³¨å†Œåˆ° 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// epoll å®ä¾‹ä¸­ï¼Œå¦å¤–ï¼Œå®ƒä¼šåˆå§‹åŒ–ä¸€ä¸ª pollDesc å¹¶è¿”å›
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>errno</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>runtime_pollOpen</span>(uintptr(<span style=color:#a6e22e>fd</span>.<span style=color:#a6e22e>Sysfd</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>errno</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>runtime_pollUnblock</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>runtime_pollClose</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>Errno</span>(<span style=color:#a6e22e>errno</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æŠŠçœŸæ­£åˆå§‹åŒ–å®Œæˆçš„ pollDesc å®ä¾‹èµ‹å€¼ç»™å½“å‰çš„ pollDesc ä»£è¡¨è‡ªèº«çš„æŒ‡é’ˆï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// åç»­ä½¿ç”¨ç›´æ¥é€šè¿‡è¯¥æŒ‡é’ˆæ“ä½œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>pd</span>.<span style=color:#a6e22e>runtimeCtx</span> = <span style=color:#a6e22e>ctx</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å…¨å±€å”¯ä¸€çš„ epoll fdï¼Œåªåœ¨ listener fd åˆå§‹åŒ–ä¹‹æ—¶è¢«æŒ‡å®šä¸€æ¬¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>epfd</span> <span style=color:#66d9ef>int32</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#75715e>// epoll descriptor
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e>// netpollinit ä¼šåˆ›å»ºä¸€ä¸ª epoll å®ä¾‹ï¼Œç„¶åæŠŠ epoll fd èµ‹å€¼ç»™ epfdï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e>// åç»­ listener ä»¥åŠå®ƒ accept çš„æ‰€æœ‰ sockets æœ‰å…³ epoll çš„æ“ä½œéƒ½æ˜¯åŸºäºè¿™ä¸ªå…¨å±€çš„ epfd
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>netpollinit</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>epfd</span> = <span style=color:#a6e22e>epollcreate1</span>(<span style=color:#a6e22e>_EPOLL_CLOEXEC</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>epfd</span> &lt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>epfd</span> = <span style=color:#a6e22e>epollcreate</span>(<span style=color:#ae81ff>1024</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>epfd</span> &lt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			println(<span style=color:#e6db74>&#34;runtime: epollcreate failed with&#34;</span>, <span style=color:#f92672>-</span><span style=color:#a6e22e>epfd</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;runtime: netpollinit failed&#34;</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>closeonexec</span>(<span style=color:#a6e22e>epfd</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>errno</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nonblockingPipe</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>errno</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		println(<span style=color:#e6db74>&#34;runtime: pipe failed with&#34;</span>, <span style=color:#f92672>-</span><span style=color:#a6e22e>errno</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;runtime: pipe failed&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ev</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>epollevent</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>events</span>: <span style=color:#a6e22e>_EPOLLIN</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#f92672>*</span>(<span style=color:#f92672>**</span><span style=color:#66d9ef>uintptr</span>)(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ev</span>.<span style=color:#a6e22e>data</span>)) = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>netpollBreakRd</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>errno</span> = <span style=color:#a6e22e>epollctl</span>(<span style=color:#a6e22e>epfd</span>, <span style=color:#a6e22e>_EPOLL_CTL_ADD</span>, <span style=color:#a6e22e>r</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ev</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>errno</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		println(<span style=color:#e6db74>&#34;runtime: epollctl failed with&#34;</span>, <span style=color:#f92672>-</span><span style=color:#a6e22e>errno</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;runtime: epollctl failed&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>netpollBreakRd</span> = uintptr(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>netpollBreakWr</span> = uintptr(<span style=color:#a6e22e>w</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e>// netpollopen ä¼šè¢« runtime_pollOpen è°ƒç”¨ï¼Œæ³¨å†Œ fd åˆ° epoll å®ä¾‹ï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e>// æ³¨æ„è¿™é‡Œä½¿ç”¨çš„æ˜¯ epoll çš„ ET æ¨¡å¼ï¼ŒåŒæ—¶ä¼šåˆ©ç”¨ä¸‡èƒ½æŒ‡é’ˆæŠŠ pollDesc ä¿å­˜åˆ° epollevent çš„ä¸€ä¸ª 8 ä½çš„å­—èŠ‚æ•°ç»„ data é‡Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>netpollopen</span>(<span style=color:#a6e22e>fd</span> <span style=color:#66d9ef>uintptr</span>, <span style=color:#a6e22e>pd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pollDesc</span>) <span style=color:#66d9ef>int32</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>ev</span> <span style=color:#a6e22e>epollevent</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ev</span>.<span style=color:#a6e22e>events</span> = <span style=color:#a6e22e>_EPOLLIN</span> | <span style=color:#a6e22e>_EPOLLOUT</span> | <span style=color:#a6e22e>_EPOLLRDHUP</span> | <span style=color:#a6e22e>_EPOLLET</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>*</span>(<span style=color:#f92672>**</span><span style=color:#a6e22e>pollDesc</span>)(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ev</span>.<span style=color:#a6e22e>data</span>)) = <span style=color:#a6e22e>pd</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>epollctl</span>(<span style=color:#a6e22e>epfd</span>, <span style=color:#a6e22e>_EPOLL_CTL_ADD</span>, int32(<span style=color:#a6e22e>fd</span>), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ev</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=listeneraccept><a href=#listeneraccept class=h-anchor>ğŸ”—</a>Listener.Accept()</h4><blockquote><p>goparkåç­‰å¾…è¢«å”¤é†’</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>fd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>FD</span>) <span style=color:#a6e22e>Accept</span>() (<span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>Sockaddr</span>, <span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ä½¿ç”¨ linux ç³»ç»Ÿè°ƒç”¨ accept æ¥æ”¶æ–°è¿æ¥ï¼Œåˆ›å»ºå¯¹åº”çš„ socket
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>rsa</span>, <span style=color:#a6e22e>errcall</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>accept</span>(<span style=color:#a6e22e>fd</span>.<span style=color:#a6e22e>Sysfd</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// å› ä¸º listener fd åœ¨åˆ›å»ºçš„æ—¶å€™å·²ç»è®¾ç½®æˆéé˜»å¡çš„äº†ï¼Œæ‰€ä»¥ accept æ–¹æ³•ä¼šç›´æ¥è¿”å›ï¼Œä¸ç®¡æœ‰æ²¡æœ‰æ–°è¿æ¥åˆ°   æ¥ï¼›å¦‚æœ err == nil åˆ™è¡¨ç¤ºæ­£å¸¸å»ºç«‹æ–°è¿æ¥ï¼Œç›´æ¥è¿”å›
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>rsa</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>err</span> {
</span></span><span style=display:flex><span>   <span style=color:#75715e>// å¦‚æœ err != nilï¼Œåˆ™åˆ¤æ–­ err == syscall.EAGAINï¼Œç¬¦åˆæ¡ä»¶åˆ™è¿›å…¥ pollDesc.waitRead æ–¹æ³•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>EAGAIN</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>fd</span>.<span style=color:#a6e22e>pd</span>.<span style=color:#a6e22e>pollable</span>() {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// å¦‚æœå½“å‰æ²¡æœ‰å‘ç”ŸæœŸå¾…çš„ I/O äº‹ä»¶ï¼Œé‚£ä¹ˆ waitRead ä¼šé€šè¿‡ park goroutine è®©é€»è¾‘ block åœ¨è¿™é‡Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>fd</span>.<span style=color:#a6e22e>pd</span>.<span style=color:#a6e22e>waitRead</span>(<span style=color:#a6e22e>fd</span>.<span style=color:#a6e22e>isFile</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>ECONNABORTED</span>:
</span></span><span style=display:flex><span>			<span style=color:#75715e>// This means that a socket on the listen
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// queue was closed before we Accept()ed it;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// it&#39;s a silly error, so try again.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>errcall</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol><li>æœåŠ¡ç«¯çš„ netFD åœ¨ <code>listen</code> æ—¶ä¼šåˆ›å»º epoll çš„å®ä¾‹ï¼Œå¹¶å°† listenerFD åŠ å…¥ epoll çš„äº‹ä»¶é˜Ÿåˆ—</li><li>netFD åœ¨ <code>accept</code> æ—¶å°†è¿”å›çš„ connFD ä¹ŸåŠ å…¥ epoll çš„äº‹ä»¶é˜Ÿåˆ—ã€‚</li><li>netFD åœ¨è¯»å†™æ—¶å‡ºç° <code>syscall.EAGAIN</code> é”™è¯¯ï¼Œé€šè¿‡ pollDesc çš„ <code>waitRead</code> æ–¹æ³•å°†å½“å‰çš„ goroutine park ä½ï¼Œç›´åˆ° readyï¼Œä» pollDesc çš„ <code>waitRead</code> ä¸­è¿”å›</li></ol><h4 id=connreadconnwrite><a href=#connreadconnwrite class=h-anchor>ğŸ”—</a>Conn.Read/Conn.Write</h4><blockquote><p>goparkåç­‰å¾…è¢«å”¤é†’</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>fd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>FD</span>) <span style=color:#a6e22e>Read</span>(<span style=color:#a6e22e>p</span> []<span style=color:#66d9ef>byte</span>) (<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// å°è¯•ä»è¯¥ socket è¯»å–æ•°æ®ï¼Œå› ä¸º socket åœ¨è¢« listener accept çš„æ—¶å€™è®¾ç½®æˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// äº†éé˜»å¡ I/Oï¼Œæ‰€ä»¥è¿™é‡ŒåŒæ ·ä¹Ÿæ˜¯ç›´æ¥è¿”å›ï¼Œä¸ç®¡æœ‰æ²¡æœ‰å¯è¯»çš„æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>n</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ignoringEINTRIO</span>(<span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>Read</span>, <span style=color:#a6e22e>fd</span>.<span style=color:#a6e22e>Sysfd</span>, <span style=color:#a6e22e>p</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>n</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// err == syscall.EAGAIN è¡¨ç¤ºå½“å‰æ²¡æœ‰æœŸå¾…çš„ I/O äº‹ä»¶å‘ç”Ÿï¼Œä¹Ÿå°±æ˜¯ socket ä¸å¯è¯»
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>EAGAIN</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>fd</span>.<span style=color:#a6e22e>pd</span>.<span style=color:#a6e22e>pollable</span>() {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// å¦‚æœå½“å‰æ²¡æœ‰å‘ç”ŸæœŸå¾…çš„ I/O äº‹ä»¶ï¼Œé‚£ä¹ˆ waitRead
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#75715e>// ä¼šé€šè¿‡ park goroutine è®©é€»è¾‘ blockåœ¨è¿™é‡Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>fd</span>.<span style=color:#a6e22e>pd</span>.<span style=color:#a6e22e>waitRead</span>(<span style=color:#a6e22e>fd</span>.<span style=color:#a6e22e>isFile</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Write implements io.Writer.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>fd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>FD</span>) <span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>p</span> []<span style=color:#66d9ef>byte</span>) (<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span> <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//syscall.write
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>n</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ignoringEINTRIO</span>(<span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>Write</span>, <span style=color:#a6e22e>fd</span>.<span style=color:#a6e22e>Sysfd</span>, <span style=color:#a6e22e>p</span>[<span style=color:#a6e22e>nn</span>:<span style=color:#a6e22e>max</span>])
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>EAGAIN</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>fd</span>.<span style=color:#a6e22e>pd</span>.<span style=color:#a6e22e>pollable</span>() {
</span></span><span style=display:flex><span>      <span style=color:#75715e>//waitWrite
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>fd</span>.<span style=color:#a6e22e>pd</span>.<span style=color:#a6e22e>waitWrite</span>(<span style=color:#a6e22e>fd</span>.<span style=color:#a6e22e>isFile</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// acceptã€read
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>pd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pollDesc</span>) <span style=color:#a6e22e>waitRead</span>(<span style=color:#a6e22e>isFile</span> <span style=color:#66d9ef>bool</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>pd</span>.<span style=color:#a6e22e>wait</span>(<span style=color:#e6db74>&#39;r&#39;</span>, <span style=color:#a6e22e>isFile</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// write
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>pd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pollDesc</span>) <span style=color:#a6e22e>waitWrite</span>(<span style=color:#a6e22e>isFile</span> <span style=color:#66d9ef>bool</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>pd</span>.<span style=color:#a6e22e>wait</span>(<span style=color:#e6db74>&#39;w&#39;</span>, <span style=color:#a6e22e>isFile</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>pd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pollDesc</span>) <span style=color:#a6e22e>wait</span>(<span style=color:#a6e22e>mode</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>isFile</span> <span style=color:#66d9ef>bool</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pd</span>.<span style=color:#a6e22e>runtimeCtx</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;waiting for unsupported file type&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>res</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>runtime_pollWait</span>(<span style=color:#a6e22e>pd</span>.<span style=color:#a6e22e>runtimeCtx</span>, <span style=color:#a6e22e>mode</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>convertErr</span>(<span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>isFile</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//runtime_pollWait
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>poll_runtime_pollWait</span>(<span style=color:#a6e22e>pd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pollDesc</span>, <span style=color:#a6e22e>mode</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span> <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> !<span style=color:#a6e22e>netpollblock</span>(<span style=color:#a6e22e>pd</span>, int32(<span style=color:#a6e22e>mode</span>), <span style=color:#66d9ef>false</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>errcode</span> = <span style=color:#a6e22e>netpollcheckerr</span>(<span style=color:#a6e22e>pd</span>, int32(<span style=color:#a6e22e>mode</span>))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>errcode</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>pollNoError</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errcode</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>pollNoError</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//netpollblock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>netpollblock</span>(<span style=color:#a6e22e>pd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pollDesc</span>, <span style=color:#a6e22e>mode</span> <span style=color:#66d9ef>int32</span>, <span style=color:#a6e22e>waitio</span> <span style=color:#66d9ef>bool</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span> <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>waitio</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>netpollcheckerr</span>(<span style=color:#a6e22e>pd</span>, <span style=color:#a6e22e>mode</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>//gopark
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>gopark</span>(<span style=color:#a6e22e>netpollblockcommit</span>, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>gpp</span>), <span style=color:#a6e22e>waitReasonIOWait</span>, <span style=color:#a6e22e>traceEvGoBlockNet</span>, <span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>netFDçš„<code>Read</code>æ“ä½œåœ¨ç³»ç»Ÿè°ƒç”¨Readåï¼Œå½“æœ‰<strong>syscall.EAGAIN</strong>é”™è¯¯å‘ç”Ÿæ—¶ï¼Œ<code>WaitRead</code>å°†å½“å‰è¯»è¿™ä¸ªconnFDçš„goroutineç»™<strong>park</strong>ä½ï¼Œç›´åˆ°è¿™ä¸ªconnFDä¸Šçš„è¯»äº‹ä»¶å†æ¬¡å‘ç”Ÿä¸ºæ­¢ï¼Œ<code>waitRead</code>è°ƒç”¨è¿”å›ï¼Œç»§ç»­forå¾ªç¯çš„æ‰§è¡Œã€‚netFDçš„Writeæ–¹æ³•å’ŒReadçš„å®ç°åŸç†æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯åœ¨ç¢°åˆ°EAGAINé”™è¯¯çš„æ—¶å€™å°†å½“å‰goroutineç»™parkä½ç›´åˆ°socketå†æ¬¡å¯å†™ä¸ºæ­¢ã€‚</p><h4 id=netpoll><a href=#netpoll class=h-anchor>ğŸ”—</a>netpoll</h4><p><strong>netpoll</strong> å°±æ˜¯ä»epoll waitå¾—åˆ°æ‰€æœ‰å‘ç”Ÿäº‹ä»¶çš„fdï¼Œå¹¶å°†æ¯ä¸ªfdå¯¹åº”çš„goroutineé€šè¿‡é“¾è¡¨è¿”å›ã€‚è¿™ä¸ªæ“ä½œæ˜¯åœ¨goroutineè°ƒåº¦å™¨ä¸­ä½¿ç”¨çš„ï¼Œç”¨æ¥å°†å› ä¸ºIO waitè€Œé˜»å¡çš„goroutineé‡æ–°è°ƒåº¦ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>netpoll</span>(<span style=color:#a6e22e>block</span> <span style=color:#66d9ef>bool</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>epfd</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>     <span style=color:#f92672>:=</span> int32(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>block</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>waitms</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>events</span> [<span style=color:#ae81ff>128</span>]<span style=color:#a6e22e>epollevent</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>retry</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e>//ç³»ç»Ÿè°ƒç”¨epoll_wait
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>epollwait</span>(<span style=color:#a6e22e>epfd</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>events</span>[<span style=color:#ae81ff>0</span>], int32(len(<span style=color:#a6e22e>events</span>)), <span style=color:#a6e22e>waitms</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span> &lt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>goto</span> <span style=color:#a6e22e>retry</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>gp</span> <span style=color:#a6e22e>guintptr</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> int32(<span style=color:#ae81ff>0</span>); <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>n</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ev</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>events</span>[<span style=color:#a6e22e>i</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>mode</span> <span style=color:#66d9ef>int32</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ev</span>.<span style=color:#a6e22e>events</span><span style=color:#f92672>&amp;</span>(<span style=color:#a6e22e>_EPOLLIN</span>|<span style=color:#a6e22e>_EPOLLRDHUP</span>|<span style=color:#a6e22e>_EPOLLHUP</span>|<span style=color:#a6e22e>_EPOLLERR</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>mode</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#39;r&#39;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ev</span>.<span style=color:#a6e22e>events</span><span style=color:#f92672>&amp;</span>(<span style=color:#a6e22e>_EPOLLOUT</span>|<span style=color:#a6e22e>_EPOLLHUP</span>|<span style=color:#a6e22e>_EPOLLERR</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>mode</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#39;w&#39;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mode</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>pd</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>*</span>(<span style=color:#f92672>**</span><span style=color:#a6e22e>pollDesc</span>)(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ev</span>.<span style=color:#a6e22e>data</span>))
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>netpollready</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>pd</span>, <span style=color:#a6e22e>mode</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>block</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>gp</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>goto</span> <span style=color:#a6e22e>retry</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>ptr</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=è°ƒç”¨æ—¶æœº><a href=#è°ƒç”¨æ—¶æœº class=h-anchor>ğŸ”—</a>è°ƒç”¨æ—¶æœº</h5><ul><li><p>runtime.schedule()ä¸­çš„runtime.findrunable()</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>findrunnable</span>() (<span style=color:#a6e22e>gp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>, <span style=color:#a6e22e>inheritTime</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//// Poll network.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>netpollinited</span>() <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>netpollWaiters</span>) &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Load64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lastpoll</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>list</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>netpoll</span>(<span style=color:#ae81ff>0</span>); !<span style=color:#a6e22e>list</span>.<span style=color:#a6e22e>empty</span>() { <span style=color:#75715e>// non-blocking
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>         <span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>list</span>.<span style=color:#a6e22e>pop</span>()
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>injectglist</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>list</span>)
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>casgstatus</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>_Gwaiting</span>, <span style=color:#a6e22e>_Grunnable</span>)
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>enabled</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>traceGoUnpark</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>gp</span>, <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p>sysmonç›‘æ§çº¿ç¨‹ä¸­</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// poll network if not polled for more than 10ms
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>netpollinited</span>() <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>lastpoll</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>lastpoll</span><span style=color:#f92672>+</span><span style=color:#ae81ff>10</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1000</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1000</span> &lt; <span style=color:#a6e22e>now</span> {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Cas64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lastpoll</span>, uint64(<span style=color:#a6e22e>lastpoll</span>), uint64(<span style=color:#a6e22e>now</span>))
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>list</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>netpoll</span>(<span style=color:#ae81ff>0</span>) <span style=color:#75715e>// non-blocking - returns list of goroutines
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>incidlelocked</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>injectglist</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>list</span>)
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>incidlelocked</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ul><h2 id=ç³»ç»Ÿè°ƒç”¨><a href=#ç³»ç»Ÿè°ƒç”¨ class=h-anchor>ğŸ”—</a>ç³»ç»Ÿè°ƒç”¨</h2><h4 id=åˆ†çº§ä¿æŠ¤åŸŸ-protection-ring><a href=#åˆ†çº§ä¿æŠ¤åŸŸ-protection-ring class=h-anchor>ğŸ”—</a>åˆ†çº§ä¿æŠ¤åŸŸ (Protection ring)</h4><p>In x86 protected mode, the CPU is always in one of 4 rings. The Linux kernel only uses 0 and 3:</p><ul><li>0 for kernel</li><li>3 for users</li></ul><p>This is the most hard and fast definition of kernel vs userland.</p><p>å†…æ ¸å¯ä»¥è®¿é—® Ring0ï¼Œå†…æ ¸æ˜¯å¤§å¤šæ•°æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå¯ä»¥è®¿é—®æ‰€æœ‰å†…å®¹ã€‚è¿™é‡Œè¿è¡Œçš„ä»£ç æ˜¯åœ¨å†…æ ¸æ¨¡å¼ä¸‹è¿è¡Œçš„ã€‚åœ¨å†…æ ¸æ¨¡å¼ä¸‹è¿è¡Œçš„è¿›ç¨‹ä¼šå½±å“æ•´ä¸ªç³»ç»Ÿï¼›å¦‚æœæ­¤å¤„å‡ºç°ä»»ä½•æ•…éšœï¼Œåˆ™å¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿå…³é—­ã€‚Ring0 è¿™ä¸ªç¯å¯ä»¥ç›´æ¥è®¿é—® CPU å’Œç³»ç»Ÿå†…å­˜ï¼Œå› æ­¤ä»»ä½•éœ€è¦ä½¿ç”¨å…¶ä¸­ä»»ä½•ä¸€ä¸ªçš„æŒ‡ä»¤éƒ½å°†åœ¨æ­¤å¤„æ‰§è¡Œã€‚</p><p>Ring3 æ˜¯ç‰¹æƒæœ€å°‘çš„ç¯ï¼Œè¿è¡Œåœ¨ç”¨æˆ·æ¨¡å¼ä¸‹çš„ç”¨æˆ·è¿›ç¨‹å¯ä»¥è®¿é—®è¯¥ç¯ã€‚è¿™æ˜¯æ‚¨è®¡ç®—æœºä¸Šè¿è¡Œçš„å¤§å¤šæ•°åº”ç”¨ç¨‹åºæ‰€åœ¨çš„ä½ç½®ã€‚è¯¥ç¯æ— æ³•ç›´æ¥è®¿é—® CPU æˆ–å†…å­˜ï¼Œå› æ­¤å¿…é¡»å°†æ¶‰åŠè¿™äº›çš„ä»»ä½•æŒ‡ä»¤ä¼ é€’ç»™Ring0</p><h4 id=ç³»ç»Ÿè°ƒç”¨ä¸Šä¸‹æ–‡åˆ‡æ¢><a href=#ç³»ç»Ÿè°ƒç”¨ä¸Šä¸‹æ–‡åˆ‡æ¢ class=h-anchor>ğŸ”—</a>ç³»ç»Ÿè°ƒç”¨ä¸Šä¸‹æ–‡åˆ‡æ¢</h4><p>Ring0&lt;&ndash;>Ring3</p><h4 id=å¼‚æ­¥ç³»ç»Ÿè°ƒç”¨ä¸ä¼šé˜»å¡m><a href=#å¼‚æ­¥ç³»ç»Ÿè°ƒç”¨ä¸ä¼šé˜»å¡m class=h-anchor>ğŸ”—</a>å¼‚æ­¥ç³»ç»Ÿè°ƒç”¨(ä¸ä¼šé˜»å¡M)</h4><p>ç½‘ç»œç›¸å…³ç³»ç»Ÿè°ƒç”¨</p><p><img src=https://s2.loli.net/2022/07/23/pWPxHFAvtmki2bC.png alt></p><p><img src=https://s2.loli.net/2022/07/23/FdYLtG9ojS2Bf34.png alt></p><p><img src=https://s2.loli.net/2022/07/23/S4GAmIb9R5Y1jfl.png alt></p><h4 id=åŒæ­¥ç³»ç»Ÿè°ƒç”¨ä¼šé˜»å¡m><a href=#åŒæ­¥ç³»ç»Ÿè°ƒç”¨ä¼šé˜»å¡m class=h-anchor>ğŸ”—</a>åŒæ­¥ç³»ç»Ÿè°ƒç”¨(ä¼šé˜»å¡M)</h4><p>åŠ¨æ€æ¼”ç¤ºï¼šhttps://www.figma.com/proto/ounOboEYjlzBwcOhPgE2Z5/syscall?page-id=11%3A2&node-id=17%3A219&viewport=35%2C425%2C0.3724002540111542&scaling=contain</p><p>å¦‚æ“ä½œæ–‡ä»¶ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ä¸ºåŒæ­¥ç³»ç»Ÿè°ƒç”¨ã€ä½¿ç”¨CGOçš„ç›¸å…³åœºæ™¯</p><blockquote><p>Windowsæ“ä½œç³»ç»Ÿç¡®å®å…·æœ‰å¼‚æ­¥è¿›è¡ŒåŸºäºæ–‡ä»¶çš„ç³»ç»Ÿè°ƒç”¨çš„èƒ½åŠ›ã€‚ä»æŠ€æœ¯ä¸Šè®²ï¼Œåœ¨Windowsä¸Šè¿è¡Œæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ç½‘ç»œè½®è¯¢</p></blockquote><p><img src=https://s2.loli.net/2022/07/23/nsMe2NhrykJAODg.png alt></p><p><img src=https://s2.loli.net/2022/07/23/eZLpMYtK61Fw2XW.png alt></p><p><img src=https://s2.loli.net/2022/07/23/zNCwbfPaenpDLW8.png alt></p><h2 id=å­˜åœ¨çš„é—®é¢˜><a href=#å­˜åœ¨çš„é—®é¢˜ class=h-anchor>ğŸ”—</a>å­˜åœ¨çš„é—®é¢˜</h2><p>goroutine è™½ç„¶éå¸¸è½»é‡ï¼Œå®ƒçš„è‡ªå®šä¹‰æ ˆå†…å­˜åˆå§‹å€¼ä»…ä¸º 2KBï¼Œåé¢æŒ‰éœ€æ‰©å®¹ï¼›æµ·é‡è¿æ¥çš„ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œ <code>goroutine-per-connection</code> ï¼Œæ­¤æ—¶ goroutine æ•°é‡ä»¥åŠæ¶ˆè€—çš„èµ„æºå°±ä¼šå‘ˆçº¿æ€§è¶‹åŠ¿æš´æ¶¨ï¼Œè™½ç„¶ Go scheduler å†…éƒ¨åšäº† g çš„ç¼“å­˜é“¾è¡¨ï¼Œå¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šç¼“è§£é«˜é¢‘åˆ›å»ºé”€æ¯ goroutine çš„å‹åŠ›ï¼Œä½†æ˜¯å¯¹äºç¬æ—¶æ€§æš´æ¶¨çš„é•¿è¿æ¥åœºæ™¯å°±æ— èƒ½ä¸ºåŠ›äº†ï¼Œ<strong>å¤§é‡çš„ goroutines ä¼šè¢«ä¸æ–­åˆ›å»ºå‡ºæ¥</strong>ï¼Œä»è€Œå¯¹ Go runtime scheduler é€ æˆæå¤§çš„è°ƒåº¦å‹åŠ›å’Œä¾µå ç³»ç»Ÿèµ„æºï¼Œç„¶åèµ„æºè¢«ä¾µå åˆåè¿‡æ¥å½±å“ Go scheduler çš„è°ƒåº¦ï¼Œè¿›è€Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</p><h1 id=reactors>Reactors</h1><h2 id=ä¸¤ç§æ¨¡å‹><a href=#ä¸¤ç§æ¨¡å‹ class=h-anchor>ğŸ”—</a>ä¸¤ç§æ¨¡å‹</h2><h3 id=ä¸»ä»å¤š-reactors><a href=#ä¸»ä»å¤š-reactors class=h-anchor>ğŸ”—</a>ä¸»ä»å¤š Reactors</h3><p><img src=https://s2.loli.net/2022/07/23/Yha1LNXTDJjfCwP.png alt></p><p>æ—¶åºå›¾ï¼š</p><p><img src=https://s2.loli.net/2022/07/23/BgyhoRefLz9XP8W.png alt></p><h3 id=ä¸»ä»å¤š-reactors--çº¿ç¨‹go-ç¨‹æ± ><a href=#ä¸»ä»å¤š-reactors--çº¿ç¨‹go-ç¨‹æ±  class=h-anchor>ğŸ”—</a>ä¸»ä»å¤š Reactors + çº¿ç¨‹/Go ç¨‹æ± </h3><p>å¯ä»¥é¿å…ä¸šåŠ¡ä»£ç é˜»å¡event-loop</p><p><img src=https://s2.loli.net/2022/07/23/FHV6uLgSIR2Eo9k.png alt></p><p>æ—¶åºå›¾ï¼š</p><p><img src=https://s2.loli.net/2022/07/23/A5hieR3fCLUbVNx.png alt></p><p><code>gnet</code> å†…éƒ¨é›†æˆäº† <code>ants</code> ä»¥åŠæä¾›äº† <code>pool.goroutine.Default()</code> æ–¹æ³•æ¥åˆå§‹åŒ–ä¸€ä¸ª <code>ants</code> goroutine æ± ï¼Œç„¶åä½ å¯ä»¥æŠŠ <code>EventHandler.React</code> ä¸­é˜»å¡çš„ä¸šåŠ¡é€»è¾‘æäº¤åˆ° goroutine æ± é‡Œæ‰§è¡Œï¼Œæœ€ååœ¨ goroutine æ± é‡Œçš„ä»£ç è°ƒç”¨ <code>gnet.Conn.AsyncWrite([]byte)</code> æ–¹æ³•æŠŠå¤„ç†å®Œé˜»å¡é€»è¾‘ä¹‹åå¾—åˆ°çš„è¾“å‡ºæ•°æ®å¼‚æ­¥å†™å›å®¢æˆ·ç«¯ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…é˜»å¡ event-loop çº¿ç¨‹ã€‚</p><h2 id=reactorå·¥ä½œæµç¨‹><a href=#reactorå·¥ä½œæµç¨‹ class=h-anchor>ğŸ”—</a>reactorå·¥ä½œæµç¨‹</h2><ul><li>Server ç«¯å®Œæˆåœ¨ <code>bind&listen</code> ä¹‹åï¼Œå°† listenfd æ³¨å†Œåˆ° epollfd ä¸­ï¼Œæœ€åè¿›å…¥ event-loop äº‹ä»¶å¾ªç¯ã€‚å¾ªç¯è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ <code>select/poll/epoll_wait</code> é˜»å¡ç­‰å¾…ï¼Œè‹¥æœ‰åœ¨ listenfd ä¸Šçš„æ–°è¿æ¥äº‹ä»¶åˆ™è§£é™¤é˜»å¡è¿”å›ï¼Œå¹¶è°ƒç”¨ <code>socket.accept</code> æ¥æ”¶æ–°è¿æ¥ connfdï¼Œå¹¶å°† connfd åŠ å…¥åˆ° epollfd çš„ I/O å¤ç”¨ï¼ˆç›‘å¬ï¼‰é˜Ÿåˆ—ã€‚</li><li>å½“ connfd ä¸Šå‘ç”Ÿå¯è¯»/å¯å†™äº‹ä»¶ä¹Ÿä¼šè§£é™¤ <code>select/poll/epoll_wait</code> çš„é˜»å¡ç­‰å¾…ï¼Œç„¶åè¿›è¡Œ I/O è¯»å†™æ“ä½œï¼Œè¿™é‡Œè¯»å†™ I/O éƒ½æ˜¯éé˜»å¡ I/Oï¼Œè¿™æ ·æ‰ä¸ä¼šé˜»å¡ event-loop çš„ä¸‹ä¸€ä¸ªå¾ªç¯ã€‚ç„¶è€Œï¼Œè¿™æ ·å®¹æ˜“å‰²è£‚ä¸šåŠ¡é€»è¾‘ï¼Œä¸æ˜“ç†è§£å’Œç»´æŠ¤ã€‚</li><li>è°ƒç”¨ <code>read</code> è¯»å–æ•°æ®ä¹‹åè¿›è¡Œè§£ç å¹¶æ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…å·¥ä½œçº¿ç¨‹å¤„ç†ã€‚</li><li>å·¥ä½œçº¿ç¨‹å¤„ç†å®Œæ•°æ®ä¹‹åï¼Œè¿”å›åˆ° event-loop çº¿ç¨‹ï¼Œç”±è¿™ä¸ªçº¿ç¨‹è´Ÿè´£è°ƒç”¨ <code>write</code> æŠŠæ•°æ®å†™å› clientã€‚</li></ul><h2 id=main-reactor><a href=#main-reactor class=h-anchor>ğŸ”—</a>main reactor</h2><blockquote><p>å¯¹åº”ä¸€ä¸ªgoroutineï¼Œevent-loopäº‹ä»¶å¾ªç¯</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>el</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>eventloop</span>) <span style=color:#a6e22e>activateMainReactor</span>(<span style=color:#a6e22e>lockOSThread</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>lockOSThread</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>LockOSThread</span>()
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>UnlockOSThread</span>()
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>engine</span>.<span style=color:#a6e22e>signalShutdown</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>poller</span>.<span style=color:#a6e22e>Polling</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>fd</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>filter</span> <span style=color:#66d9ef>int16</span>) <span style=color:#66d9ef>error</span> { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>engine</span>.<span style=color:#a6e22e>accept</span>(<span style=color:#a6e22e>fd</span>, <span style=color:#a6e22e>filter</span>) })
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ErrEngineShutdown</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>engine</span>.<span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>Logger</span>.<span style=color:#a6e22e>Debugf</span>(<span style=color:#e6db74>&#34;main reactor is exiting in terms of the demand from user, %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>   } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>engine</span>.<span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>Logger</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;main reactor is exiting due to error: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=sub-reactor><a href=#sub-reactor class=h-anchor>ğŸ”—</a>sub reactor</h2><blockquote><p>å¯¹åº”å¤šä¸ªgoroutineï¼ˆé€»è¾‘æ ¸å¿ƒæ•°ï¼‰</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>el</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>eventloop</span>) <span style=color:#a6e22e>activateSubReactor</span>(<span style=color:#a6e22e>lockOSThread</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>lockOSThread</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>LockOSThread</span>()
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>UnlockOSThread</span>()
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>closeAllSockets</span>()
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>engine</span>.<span style=color:#a6e22e>signalShutdown</span>()
</span></span><span style=display:flex><span>   }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>poller</span>.<span style=color:#a6e22e>Polling</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>fd</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>filter</span> <span style=color:#66d9ef>int16</span>) (<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>ack</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>connections</span>[<span style=color:#a6e22e>fd</span>]; <span style=color:#a6e22e>ack</span> {
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>filter</span> {
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>netpoll</span>.<span style=color:#a6e22e>EVFilterSock</span>:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>closeConn</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>ECONNRESET</span>)
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>netpoll</span>.<span style=color:#a6e22e>EVFilterWrite</span>: <span style=color:#75715e>//I/Oå¯å†™äº‹ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>outboundBuffer</span>.<span style=color:#a6e22e>IsEmpty</span>() { 
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>write</span>(<span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>netpoll</span>.<span style=color:#a6e22e>EVFilterRead</span>: <span style=color:#75715e>//I/Oå¯è¯»äº‹ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>read</span>(<span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>   })
</span></span><span style=display:flex><span>   <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Polling blocks the current goroutine, waiting for network-events.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Poller</span>) <span style=color:#a6e22e>Polling</span>(<span style=color:#a6e22e>callback</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>fd</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>ev</span> <span style=color:#66d9ef>uint32</span>) <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span> <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>//ç³»ç»Ÿè°ƒç”¨epoll_wait
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>n</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>EpollWait</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>fd</span>, <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>events</span>, <span style=color:#a6e22e>msec</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> (<span style=color:#a6e22e>n</span> &lt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>EINTR</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>msec</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>Gosched</span>()
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>logging</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error occurs in epoll: %v&#34;</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>NewSyscallError</span>(<span style=color:#e6db74>&#34;epoll_wait&#34;</span>, <span style=color:#a6e22e>err</span>))
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>msec</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>el</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>eventloop</span>) <span style=color:#a6e22e>read</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>conn</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>n</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>Read</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>fd</span>, <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>buffer</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>EAGAIN</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>closeConn</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>NewSyscallError</span>(<span style=color:#e6db74>&#34;read&#34;</span>, <span style=color:#a6e22e>err</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>closeConn</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>NewSyscallError</span>(<span style=color:#e6db74>&#34;read&#34;</span>, <span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>ECONNRESET</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>buffer</span> = <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>buffer</span>[:<span style=color:#a6e22e>n</span>]
</span></span><span style=display:flex><span>  <span style=color:#75715e>//ä¸šåŠ¡å¤„ç†ä»£ç 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>action</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>eventHandler</span>.<span style=color:#a6e22e>OnTraffic</span>(<span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>action</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>None</span>:
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Close</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>closeConn</span>(<span style=color:#a6e22e>c</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Shutdown</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>gerrors</span>.<span style=color:#a6e22e>ErrEngineShutdown</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>inboundBuffer</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>buffer</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=ç›¸å…³é—®é¢˜>ç›¸å…³é—®é¢˜</h1><h3 id=ä¸ºä»€ä¹ˆéœ€è¦ç¼“å­˜åŒºç”¨æˆ·ç©ºé—´><a href=#ä¸ºä»€ä¹ˆéœ€è¦ç¼“å­˜åŒºç”¨æˆ·ç©ºé—´ class=h-anchor>ğŸ”—</a>ä¸ºä»€ä¹ˆéœ€è¦ç¼“å­˜åŒº(ç”¨æˆ·ç©ºé—´)</h3><p><strong>æ•°æ®â€”â€”æµç¼“å­˜åŒºï¼ˆç”¨æˆ·æ€ï¼‰â€”â€” å†…æ ¸ç¼“å­˜åŒºï¼ˆå†…æ ¸æ€ï¼‰â€”â€”ç£ç›˜</strong></p><p>å‡å°‘è°ƒç”¨readå’Œwriteçš„æ¬¡æ•°(<strong>å‡å°‘ç”¨æˆ·æ€å’Œå†…æ ¸æ€æ¥å›åˆ‡æ¢</strong>)ï¼Œæé«˜äº†ç£ç›˜çš„I/Oæ•ˆç‡</p><h3 id=ç”¨æˆ·æ€å’Œå†…æ ¸æ€åˆ‡æ¢çš„æ—¶æœº><a href=#ç”¨æˆ·æ€å’Œå†…æ ¸æ€åˆ‡æ¢çš„æ—¶æœº class=h-anchor>ğŸ”—</a>ç”¨æˆ·æ€å’Œå†…æ ¸æ€åˆ‡æ¢çš„æ—¶æœº</h3><p>1ï¼‰<strong>ç³»ç»Ÿè°ƒç”¨</strong>ã€‚</p><p>2ï¼‰å¼‚å¸¸äº‹ä»¶ï¼š å½“CPUæ­£åœ¨æ‰§è¡Œè¿è¡Œåœ¨ç”¨æˆ·æ€çš„ç¨‹åºæ—¶ï¼Œçªç„¶å‘ç”ŸæŸäº›é¢„å…ˆä¸å¯çŸ¥çš„å¼‚å¸¸äº‹ä»¶ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šè§¦å‘ä»å½“å‰ç”¨æˆ·æ€æ‰§è¡Œçš„è¿›ç¨‹è½¬å‘å†…æ ¸æ€æ‰§è¡Œç›¸å…³çš„å¼‚å¸¸äº‹ä»¶ï¼Œå…¸å‹çš„å¦‚<strong>ç¼ºé¡µå¼‚å¸¸</strong>ã€‚</p><p>3ï¼‰å¤–å›´è®¾å¤‡çš„<strong>ä¸­æ–­</strong>ï¼šå½“å¤–å›´è®¾å¤‡å®Œæˆç”¨æˆ·çš„è¯·æ±‚æ“ä½œåï¼Œä¼šåƒCPUå‘å‡ºä¸­æ–­ä¿¡å·ï¼Œæ­¤æ—¶ï¼ŒCPUå°±ä¼šæš‚åœæ‰§è¡Œä¸‹ä¸€æ¡å³å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œè½¬è€Œå»æ‰§è¡Œä¸­æ–­ä¿¡å·å¯¹åº”çš„å¤„ç†ç¨‹åºï¼Œå¦‚æœå…ˆå‰æ‰§è¡Œçš„æŒ‡ä»¤æ˜¯åœ¨ç”¨æˆ·æ€ä¸‹ï¼Œåˆ™è‡ªç„¶å°±å‘ç”Ÿä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„è½¬æ¢ã€‚</p><h3 id=ç”¨æˆ·æ€å’Œå†…æ ¸æ€åˆ‡æ¢çš„ä»£ä»·><a href=#ç”¨æˆ·æ€å’Œå†…æ ¸æ€åˆ‡æ¢çš„ä»£ä»· class=h-anchor>ğŸ”—</a>ç”¨æˆ·æ€å’Œå†…æ ¸æ€åˆ‡æ¢çš„ä»£ä»·</h3><p>å½“ç¨‹åºä¸­æœ‰ç³»ç»Ÿè°ƒç”¨è¯­å¥ï¼Œç¨‹åºæ‰§è¡Œåˆ°ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œé¦–å…ˆä½¿ç”¨ç±»ä¼¼<code>int 80H</code>çš„<strong>è½¯ä¸­æ–­æŒ‡ä»¤</strong>ï¼Œä¿å­˜ç°åœºï¼Œå»çš„ç³»ç»Ÿè°ƒç”¨å·ï¼Œåœ¨å†…æ ¸æ€æ‰§è¡Œï¼Œç„¶åæ¢å¤ç°åœºï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½ä¼šæœ‰ä¸¤ä¸ªæ ˆï¼Œä¸€ä¸ªå†…æ ¸æ€æ ˆå’Œä¸€ä¸ªç”¨æˆ·æ€æ ˆã€‚å½“æ‰§è¡Œintä¸­æ–­æ‰§è¡Œæ—¶å°±ä¼šç”±ç”¨æˆ·æ€ï¼Œæ ˆè½¬å‘å†…æ ¸æ ˆã€‚ç³»ç»Ÿè°ƒç”¨æ—¶éœ€è¦è¿›è¡Œæ ˆçš„åˆ‡æ¢ã€‚è€Œä¸”å†…æ ¸ä»£ç å¯¹ç”¨æˆ·ä¸ä¿¡ä»»ï¼Œéœ€è¦è¿›è¡Œé¢å¤–çš„æ£€æŸ¥ã€‚ç³»ç»Ÿè°ƒç”¨çš„è¿”å›è¿‡ç¨‹æœ‰å¾ˆå¤šé¢å¤–å·¥ä½œï¼Œæ¯”å¦‚æ£€æŸ¥æ˜¯å¦éœ€è¦è°ƒåº¦ç­‰ã€‚</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=/posts/go%E4%B9%8B%E5%90%8C%E6%AD%A5%E5%8E%9F%E8%AF%AD%E4%B8%8E%E9%94%81/><span class=button__text>goä¹‹åŒæ­¥åŸè¯­</span>
<span class=button__icon>â†’</span></a></span></div></div><script>localStorage.getItem("theme")=="dark"&&document.documentElement.classList.add("dark-mode")</script><div id=light-mode><script src=https://utteranc.es/client.js repo=gongqij/blog_comment issue-term=title theme=github-light crossorigin=anonymous async></script></div><div id=dark-mode><script src=https://utteranc.es/client.js repo=gongqij/blog_comment issue-term=title theme=github-dark crossorigin=anonymous async></script></div><script>var root=document.getElementsByClassName("dark-mode");root.length>0?(document.getElementById("light-mode").style.display="none",document.getElementById("dark-mode").style.display="block"):(document.getElementById("light-mode").style.display="block",document.getElementById("dark-mode").style.display="none")</script></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__text>K:)eep</span></a><div class=copyright><span>Â© 2022 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span></div></div></footer><script src=/assets/main.js></script>
<script src=/assets/prism.js></script></div></body></html>